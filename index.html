<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oz Tank - Service POD Manager v11.8</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding-bottom: 80px;
        }
        
        /* Login Screen Styles */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        #loginScreen.hidden {
            display: none;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .login-logo {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .login-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .login-subtitle {
            color: #6b7280;
            margin-bottom: 32px;
        }
        
        .login-error {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }
        
        .login-error.show {
            display: block;
        }
        
        #googleSignInBtn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #googleSignInBtn:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }
        
        #googleSignInBtn img {
            width: 20px;
            height: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }
        
        .user-info img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }
        
        .logout-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.8);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 8px;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .header {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            color: white;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        /* Make header container for user info positioning */
        #homeView > .header {
            position: relative;
        }

        .header-logo {
            height: 40px;
            margin-bottom: 4px;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .header h1 {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .btn {
            background: #374151;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
            font-weight: 500;
        }

        .btn:active {
            background: #1f2937;
        }

        .btn-secondary {
            background: #64748b;
        }

        .btn-secondary:active {
            background: #475569;
        }

        .btn-success {
            background: #16a34a;
        }

        .btn-success:active {
            background: #15803d;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:active {
            background: #b91c1c;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .customer-list {
            list-style: none;
        }

        .customer-item {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .customer-item.dragging {
            opacity: 0.5;
        }

        .customer-item.drag-over {
            border-top: 3px solid #374151;
        }

        .drag-handle {
            font-size: 20px;
            color: #9ca3af;
            cursor: grab;
            margin-right: 12px;
            padding: 4px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .customer-item.completed {
            background: #f0fdf4;
            border-left: 4px solid #16a34a;
        }

        .customer-item.skipped {
            background: #f9fafb;
            border-left: 4px solid #9ca3af;
            opacity: 0.7;
        }

        .customer-item.skipped .customer-name {
            text-decoration: line-through;
            color: #9ca3af;
        }

        .customer-item.skipped .customer-address,
        .customer-item.skipped .customer-phone {
            text-decoration: line-through;
            color: #d1d5db;
        }

        .skip-reason-badge {
            background: #fee2e2;
            color: #991b1b;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .skip-btn {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .skip-btn:hover {
            background: #e5e7eb;
        }

        .skip-btn.active {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .schedule-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .schedule-badge.off-month {
            background: #fef3c7;
            color: #92400e;
        }

        .off-month-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 13px;
            color: #92400e;
        }

        .month-checkbox {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: #f3f4f6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .month-checkbox:has(input:checked) {
            background: #dbeafe;
            color: #1e40af;
        }

        .month-checkbox input {
            margin: 0;
        }

        .customer-info {
            flex: 1;
        }

        .customer-name {
            font-weight: 600;
            font-size: 16px;
            color: #111827;
        }

        .customer-address {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }

        .customer-phone {
            font-size: 14px;
            color: #374151;
            margin-top: 4px;
        }

        .customer-notes {
            font-size: 13px;
            color: #f59e0b;
            font-style: italic;
            margin-top: 4px;
        }

        .timestamp {
            font-size: 12px;
            color: #9ca3af;
            font-style: italic;
            margin-top: 4px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 8px;
        }

        .status-badge.completed {
            background: #16a34a;
            color: white;
        }

        .status-badge.pending {
            background: #fbbf24;
            color: #78350f;
        }

        .signature-pad {
            border: 2px solid #d1d5db;
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none;
            background: white;
        }

        .signature-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .photo-preview {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
        }

        .radio-group {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            width: auto;
        }

        .product-line {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }

        .product-line select {
            flex: 1;
        }

        .product-line input[type="number"] {
            width: 80px;
        }

        .product-line button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .product-line .product-confirm-btn {
            background: #16a34a;
            color: white;
        }

        .product-line button:last-child {
            background: #dc2626;
            color: white;
        }

        .add-product-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 8px;
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 8px;
            margin-right: 8px;
        }

        .header-content {
            display: flex;
            align-items: center;
        }

        .run-day-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .run-day-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .run-day-card:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .run-day-card h3 {
            color: #374151;
            margin-bottom: 8px;
        }

        .run-day-card p {
            color: #6b7280;
            font-size: 14px;
        }

        .run-day-card .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: #16a34a;
            transition: width 0.3s ease;
        }

        .run-day-card .completion-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #16a34a;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .run-day-card.completed {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #16a34a;
        }

        .run-day-card.completed h3 {
            color: #16a34a;
        }

        .admin-section {
            margin-bottom: 24px;
        }

        .admin-section h2 {
            color: #111827;
            margin-bottom: 16px;
            font-size: 18px;
        }

        .customer-admin-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .customer-admin-info {
            flex: 1;
        }

        .customer-admin-info strong {
            display: block;
            color: #111827;
        }

        .customer-admin-info small {
            color: #6b7280;
        }

        .delete-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: #e5e7eb;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .tab.active {
            background: #374151;
            color: white;
        }

        .pod-preview {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .pod-header {
            border-bottom: 2px solid #374151;
            padding-bottom: 12px;
            margin-bottom: 16px;
        }

        .pod-section {
            margin-bottom: 16px;
        }

        .pod-section h3 {
            color: #374151;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .pod-field {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .pod-field strong {
            color: #374151;
        }

        .pod-field span {
            color: #6b7280;
        }

        .signature-image {
            max-width: 200px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            margin-top: 8px;
        }

        .photo-image {
            max-width: 300px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #16a34a;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: slideDown 0.3s ease;
        }

        .toast.error {
            background: #dc2626;
        }

        .toast.warning {
            background: #f59e0b;
        }

        /* Customer Search Modal */
        .search-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }

        .search-modal-overlay.active {
            display: flex;
        }

        .search-modal {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            margin-top: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-height: calc(100vh - 80px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .search-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-modal-header h2 {
            margin: 0;
            font-size: 18px;
        }

        .search-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .search-modal-body {
            padding: 16px 20px;
            overflow-y: auto;
            flex: 1;
        }

        .search-input-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 14px 16px 14px 44px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }

        .search-input:focus {
            border-color: #374151;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 18px;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f3f4f6;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-name {
            font-weight: 600;
            color: #111827;
        }

        .search-result-meta {
            font-size: 13px;
            color: #6b7280;
            margin-top: 2px;
        }

        .search-result-carbsolve {
            display: inline-block;
            background: #f3f4f6;
            color: #111827;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 4px;
        }

        .search-hint {
            text-align: center;
            color: #9ca3af;
            padding: 20px;
            font-size: 14px;
        }

        .search-divider {
            display: flex;
            align-items: center;
            margin: 16px 0;
            color: #9ca3af;
            font-size: 14px;
        }

        .search-divider::before,
        .search-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e5e7eb;
        }

        .search-divider::before {
            margin-right: 12px;
        }

        .search-divider::after {
            margin-left: 12px;
        }

        .freetext-section {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
        }

        .freetext-section label {
            font-weight: 500;
            margin-bottom: 8px;
            display: block;
        }

        .freetext-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 12px;
        }

        /* Customer info badges */
        .customer-carbsolve {
            display: inline-block;
            background: #f3f4f6;
            color: #111827;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 6px;
        }

        .customer-waste {
            display: inline-block;
            background: #fef3c7;
            color: #92400e;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 6px;
        }

        .customer-special-instructions {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            padding: 8px 12px;
            margin-top: 8px;
            border-radius: 0 6px 6px 0;
            font-size: 13px;
            color: #92400e;
        }

        .customer-access-code {
            display: inline-block;
            background: #f3e8ff;
            color: #7c3aed;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        /* Product categories */
        .product-category-header {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            margin: 16px 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid #e5e7eb;
        }

        .product-category-header:first-child {
            margin-top: 0;
        }

        /* Ad-hoc service button */
        .btn-adhoc {
            background: #ea580c;
        }

        .btn-adhoc:active {
            background: #c2410c;
        }

        .add-service-fab {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #ea580c;
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.4);
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-service-fab:active {
            background: #c2410c;
            transform: scale(0.95);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .calendar-container {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .calendar-container iframe {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 6px;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #374151;
            background: #eff6ff;
        }

        .upload-area.dragover {
            border-color: #374151;
            background: #f3f4f6;
        }

        .upload-icon {
            font-size: 48px;
            color: #9ca3af;
            margin-bottom: 12px;
        }

        .file-input {
            display: none;
        }

        .import-status {
            margin-top: 16px;
            padding: 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .import-status.success {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #16a34a;
        }

        .import-status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #dc2626;
        }

        /* Worker Selector Styles */
        .worker-selector-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .worker-select {
            padding: 10px 16px;
            font-size: 16px;
            border: 2px solid #374151;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-weight: 500;
            min-width: 180px;
            cursor: pointer;
        }

        .worker-select:focus {
            outline: none;
            border-color: #16a34a;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }

        .worker-day-count {
            text-align: center;
            padding: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #6b7280;
            background: #f0fdf4;
            border-radius: 6px;
            border: 1px solid #bbf7d0;
        }

        .worker-day-count.all-workers {
            background: #f8fafc;
            border-color: #e2e8f0;
        }

        .other-workers-section {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 2px dashed #e2e8f0;
        }

        .other-workers-section h4 {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 12px;
            text-align: center;
        }

        /* Month Selector Styles */
        .month-selector-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 16px;
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .month-selector-left {
            /* Empty spacer on left */
        }
        
        .month-selector-center {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .month-selector-right {
            display: flex;
            justify-content: flex-end;
        }

        .month-nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .month-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .month-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .month-today-btn {
            background: #16a34a;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .month-today-btn:hover {
            background: #15803d;
        }

        .month-display {
            text-align: center;
            min-width: 160px;
        }

        .month-display .month-name {
            color: white;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .month-display .month-year {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .month-current-badge {
            display: inline-block;
            background: #16a34a;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .month-historical-badge {
            display: inline-block;
            background: #f59e0b;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .month-future-badge {
            display: inline-block;
            background: #6366f1;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .historical-notice {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 14px;
        }

        .historical-notice strong {
            display: block;
            margin-bottom: 4px;
        }

        .future-notice {
            background: #e0e7ff;
            border: 1px solid #6366f1;
            color: #3730a3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 14px;
        }

        /* Admin Calendar Grid Styles */
        .admin-calendar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 2px;
            background: #e5e7eb;
        }

        .calendar-day {
            background: white;
            min-height: 200px;
            padding: 12px;
            position: relative;
        }

        .calendar-day.other-month {
            background: #f9fafb;
        }

        .calendar-day.today {
            background: #eff6ff;
            box-shadow: inset 0 0 0 3px #3b82f6;
        }

        .calendar-day-number {
            font-size: 14px;
            font-weight: 700;
            color: #374151;
            padding: 6px 8px;
            margin-bottom: 8px;
        }

        .calendar-day.other-month .calendar-day-number {
            color: #9ca3af;
        }

        .calendar-day.today .calendar-day-number {
            background: #3b82f6;
            color: white;
            border-radius: 6px;
            display: inline-block;
        }

        .calendar-service-days {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 4px;
        }

        .calendar-service-day {
            font-size: 13px;
            font-weight: 500;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            border-left: 4px solid transparent;
        }

        .calendar-service-day:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        /* Employee color coding - distinct colors */
        .calendar-service-day.employee-allan {
            background: #dbeafe;
            color: #1e40af;
            border-left-color: #3b82f6;
        }
        .calendar-service-day.employee-drew {
            background: #dcfce7;
            color: #166534;
            border-left-color: #22c55e;
        }
        .calendar-service-day.employee-matt {
            background: #fef3c7;
            color: #92400e;
            border-left-color: #f59e0b;
        }
        .calendar-service-day.employee-michael {
            background: #f3e8ff;
            color: #6b21a8;
            border-left-color: #a855f7;
        }
        .calendar-service-day.employee-red {
            background: #fee2e2;
            color: #991b1b;
            border-left-color: #ef4444;
        }
        .calendar-service-day.employee-stephen {
            background: #ccfbf1;
            color: #115e59;
            border-left-color: #14b8a6;
        }
        .calendar-service-day.employee-unknown {
            background: #f3f4f6;
            color: #374151;
            border-left-color: #9ca3af;
        }
        
        /* Invoiced indicator */
        .calendar-service-day.invoiced {
            box-shadow: inset 0 0 0 2px #16a34a;
            position: relative;
        }

        /* Completion status indicators */
        .calendar-service-day.completed {
            background: #16a34a;
            color: white;
        }

        .calendar-service-day.partial {
            background: #f59e0b;
            color: white;
        }

        .calendar-service-day.not-started {
            background: #e5e7eb;
            color: #6b7280;
        }

        .calendar-service-day .pod-count {
            font-weight: 600;
        }

        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            padding: 16px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            font-size: 13px;
            font-weight: 500;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-dot {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border-left: 4px solid transparent;
        }

        .legend-dot.employee-allan { background: #dbeafe; border-left-color: #3b82f6; }
        .legend-dot.employee-drew { background: #dcfce7; border-left-color: #22c55e; }
        .legend-dot.employee-matt { background: #fef3c7; border-left-color: #f59e0b; }
        .legend-dot.employee-michael { background: #f3e8ff; border-left-color: #a855f7; }
        .legend-dot.employee-red { background: #fee2e2; border-left-color: #ef4444; }
        .legend-dot.employee-stephen { background: #ccfbf1; border-left-color: #14b8a6; }

        /* Period Toggle (Week/Month) */
        .period-toggle {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-bottom: 16px;
            background: #e5e7eb;
            padding: 4px;
            border-radius: 8px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .period-toggle-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            background: transparent;
            color: #6b7280;
            transition: all 0.2s;
        }

        .period-toggle-btn.active {
            background: white;
            color: #1e3a5f;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .period-toggle-btn:hover:not(.active) {
            color: #374151;
        }

        /* Calendar header for month view */
        .calendar-header {
            display: none;
            grid-template-columns: repeat(5, 1fr);
            background: #374151;
            color: white;
        }

        .calendar-header.show {
            display: grid;
        }

        .calendar-header.month-view {
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-header-cell {
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }

        /* Calendar grid adjustments for month view */
        .calendar-grid.month-view {
            grid-template-columns: repeat(7, 1fr);
        }

        .calendar-grid.month-view .calendar-day {
            min-height: 120px;
            padding: 6px;
        }

        .calendar-grid.month-view .calendar-day-number {
            font-size: 12px;
            padding: 4px 6px;
            margin-bottom: 4px;
        }

        .calendar-grid.month-view .calendar-service-day {
            font-size: 11px;
            padding: 6px 8px;
        }

        .calendar-grid.month-view .calendar-service-days {
            gap: 3px;
        }

        /* View Toggle Tabs */
        .admin-view-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .admin-view-tab {
            flex: 1;
            padding: 12px;
            background: #e5e7eb;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .admin-view-tab.active {
            background: #374151;
            color: white;
        }

        .admin-view-tab:hover:not(.active) {
            background: #d1d5db;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-box">
            <div class="login-logo">üöõ</div>
            <h1 class="login-title">Oz Tank POD Manager</h1>
            <p class="login-subtitle">Sign in with your Oz Tank Google account</p>
            <div id="loginError" class="login-error">
                Access denied. Please use an authorized Oz Tank account.
            </div>
            <div id="googleSignInDiv"></div>
            <button id="googleSignInBtn" onclick="initiateGoogleSignIn()" style="margin-top: 16px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Home View -->
    <div id="homeView" class="view active">
        <div class="header" style="text-align: center;">
            <div id="userInfoDisplay" class="user-info" style="position: absolute; top: 8px; right: 8px;"></div>
            <img src="https://www.oztank.com.au/wp-content/uploads/2017/09/australia-soaking-tanks.png" alt="Oz Tank" class="header-logo" style="height: 60px; margin-bottom: 8px;">
            <p class="subtitle" style="font-size: 18px; font-weight: 600; margin-top: 4px;">Service POD Manager</p>
        </div>
        <div class="container">
            <!-- Admin Quick Actions - at top -->
            <div class="admin-quick-actions" style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                <button class="btn btn-secondary" style="flex: 1; min-width: 120px;" onclick="showAdminDashboard()">üìä Admin</button>
                <button class="btn btn-secondary" style="flex: 1; min-width: 120px;" onclick="showAdminPanelView()">üì• Import</button>
                <button class="btn btn-secondary" style="flex: 1; min-width: 120px;" onclick="showExportView()">üì§ Export PODs</button>
            </div>
            
            <!-- Week/Month Selector -->
            <div class="month-selector-container">
                <div class="month-selector-left"></div>
                <div class="month-selector-center">
                    <button class="month-nav-btn" onclick="navigateWorkerPeriod(-1)" title="Previous">‚Äπ</button>
                    <div class="month-display">
                        <div class="month-name" id="workerPeriodDisplay">Jan 13 - 17</div>
                        <div class="month-year" id="workerYearDisplay">2026</div>
                    </div>
                    <button class="month-nav-btn" onclick="navigateWorkerPeriod(1)" title="Next">‚Ä∫</button>
                </div>
                <div class="month-selector-right">
                    <button class="month-today-btn" id="workerTodayBtnTop" onclick="goToWorkerCurrentPeriod()" style="display: none;">Return to Today</button>
                </div>
            </div>
            
            <!-- Week/Month Toggle -->
            <div class="period-toggle">
                <button class="period-toggle-btn active" id="workerWeekPeriodBtn" onclick="setWorkerPeriod('week')">Week</button>
                <button class="period-toggle-btn" id="workerMonthPeriodBtn" onclick="setWorkerPeriod('month')">Month</button>
            </div>
            
            <!-- Month Status Notice -->
            <div id="monthStatusNotice" style="display: none;"></div>
            
            <!-- Worker Selector Card -->
            <div class="card">
                <h2 style="margin-bottom: 16px;">Select Service Day</h2>
                
                <!-- Worker Selector -->
                <div class="worker-selector-container">
                    <label for="workerSelect" style="font-weight: 500; color: #374151; margin-right: 8px;">Worker:</label>
                    <select id="workerSelect" class="worker-select" onchange="handleWorkerChange()">
                        <option value="">All Workers</option>
                        <!-- Workers will be populated dynamically -->
                    </select>
                </div>
                
                <!-- Worker's Calendar Events (hidden by default) -->
                <div id="workerCalendarEvents" style="display: none; margin-top: 16px;">
                    <!-- Week/List View Toggle -->
                    <div style="display: flex; align-items: center; justify-content: flex-start; margin-bottom: 12px;">
                        <div style="display: flex; gap: 4px; background: #e5e7eb; padding: 4px; border-radius: 8px; width: fit-content;">
                            <button class="period-toggle-btn active" id="workerWeekViewBtn" onclick="setWorkerCalendarView('week')">Week View</button>
                            <button class="period-toggle-btn" id="workerListViewBtn" onclick="setWorkerCalendarView('list')">List View</button>
                        </div>
                    </div>
                    
                    <!-- Week View -->
                    <div id="workerWeekView" style="background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden;">
                        <div id="workerWeekHeader" style="display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); background: #374151; color: white;">
                            <!-- Days header will be populated -->
                        </div>
                        <div id="workerWeekGrid" style="display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 1px; background: #e2e8f0;">
                            <!-- Week days will be populated -->
                        </div>
                    </div>
                    
                    <!-- List View (hidden by default) -->
                    <div id="workerListView" style="display: none; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div id="workerEventsList"></div>
                    </div>
                </div>
                
                <!-- Worker's service day count -->
                <div id="workerDayCount" class="worker-day-count" style="display: none;"></div>
                
                <!-- Month progress heading -->
                <div id="monthProgressHeading" style="margin-top: 16px; margin-bottom: 12px; padding: 8px 12px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px; text-align: center;">
                    <span style="font-weight: 600; color: #1e40af;">January 2026 Progress</span>
                </div>
                
                <div class="run-day-selector" id="runDaySelector">
                    <!-- Service days will be inserted here -->
                </div>
                <p style="text-align: center; color: #6b7280; margin-top: 16px; font-size: 14px;" id="noServiceDays">
                    No service days configured. Add service days in Import panel.
                </p>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-adhoc" onclick="showMainMenuAdHocWarning()" style="flex: 1; min-width: 150px;">‚ûï Ad-Hoc Service/Delivery</button>
                <button class="btn" onclick="showMainMenuTankWarning()" style="flex: 1; min-width: 150px; background: #0891b2;">üîÑ Tank Movement</button>
            </div>
        </div>
    </div>

    <!-- Customer List View -->
    <div id="customerListView" class="view">
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="showHomeView()">‚Üê Back</button>
                <div>
                    <h1 id="currentRunDay">Monday</h1>
                    <p class="subtitle" id="customerCount">0 customers</p>
                </div>
            </div>
        </div>
        <div class="container">
            <ul class="customer-list" id="customerList">
                <!-- Customers will be inserted here -->
            </ul>
        </div>
        <button class="add-service-fab" onclick="showActionChooser()" title="Add Service">+</button>
    </div>

    <!-- POD Creation View -->
    <div id="podView" class="view">
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="backToCustomerList()">‚Üê Back</button>
                <div>
                    <h1 id="podCustomerName">Customer Name</h1>
                    <p class="subtitle">Create POD</p>
                </div>
            </div>
        </div>
        <div class="container">
            <div id="existingPodView" style="display: none;">
                <!-- Existing POD content will be inserted here -->
            </div>
            
            <div id="podForm">
                <!-- Service Type & Carbsolve (Display only - from customer data) -->
                <div class="card">
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
                        <!-- Service Type Display -->
                        <div style="flex: 1; min-width: 100px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; color: #6b7280; font-size: 12px;">Service Type</label>
                            <div id="podServiceTypeDisplay" style="font-size: 16px; font-weight: 600; color: #111827;">Service</div>
                        </div>
                        
                        <!-- Carbsolve Display (hidden for deliveries) -->
                        <div id="podCarbsolveContainer" style="flex: 1; min-width: 100px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; color: #6b7280; font-size: 12px;">Carbsolve</label>
                            <div id="podCarbsolveDisplay" style="font-size: 16px; font-weight: 600; color: #111827;">-</div>
                        </div>
                        
                        <!-- Waste Display (if applicable) -->
                        <div id="podWasteContainer" style="flex: 1; min-width: 100px; display: none;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; color: #6b7280; font-size: 12px;">Waste</label>
                            <div id="podWasteDisplay" style="font-size: 16px; font-weight: 600; color: #92400e;">üõ¢Ô∏è Drum</div>
                        </div>
                    </div>
                </div>
                
                <!-- Tank Serviced -->
                <div class="card" id="tankServicedSection">
                    <div class="form-group">
                        <label>Tank Serviced?</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="tankServiced" value="yes">
                                Yes
                            </label>
                            <label>
                                <input type="radio" name="tankServiced" value="no">
                                No
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Service Notes</label>
                        <textarea id="serviceNotes" placeholder="Enter service notes..."></textarea>
                    </div>
                </div>

                <!-- Products Delivered (Sale Items) -->
                <div class="card">
                    <h3 style="margin-bottom: 12px;">Products Delivered</h3>
                    <div id="productLines">
                        <!-- Product lines will be inserted here -->
                    </div>
                    <button type="button" class="add-product-btn" onclick="addProductLine('sale')">+ Add Product</button>
                </div>

                <!-- Repair Items -->
                <div class="card">
                    <h3 style="margin-bottom: 12px;">Repair Items</h3>
                    <div id="repairLines">
                        <!-- Repair lines will be inserted here -->
                    </div>
                    <button type="button" class="add-product-btn" onclick="addProductLine('repair')">+ Add Repair Item</button>
                </div>

                <!-- Notes -->
                <div class="card">
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="notes" placeholder="Additional notes..."></textarea>
                    </div>
                </div>

                <!-- Photo -->
                <div class="card">
                    <div class="form-group">
                        <label>Photo</label>
                        <input type="file" id="photoInput" accept="image/*" capture="environment">
                        <img id="photoPreview" class="photo-preview" style="display: none;">
                    </div>
                </div>

                <!-- Customer Signature -->
                <div class="card">
                    <div class="form-group">
                        <label>Customer Signature</label>
                        <div style="margin-bottom: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" id="customerNotAvailable" onchange="toggleSignatureRequirement()" style="width: auto;">
                                Customer not available (signature not required)
                            </label>
                        </div>
                        <canvas id="signaturePad" class="signature-pad" width="400" height="200"></canvas>
                        <div class="signature-controls">
                            <button type="button" class="btn btn-secondary" onclick="clearSignature()">Clear</button>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-success" onclick="savePOD()">Save POD</button>
            </div>
        </div>
    </div>

    <!-- Admin View -->
    <div id="adminView" class="view">
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="showHomeView()">‚Üê Back</button>
                <div>
                    <h1>Import Panel</h1>
                    <p class="subtitle">Manage customers, products & service days</p>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="showAdminTab('customers')">Customers</button>
                <button class="tab" onclick="showAdminTab('serviceDays')">Service Days</button>
                <button class="tab" onclick="showAdminTab('products')">Products</button>
                <button class="tab" onclick="showAdminTab('calendarSync')">üìÖ Calendar Sync</button>
            </div>

            <!-- Customer Management -->
            <div id="customersTab" class="admin-tab">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Import Customers from Excel</h2>
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('excelFileInput').click()">
                        <div class="upload-icon">üìÑ</div>
                        <p style="color: #374151; font-weight: 500; margin-bottom: 4px;">Click to upload Excel file</p>
                        <p style="color: #6b7280; font-size: 14px;">or drag and drop</p>
                        <p style="color: #9ca3af; font-size: 12px; margin-top: 8px;">
                            Columns: Name | Service Day | Address | Phone | Service Type | Carbsolve | Waste | Code | Notes
                        </p>
                    </div>
                    <input type="file" id="excelFileInput" class="file-input" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
                    <div id="importStatus"></div>
                </div>

                <div class="card">
                    <h2 style="margin-bottom: 16px;">Add Single Customer</h2>
                    <form id="addCustomerForm">
                        <div class="form-group">
                            <label>Customer Name</label>
                            <input type="text" id="newCustomerName" required>
                        </div>
                        <div class="form-group">
                            <label>Service Day</label>
                            <input type="text" id="newCustomerServiceDay" placeholder="e.g., 12.2, North A" required>
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="newCustomerAddress">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="text" id="newCustomerPhone">
                        </div>
                        <div class="form-group">
                            <label>Service Type</label>
                            <select id="newCustomerServiceType">
                                <option value="">Select...</option>
                                <option value="Service">Service</option>
                                <option value="Delivery">Delivery</option>
                                <option value="Check">Check</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Carbsolve Requirement</label>
                            <select id="newCustomerCarbsolve">
                                <option value="">None</option>
                                <option value="4kg">4kg</option>
                                <option value="4kg spcl">4kg spcl</option>
                                <option value="7kg">7kg</option>
                                <option value="7kg spcl">7kg spcl</option>
                                <option value="10kg">10kg</option>
                                <option value="11kg spcl">11kg spcl</option>
                                <option value="14kg">14kg</option>
                                <option value="17kg">17kg</option>
                                <option value="21kg">21kg</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Waste</label>
                            <select id="newCustomerWaste">
                                <option value="">None</option>
                                <option value="Drum">Drum</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Code (Gate/Door)</label>
                            <input type="text" id="newCustomerCode" placeholder="e.g., 1234">
                        </div>
                        <div class="form-group">
                            <label>Notes</label>
                            <textarea id="newCustomerNotes" placeholder="Special instructions..."></textarea>
                        </div>
                        <button type="submit" class="btn">Add Customer</button>
                    </form>
                </div>

                <div class="admin-section">
                    <h2>Existing Customers</h2>
                    <div style="margin-bottom: 16px;">
                        <input type="text" id="customerAdminSearch" placeholder="üîç Search by customer name..." 
                               oninput="filterCustomerAdminList(this.value)"
                               style="width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                        <p id="customerAdminCount" style="font-size: 12px; color: #6b7280; margin-top: 8px;"></p>
                    </div>
                    <div id="customerAdminList">
                        <!-- Customers will be listed here -->
                    </div>
                </div>
            </div>

            <!-- Service Days Management -->
            <div id="serviceDaysTab" class="admin-tab" style="display: none;">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Add Service Day</h2>
                    <form id="addServiceDayForm">
                        <div class="form-group">
                            <label>Service Day Name</label>
                            <input type="text" id="newServiceDayName" placeholder="e.g., 12.2, North A" required>
                        </div>
                        <div class="form-group">
                            <label>Assigned Employee (optional)</label>
                            <input type="text" id="newServiceDayEmployee" placeholder="e.g., Drew">
                        </div>
                        <div class="form-group">
                            <label>Next Service Date (optional)</label>
                            <input type="date" id="newServiceDayDate">
                        </div>
                        <button type="submit" class="btn">Add Service Day</button>
                    </form>
                </div>

                <div class="admin-section">
                    <h2>Existing Service Days</h2>
                    <div id="serviceDayAdminList">
                        <!-- Service days will be listed here -->
                    </div>
                </div>
            </div>

            <!-- Product Management -->
            <div id="productsTab" class="admin-tab" style="display: none;">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Add New Product</h2>
                    <form id="addProductForm">
                        <div class="form-group">
                            <label>Product Name</label>
                            <input type="text" id="newProductName" required placeholder="e.g., Ovensolve 20L">
                        </div>
                        <button type="submit" class="btn">Add Product</button>
                    </form>
                </div>

                <div class="admin-section">
                    <h2>Existing Products</h2>
                    <div id="productAdminList">
                        <!-- Products will be listed here -->
                    </div>
                </div>
            </div>

            <!-- Calendar Sync Tab -->
            <div id="calendarSyncTab" class="admin-tab" style="display: none;">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">üìÖ Google Calendar Integration</h2>
                    <p style="color: #6b7280; margin-bottom: 16px;">
                        Connect your Google Calendar to automatically populate scheduled service days on the admin calendar.
                        This helps track which days are expected to be invoiced.
                    </p>
                    
                    <div class="form-group">
                        <label>Google Calendar ICS URL</label>
                        <input type="text" id="calendarIcsUrl" placeholder="https://calendar.google.com/calendar/ical/..." style="font-size: 13px;">
                        <p style="font-size: 12px; color: #9ca3af; margin-top: 6px;">
                            To get this URL: Google Calendar ‚Üí Settings ‚Üí [Your Calendar] ‚Üí Integrate calendar ‚Üí "Secret address in iCal format"
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" onclick="saveCalendarIcsUrl()">Save ICS URL</button>
                        <button class="btn btn-secondary" onclick="triggerCalendarSync()">üîÑ Sync Now</button>
                    </div>
                </div>
                
                <div class="card">
                    <h2 style="margin-bottom: 16px;">Sync Status</h2>
                    <div id="calendarSyncStatus">
                        <p style="color: #6b7280;">Loading sync status...</p>
                    </div>
                </div>
                
                <div class="card">
                    <h2 style="margin-bottom: 16px;">How It Works</h2>
                    <div style="color: #6b7280; font-size: 14px; line-height: 1.6;">
                        <p><strong>1. Calendar Event Naming:</strong> Name your calendar events with the service day at the start, e.g., "Day 12.2 - Drew" or "Spare Day 2 - Michael"</p>
                        <p style="margin-top: 8px;"><strong>2. Automatic Sync:</strong> Once configured, the system syncs nightly at 2 AM to pull upcoming service days from your calendar</p>
                        <p style="margin-top: 8px;"><strong>3. Admin Calendar:</strong> Scheduled service days appear on the Admin Dashboard calendar, showing expected vs completed work</p>
                        <p style="margin-top: 8px;"><strong>4. Invoicing:</strong> Click any service day on the calendar to open the runsheet for that date and manage invoicing</p>
                    </div>
                </div>
                
                <div class="card" style="background: #fef3c7; border: 1px solid #f59e0b;">
                    <h2 style="margin-bottom: 12px; color: #92400e;">‚ö†Ô∏è Setup Required</h2>
                    <p style="color: #92400e; font-size: 14px; line-height: 1.6;">
                        For the nightly sync to work, you need to deploy the Supabase Edge Function. 
                        This requires running a few commands in your terminal. Contact your developer to set this up,
                        or you can manually trigger syncs by clicking "Sync Now" after saving your ICS URL.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Export View -->
    <div id="exportView" class="view">
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="showHomeView()">‚Üê Back</button>
                <div>
                    <h1>Export PODs</h1>
                    <p class="subtitle">Download completed PODs</p>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="card">
                <div class="form-group">
                    <label>Filter by Service Day</label>
                    <select id="exportRunDayFilter">
                        <option value="all">All Service Days</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Filter by Date</label>
                    <input type="date" id="exportDateFilter">
                </div>
                <button class="btn" onclick="filterPODs()">Filter PODs</button>
            </div>

            <div id="exportPodList">
                <!-- Filtered PODs will appear here -->
            </div>
        </div>
    </div>

    <!-- Admin Dashboard View -->
    <div id="adminDashboardView" class="view">
        <div class="header">
            <div class="header-content">
                <button class="back-btn" onclick="showHomeView()">‚Üê Back</button>
                <div>
                    <h1>Admin Dashboard</h1>
                    <p class="subtitle">Runsheet overview & management</p>
                </div>
            </div>
        </div>
        <div class="container">
            <!-- Month Selector for Admin -->
            <div class="month-selector-container">
                <div class="month-selector-left"></div>
                <div class="month-selector-center">
                    <button class="month-nav-btn" onclick="navigatePeriod(-1)" title="Previous">‚Äπ</button>
                    <div class="month-display">
                        <div class="month-name" id="adminMonthDisplay">January</div>
                        <div class="month-year" id="adminYearDisplay">2026</div>
                    </div>
                    <button class="month-nav-btn" onclick="navigatePeriod(1)" title="Next">‚Ä∫</button>
                </div>
                <div class="month-selector-right">
                    <button class="month-today-btn" id="adminTodayBtn" onclick="goToCurrentPeriod()" style="display: none;">Return to Today</button>
                </div>
            </div>
            
            <!-- Week/Month Toggle -->
            <div class="period-toggle">
                <button class="period-toggle-btn active" id="weekViewBtn" onclick="setCalendarPeriod('week')">Week</button>
                <button class="period-toggle-btn" id="monthViewBtn" onclick="setCalendarPeriod('month')">Month</button>
            </div>
            
            <!-- Month Status Notice for Admin -->
            <div id="adminMonthStatusNotice" style="display: none;"></div>
            
            <!-- View Toggle -->
            <div class="admin-view-tabs">
                <button class="admin-view-tab active" id="calendarViewTab" onclick="showAdminCalendarView()">üìÖ Calendar View</button>
                <button class="admin-view-tab" id="listViewTab" onclick="showAdminListView()">üìã List View</button>
                <button class="admin-view-tab" id="bimonthlyViewTab" onclick="showBimonthlyView()">üìÖ Bi-Monthly Schedules</button>
            </div>
            
            <!-- Calendar View -->
            <div id="adminCalendarContainer">
                <div class="admin-calendar">
                    <!-- Calendar days will be inserted here -->
                    <div class="calendar-header" id="calendarHeader">
                        <div class="calendar-header-cell">Mon</div>
                        <div class="calendar-header-cell">Tue</div>
                        <div class="calendar-header-cell">Wed</div>
                        <div class="calendar-header-cell">Thu</div>
                        <div class="calendar-header-cell">Fri</div>
                    </div>
                    <div class="calendar-grid" id="adminCalendarGrid">
                        <!-- Calendar days will be inserted here -->
                    </div>
                    <div class="calendar-legend">
                        <div class="legend-item"><span class="legend-dot employee-allan"></span> Allan</div>
                        <div class="legend-item"><span class="legend-dot employee-drew"></span> Drew</div>
                        <div class="legend-item"><span class="legend-dot employee-matt"></span> Matt</div>
                        <div class="legend-item"><span class="legend-dot employee-michael"></span> Michael</div>
                        <div class="legend-item"><span class="legend-dot employee-red"></span> Red</div>
                        <div class="legend-item"><span class="legend-dot employee-stephen"></span> Stephen</div>
                    </div>
                </div>
            </div>
            
            <!-- List View (hidden by default) -->
            <div id="adminListContainer" style="display: none;">
                <div class="card">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Select Service Day</label>
                            <select id="adminServiceDaySelect" onchange="onServiceDaySelectChange()">
                                <option value="">Choose a service day...</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Select Date</label>
                            <select id="adminDateSelect" onchange="loadAdminRunsheet()">
                                <option value="">Choose a date...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bi-Monthly Schedules View (hidden by default) -->
            <div id="bimonthlyContainer" style="display: none;">
                <div class="card">
                    <h2 style="margin-bottom: 16px;">üìÖ Bi-Monthly & Quarterly Customers</h2>
                    <p style="color: #6b7280; margin-bottom: 16px;">Customers with non-monthly service schedules. Click to edit.</p>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="filterBimonthlyView('all')" id="biFilterAll" style="background: #1e3a5f; color: white;">All</button>
                        <button class="btn btn-secondary" onclick="filterBimonthlyView('odd')" id="biFilterOdd">Odd Months</button>
                        <button class="btn btn-secondary" onclick="filterBimonthlyView('even')" id="biFilterEven">Even Months</button>
                        <button class="btn btn-secondary" onclick="filterBimonthlyView('quarterly')" id="biFilterQuarterly">Quarterly</button>
                        <button class="btn btn-secondary" onclick="filterBimonthlyView('custom')" id="biFilterCustom">Custom</button>
                    </div>
                    <div id="bimonthlyList" style="overflow-x: auto;">
                        <!-- List will be populated by JS -->
                    </div>
                </div>
            </div>

            <div id="adminRunsheetContainer" style="display: none;">
                <!-- Service Day Header -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div>
                            <h2 id="adminRunsheetTitle" style="margin-bottom: 8px;">Service Day 12.2</h2>
                            <div style="color: #6b7280; font-size: 14px;">
                                <span id="adminRunsheetEmployee">Employee: Drew</span> | 
                                <span id="adminRunsheetDate">Tuesday 18th November</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                            <button class="btn" style="background: #16a34a;" onclick="markAllInvoiced()">‚úì Mark All Invoiced</button>
                            <button class="btn btn-success" onclick="exportRunsheetExcel()">Export Excel</button>
                        </div>
                    </div>
                    
                    <!-- Day Invoiced Toggle -->
                    <div id="dayInvoicedContainer" style="margin-top: 12px; padding: 12px 16px; border-radius: 8px; background: #f3f4f6; display: flex; align-items: center; justify-content: space-between;">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; font-weight: 500;">
                            <input type="checkbox" id="dayInvoicedCheckbox" onchange="toggleDayInvoiced()" style="width: 20px; height: 20px; cursor: pointer;">
                            <span>Day Fully Invoiced</span>
                        </label>
                        <span id="dayInvoicedTimestamp" style="font-size: 12px; color: #6b7280;"></span>
                    </div>
                </div>

                <!-- Runsheet Table -->
                <div class="card" style="overflow-x: auto;">
                    <table id="adminRunsheetTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr style="background: #f3f4f6; text-align: left;">
                                <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Done</th>
                                <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">
                                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                        <input type="checkbox" id="invoiceSelectAll" onchange="toggleAllInvoices(this.checked)">
                                        Invoice
                                    </label>
                                </th>
                                <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Company</th>
                                <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Type</th>
                                <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Carbsolve</th>
                                <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Products</th>
                                <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="adminRunsheetTableBody">
                            <!-- Rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Tank Movements Section -->
                <div id="tankMovementsSection" class="card" style="margin-top: 16px; display: none;">
                    <h3 style="margin-bottom: 12px; color: #0891b2;">üîÑ Tank Movements</h3>
                    <table id="tankMovementsTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr style="background: #ecfeff; text-align: left;">
                                <th style="padding: 10px; border-bottom: 2px solid #0891b2;">Done</th>
                                <th style="padding: 10px; border-bottom: 2px solid #0891b2;">Company</th>
                                <th style="padding: 10px; border-bottom: 2px solid #0891b2;">Type</th>
                                <th style="padding: 10px; border-bottom: 2px solid #0891b2;">Tank Placed</th>
                                <th style="padding: 10px; border-bottom: 2px solid #0891b2;">Tank Pulled</th>
                                <th style="padding: 10px; border-bottom: 2px solid #0891b2;">Carbsolve</th>
                                <th style="padding: 10px; border-bottom: 2px solid #0891b2;">Reason</th>
                            </tr>
                        </thead>
                        <tbody id="tankMovementsTableBody">
                            <!-- Tank movement rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Search Modal -->
    <div id="customerSearchModal" class="search-modal-overlay">
        <div class="search-modal">
            <div class="search-modal-header">
                <h2>Ad-Hoc Service/Delivery</h2>
                <button class="search-modal-close" onclick="hideCustomerSearchModal()">√ó</button>
            </div>
            <div class="search-modal-body">
                <!-- Service Type Selection -->
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">What type?</label>
                    <div style="display: flex; gap: 12px;">
                        <label style="flex: 1; display: flex; align-items: center; padding: 12px 16px; background: #f3f4f6; border-radius: 8px; cursor: pointer; border: 2px solid transparent;" id="adHocServiceLabel">
                            <input type="radio" name="adHocType" value="Service" checked onchange="updateAdHocTypeSelection()" style="margin-right: 8px;">
                            <span>üîß Service</span>
                        </label>
                        <label style="flex: 1; display: flex; align-items: center; padding: 12px 16px; background: #f3f4f6; border-radius: 8px; cursor: pointer; border: 2px solid transparent;" id="adHocDeliveryLabel">
                            <input type="radio" name="adHocType" value="Delivery" onchange="updateAdHocTypeSelection()" style="margin-right: 8px;">
                            <span>üì¶ Delivery</span>
                        </label>
                    </div>
                </div>
                
                <div class="search-input-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="customerSearchInput" class="search-input" placeholder="Search customers (2+ characters)..." oninput="handleCustomerSearch(this.value)">
                </div>
                <div id="searchResults" class="search-results" style="display: none;">
                    <!-- Search results will be inserted here -->
                </div>
                <div id="searchHint" class="search-hint">
                    Type at least 2 characters to search 1,300+ customers
                </div>
                
                <div class="search-divider">OR</div>
                
                <div class="freetext-section">
                    <label>New / Other Customer</label>
                    <input type="text" id="freetextCustomerName" class="freetext-input" placeholder="Enter customer name...">
                    <button class="btn" onclick="startAdHocService()">Continue</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Edit Modal -->
    <div id="customerEditModal" class="search-modal-overlay">
        <div class="search-modal" style="max-width: 450px;">
            <div class="search-modal-header">
                <h2>üìù Edit Customer</h2>
                <button class="search-modal-close" onclick="hideCustomerEditModal()">√ó</button>
            </div>
            <div class="search-modal-body">
                <input type="hidden" id="editCustomerId">
                <div class="form-group">
                    <label style="font-weight: 600;">Customer Name</label>
                    <div id="editCustomerName" style="padding: 10px; background: #f3f4f6; border-radius: 6px; color: #374151;"></div>
                </div>
                <div class="form-group">
                    <label style="font-weight: 600;">üîë Keycode</label>
                    <input type="text" id="editCustomerCode" placeholder="Enter keycode/access code..." style="font-size: 16px;">
                    <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Gate code, door code, or access instructions</p>
                </div>
                <div class="form-group">
                    <label style="font-weight: 600;">üìù Notes</label>
                    <textarea id="editCustomerNotes" placeholder="Enter customer notes..." style="min-height: 100px;"></textarea>
                    <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">General notes about this customer</p>
                </div>
                <div class="form-group">
                    <label style="font-weight: 600;">‚ö†Ô∏è Special Instructions</label>
                    <textarea id="editCustomerSpecialInstructions" placeholder="Enter special instructions (shown prominently)..." style="min-height: 80px; border-color: #f59e0b;"></textarea>
                    <p style="font-size: 12px; color: #f59e0b; margin-top: 4px;">Important instructions displayed prominently to workers</p>
                </div>
                <div class="form-group">
                    <label style="font-weight: 600;">üìÖ Service Schedule</label>
                    <select id="editCustomerSchedule" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                        <option value="">Monthly (every month)</option>
                        <option value="1,3,5,7,9,11">Bi-monthly: Jan, Mar, May, Jul, Sep, Nov (odd)</option>
                        <option value="2,4,6,8,10,12">Bi-monthly: Feb, Apr, Jun, Aug, Oct, Dec (even)</option>
                        <option value="3,6,9,12">Quarterly: Mar, Jun, Sep, Dec</option>
                        <option value="1,4,7,10">Quarterly: Jan, Apr, Jul, Oct</option>
                        <option value="2,5,8,11">Quarterly: Feb, May, Aug, Nov</option>
                        <option value="custom">Custom months...</option>
                    </select>
                    <div id="customMonthsContainer" style="display: none; margin-top: 8px;">
                        <label style="font-size: 12px; color: #6b7280;">Select service months:</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;">
                            <label class="month-checkbox"><input type="checkbox" value="1"> Jan</label>
                            <label class="month-checkbox"><input type="checkbox" value="2"> Feb</label>
                            <label class="month-checkbox"><input type="checkbox" value="3"> Mar</label>
                            <label class="month-checkbox"><input type="checkbox" value="4"> Apr</label>
                            <label class="month-checkbox"><input type="checkbox" value="5"> May</label>
                            <label class="month-checkbox"><input type="checkbox" value="6"> Jun</label>
                            <label class="month-checkbox"><input type="checkbox" value="7"> Jul</label>
                            <label class="month-checkbox"><input type="checkbox" value="8"> Aug</label>
                            <label class="month-checkbox"><input type="checkbox" value="9"> Sep</label>
                            <label class="month-checkbox"><input type="checkbox" value="10"> Oct</label>
                            <label class="month-checkbox"><input type="checkbox" value="11"> Nov</label>
                            <label class="month-checkbox"><input type="checkbox" value="12"> Dec</label>
                        </div>
                    </div>
                    <p style="font-size: 12px; color: #6b7280; margin-top: 4px;">Leave as Monthly for regular customers</p>
                </div>
                <button class="btn btn-success" onclick="saveCustomerEdit()">üíæ Save Changes</button>
                <button class="btn btn-secondary" onclick="hideCustomerEditModal()" style="margin-top: 8px;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Tank Movement Modal -->
    <div id="tankMovementModal" class="search-modal-overlay">
        <div class="search-modal" style="max-width: 500px;">
            <div class="search-modal-header" style="background: #0891b2;">
                <h2>üîÑ Tank Movement</h2>
                <button class="search-modal-close" onclick="hideTankMovementModal()">√ó</button>
            </div>
            <div class="search-modal-body">
                <!-- Customer Search Section -->
                <div class="form-group" style="margin-bottom: 8px;">
                    <label style="font-weight: 600;">Company</label>
                </div>
                <div class="search-input-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="tankMovementCustomerSearch" class="search-input" placeholder="Search customers..." oninput="handleTankMovementSearch(this.value)">
                </div>
                <div id="tankMovementSearchResults" class="search-results" style="display: none; max-height: 150px;"></div>
                <div id="tankMovementSelectedCustomer" style="display: none; padding: 10px; background: #dcfce7; border-radius: 6px; margin-bottom: 16px;">
                    <span id="tankMovementCustomerName" style="font-weight: 600;"></span>
                    <button type="button" onclick="clearTankMovementCustomer()" style="float: right; background: none; border: none; cursor: pointer; color: #dc2626;">‚úï</button>
                </div>

                <!-- Movement Type -->
                <div class="form-group">
                    <label style="font-weight: 600;">Movement Type</label>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 6px; padding: 12px 16px; background: #f3f4f6; border-radius: 6px; cursor: pointer; flex: 1; justify-content: center;">
                            <input type="radio" name="movementType" value="Swap" checked> Swap
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; padding: 12px 16px; background: #f3f4f6; border-radius: 6px; cursor: pointer; flex: 1; justify-content: center;">
                            <input type="radio" name="movementType" value="Pull"> Pull
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; padding: 12px 16px; background: #f3f4f6; border-radius: 6px; cursor: pointer; flex: 1; justify-content: center;">
                            <input type="radio" name="movementType" value="Place"> Place
                        </label>
                    </div>
                </div>

                <!-- Tank Numbers -->
                <div style="display: flex; gap: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <label style="font-weight: 600;">Tank No. Placed</label>
                        <input type="text" id="tankNoPlaced" placeholder="e.g. T-1234">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label style="font-weight: 600;">Tank No. Pulled</label>
                        <input type="text" id="tankNoPulled" placeholder="e.g. T-5678">
                    </div>
                </div>

                <!-- Carbsolve Size -->
                <div class="form-group">
                    <label style="font-weight: 600;">Carbsolve Size</label>
                    <select id="tankMovementCarbsolve" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                        <option value="">Select size...</option>
                        <option value="4kg">4kg</option>
                        <option value="7kg">7kg</option>
                        <option value="10kg">10kg</option>
                        <option value="14kg">14kg</option>
                        <option value="21kg">21kg</option>
                    </select>
                </div>

                <!-- Reason / Special Info -->
                <div class="form-group">
                    <label style="font-weight: 600;">Reason for Swap / Special Info</label>
                    <textarea id="tankMovementReason" placeholder="Enter reason or special information..." style="min-height: 80px;"></textarea>
                </div>

                <button class="btn btn-success" onclick="saveTankMovement()" style="background: #0891b2;">üíæ Save Tank Movement</button>
                <button class="btn btn-secondary" onclick="hideTankMovementModal()" style="margin-top: 8px;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Action Chooser Modal (for FAB) -->
    <div id="actionChooserModal" class="search-modal-overlay">
        <div class="search-modal" style="max-width: 350px;">
            <div class="search-modal-header">
                <h2>Add New</h2>
                <button class="search-modal-close" onclick="hideActionChooser()">√ó</button>
            </div>
            <div class="search-modal-body" style="display: flex; flex-direction: column; gap: 12px;">
                <button class="btn btn-adhoc" onclick="hideActionChooser(); showCustomerSearchModal(currentRunDay);" style="padding: 20px; font-size: 18px;">
                    ‚ûï Ad-Hoc Service/Delivery
                </button>
                <button class="btn" onclick="hideActionChooser(); showTankMovementModal(currentRunDay);" style="padding: 20px; font-size: 18px; background: #0891b2;">
                    üîÑ Tank Movement
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== GOOGLE AUTHENTICATION ====================
        const GOOGLE_CLIENT_ID = '776401812901-dvloaf4ajtdf5uplbaqohbdh08q79oqq.apps.googleusercontent.com';
        
        // Allowed email addresses (whitelist)
        const ALLOWED_EMAILS = [
            'allan.oztank@gmail.com',
            'drew.oztank@gmail.com',
            'mattoztank@gmail.com',
            'michael.oztank85@gmail.com',
            'officegroup.oztank@gmail.com',
            'red.oztank@gmail.com',
            'stephenp.oztank@gmail.com',
            'steve.oztank@gmail.com'
        ];
        
        let currentUser = null;
        let supabaseReady = false; // Track if Supabase is loaded
        
        // Check for existing session on load
        function checkExistingSession() {
            const savedUser = localStorage.getItem('oztank_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    // Verify token hasn't expired (Google tokens last ~1 hour, but we'll be lenient)
                    const savedTime = localStorage.getItem('oztank_login_time');
                    const hoursSinceLogin = (Date.now() - parseInt(savedTime || 0)) / (1000 * 60 * 60);
                    
                    // Re-authenticate after 24 hours
                    if (hoursSinceLogin < 24) {
                        onAuthSuccess(currentUser);
                        return true;
                    }
                } catch (e) {
                    console.log('Invalid saved session');
                }
            }
            return false;
        }
        
        // Initialize Google Sign-In
        function initGoogleAuth() {
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleCredentialResponse,
                    auto_select: true, // Auto sign-in if single account
                    cancel_on_tap_outside: false
                });
                
                // Render the One Tap prompt
                google.accounts.id.prompt((notification) => {
                    if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                        console.log('One Tap not displayed:', notification.getNotDisplayedReason() || notification.getSkippedReason());
                    }
                });
            } else {
                // Retry in 500ms if Google library not loaded yet
                setTimeout(initGoogleAuth, 500);
            }
        }
        
        // Handle the credential response from Google
        function handleCredentialResponse(response) {
            try {
                // Decode the JWT token
                const payload = decodeJwtPayload(response.credential);
                
                const user = {
                    email: payload.email,
                    name: payload.name,
                    picture: payload.picture,
                    token: response.credential
                };
                
                // Check if email is in whitelist
                if (ALLOWED_EMAILS.includes(user.email.toLowerCase())) {
                    // Save session
                    localStorage.setItem('oztank_user', JSON.stringify(user));
                    localStorage.setItem('oztank_login_time', Date.now().toString());
                    currentUser = user;
                    onAuthSuccess(user);
                } else {
                    showLoginError('Access denied. Your account (' + user.email + ') is not authorized.');
                }
            } catch (error) {
                console.error('Auth error:', error);
                showLoginError('Authentication failed. Please try again.');
            }
        }
        
        // Decode JWT payload (Google credential is a JWT)
        function decodeJwtPayload(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }
        
        // Manual sign-in button click
        function initiateGoogleSignIn() {
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.prompt();
            } else {
                showLoginError('Google Sign-In is still loading. Please wait a moment and try again.');
            }
        }
        
        // Show login error
        function showLoginError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }
        
        // On successful authentication
        function onAuthSuccess(user) {
            currentUser = user;
            
            // Hide login screen
            document.getElementById('loginScreen').classList.add('hidden');
            
            // Show user info in header
            updateUserDisplay();
            
            // Wait for Supabase to be ready, then initialize the app
            function waitForSupabase() {
                if (supabaseReady) {
                    initializeApp();
                } else {
                    setTimeout(waitForSupabase, 100);
                }
            }
            waitForSupabase();
        }
        
        // Update user display in header
        function updateUserDisplay() {
            const displayEl = document.getElementById('userInfoDisplay');
            if (displayEl && currentUser) {
                const firstName = currentUser.name ? currentUser.name.split(' ')[0] : currentUser.email.split('@')[0];
                displayEl.innerHTML = `
                    <img src="${currentUser.picture || ''}" alt="" onerror="this.style.display='none'">
                    <span>${firstName}</span>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                `;
            }
        }
        
        // Logout function
        function logout() {
            localStorage.removeItem('oztank_user');
            localStorage.removeItem('oztank_login_time');
            currentUser = null;
            
            // Disable auto-select for next sign-in
            if (typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.disableAutoSelect();
            }
            
            // Reload page to show login screen
            location.reload();
        }
        
        // Start auth check on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check for existing session first
            if (!checkExistingSession()) {
                // No valid session, initialize Google Sign-In
                initGoogleAuth();
            }
        });
        
        // ==================== END AUTHENTICATION ====================

        // Load Supabase dynamically
        function loadSupabase() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js';
                script.onload = () => {
                    console.log('Supabase library loaded');
                    resolve();
                };
                script.onerror = () => {
                    console.error('Failed to load Supabase');
                    reject(new Error('Failed to load Supabase library'));
                };
                document.head.appendChild(script);
            });
        }

        // Initialize Supabase
        let supabase;
        
        // Month Management - defaults to current month
        const now = new Date();
        let selectedMonth = now.getMonth(); // 0-indexed (0 = January)
        let selectedYear = now.getFullYear();
        
        // Week Management - for admin calendar
        // Get Monday of current week
        function getMondayOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust for Sunday
            return new Date(d.setDate(diff));
        }
        
        let selectedWeekStart = getMondayOfWeek(new Date()); // Monday of current week
        
        // Calendar period: 'week' or 'month'
        let calendarPeriod = 'week';
        
        const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 
                            'July', 'August', 'September', 'October', 'November', 'December'];
        
        // Format date as YYYY-MM-DD without UTC conversion (fixes timezone issues)
        function formatDateLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Period toggle functions
        function setCalendarPeriod(period) {
            calendarPeriod = period;
            
            // Update toggle buttons
            document.getElementById('weekViewBtn').classList.toggle('active', period === 'week');
            document.getElementById('monthViewBtn').classList.toggle('active', period === 'month');
            
            // Update calendar header and grid classes
            const header = document.getElementById('calendarHeader');
            const grid = document.getElementById('adminCalendarGrid');
            
            if (period === 'month') {
                header.classList.add('show', 'month-view');
                header.innerHTML = `
                    <div class="calendar-header-cell">Sun</div>
                    <div class="calendar-header-cell">Mon</div>
                    <div class="calendar-header-cell">Tue</div>
                    <div class="calendar-header-cell">Wed</div>
                    <div class="calendar-header-cell">Thu</div>
                    <div class="calendar-header-cell">Fri</div>
                    <div class="calendar-header-cell">Sat</div>
                `;
                grid.classList.add('month-view');
            } else {
                header.classList.remove('show', 'month-view');
                grid.classList.remove('month-view');
            }
            
            // Update display and reload data
            updatePeriodDisplay();
            refreshForPeriod();
        }
        
        function navigatePeriod(delta) {
            if (calendarPeriod === 'week') {
                changeWeek(delta);
            } else {
                changeMonth(delta);
                updatePeriodDisplay();
                refreshForPeriod();
            }
        }
        
        function goToCurrentPeriod() {
            if (calendarPeriod === 'week') {
                goToCurrentWeek();
            } else {
                goToCurrentMonth();
                updatePeriodDisplay();
                refreshForPeriod();
            }
        }
        
        function updatePeriodDisplay() {
            const adminMonthDisplay = document.getElementById('adminMonthDisplay');
            const adminYearDisplay = document.getElementById('adminYearDisplay');
            const adminTodayBtn = document.getElementById('adminTodayBtn');
            
            if (calendarPeriod === 'week') {
                // Week display format: "Jan 13 - 17"
                const friday = new Date(selectedWeekStart);
                friday.setDate(friday.getDate() + 4);
                
                const startMonth = MONTH_NAMES[selectedWeekStart.getMonth()].substring(0, 3);
                const endMonth = MONTH_NAMES[friday.getMonth()].substring(0, 3);
                const startDay = selectedWeekStart.getDate();
                const endDay = friday.getDate();
                
                let displayText;
                if (selectedWeekStart.getMonth() === friday.getMonth()) {
                    displayText = `${startMonth} ${startDay} - ${endDay}`;
                } else {
                    displayText = `${startMonth} ${startDay} - ${endMonth} ${endDay}`;
                }
                
                if (adminMonthDisplay) adminMonthDisplay.textContent = displayText;
                if (adminYearDisplay) adminYearDisplay.textContent = friday.getFullYear();
                if (adminTodayBtn) adminTodayBtn.style.display = isCurrentWeek() ? 'none' : 'block';
            } else {
                // Month display format: "January"
                if (adminMonthDisplay) adminMonthDisplay.textContent = MONTH_NAMES[selectedMonth];
                if (adminYearDisplay) adminYearDisplay.textContent = selectedYear;
                if (adminTodayBtn) adminTodayBtn.style.display = isCurrentMonth() ? 'none' : 'block';
            }
            
            // Update status notice
            updatePeriodStatusNotice();
        }
        
        function updatePeriodStatusNotice() {
            const adminNotice = document.getElementById('adminMonthStatusNotice');
            if (!adminNotice) return;
            
            let noticeHTML = '';
            
            if (calendarPeriod === 'week') {
                const today = new Date();
                const currentMonday = getMondayOfWeek(today);
                
                // Compare date strings to avoid time component issues
                const selectedWeekStr = formatDateLocal(selectedWeekStart);
                const currentMondayStr = formatDateLocal(currentMonday);
                
                if (selectedWeekStr < currentMondayStr) {
                    noticeHTML = `
                        <div class="historical-notice">
                            <strong>üìã Viewing Historical Data</strong>
                            You are viewing a past week. This is read-only historical data.
                        </div>
                    `;
                } else if (selectedWeekStr > currentMondayStr) {
                    noticeHTML = `
                        <div class="future-notice">
                            <strong>üìÖ Future Week Selected</strong>
                            You are viewing a future week. No PODs have been created yet.
                        </div>
                    `;
                }
            } else {
                if (isPastMonth()) {
                    noticeHTML = `
                        <div class="historical-notice">
                            <strong>üìã Viewing Historical Data</strong>
                            You are viewing ${MONTH_NAMES[selectedMonth]} ${selectedYear}. 
                            This is read-only historical data.
                        </div>
                    `;
                } else if (isFutureMonth()) {
                    noticeHTML = `
                        <div class="future-notice">
                            <strong>üìÖ Future Month Selected</strong>
                            You are viewing ${MONTH_NAMES[selectedMonth]} ${selectedYear}. 
                            No PODs have been created yet for this month.
                        </div>
                    `;
                }
            }
            
            adminNotice.innerHTML = noticeHTML;
            adminNotice.style.display = noticeHTML ? 'block' : 'none';
        }
        
        async function refreshForPeriod() {
            if (calendarPeriod === 'week') {
                await db.loadPodsForWeek();
                await db.loadScheduledDaysForWeek();
            } else {
                await db.loadPodsForMonth();
                await db.loadScheduledDaysForMonth();
            }
            renderAdminCalendar();
        }
        
        function isCurrentMonth() {
            const now = new Date();
            return selectedMonth === now.getMonth() && selectedYear === now.getFullYear();
        }
        
        function isPastMonth() {
            const now = new Date();
            const selectedDate = new Date(selectedYear, selectedMonth, 1);
            const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            return selectedDate < currentMonthStart;
        }
        
        function isFutureMonth() {
            const now = new Date();
            const selectedDate = new Date(selectedYear, selectedMonth, 1);
            const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            return selectedDate > currentMonthStart;
        }
        
        function getMonthDateRange() {
            const start = new Date(selectedYear, selectedMonth, 1);
            const end = new Date(selectedYear, selectedMonth + 1, 0, 23, 59, 59, 999);
            return { start, end };
        }
        
        function changeMonth(delta) {
            selectedMonth += delta;
            if (selectedMonth > 11) {
                selectedMonth = 0;
                selectedYear++;
            } else if (selectedMonth < 0) {
                selectedMonth = 11;
                selectedYear--;
            }
            updateMonthDisplay();
            refreshForMonth();
        }
        
        function updateMonthDisplay() {
            // Update home view month display
            const monthDisplay = document.getElementById('currentMonthDisplay');
            const yearDisplay = document.getElementById('currentYearDisplay');
            if (monthDisplay) monthDisplay.textContent = MONTH_NAMES[selectedMonth];
            if (yearDisplay) yearDisplay.textContent = selectedYear;
            
            // Update admin dashboard month display
            const adminMonthDisplay = document.getElementById('adminMonthDisplay');
            const adminYearDisplay = document.getElementById('adminYearDisplay');
            if (adminMonthDisplay) adminMonthDisplay.textContent = MONTH_NAMES[selectedMonth];
            if (adminYearDisplay) adminYearDisplay.textContent = selectedYear;
            
            // Show/hide Today buttons based on whether we're on current month
            const isCurrent = isCurrentMonth();
            const todayBtn = document.getElementById('todayBtn');
            const adminTodayBtn = document.getElementById('adminTodayBtn');
            if (todayBtn) todayBtn.style.display = isCurrent ? 'none' : 'block';
            if (adminTodayBtn) adminTodayBtn.style.display = isCurrent ? 'none' : 'block';
            
            // Update status notices
            updateMonthStatusNotice();
        }
        
        function goToCurrentMonth() {
            const now = new Date();
            selectedMonth = now.getMonth();
            selectedYear = now.getFullYear();
            updateMonthDisplay();
            refreshForMonth();
        }
        
        // Week navigation functions
        function changeWeek(delta) {
            selectedWeekStart = new Date(selectedWeekStart);
            selectedWeekStart.setDate(selectedWeekStart.getDate() + (delta * 7));
            
            // Update month/year to match week start for data loading
            selectedMonth = selectedWeekStart.getMonth();
            selectedYear = selectedWeekStart.getFullYear();
            
            updatePeriodDisplay();
            refreshForPeriod();
        }
        
        function goToCurrentWeek() {
            selectedWeekStart = getMondayOfWeek(new Date());
            selectedMonth = selectedWeekStart.getMonth();
            selectedYear = selectedWeekStart.getFullYear();
            updatePeriodDisplay();
            refreshForPeriod();
        }
        
        function isCurrentWeek() {
            const currentMonday = getMondayOfWeek(new Date());
            return formatDateLocal(selectedWeekStart) === formatDateLocal(currentMonday);
        }
        
        function updateWeekDisplay() {
            // Calculate Friday of the week
            const friday = new Date(selectedWeekStart);
            friday.setDate(friday.getDate() + 4);
            
            // Format: "Jan 13 - 17, 2026" or "Dec 30 - Jan 3, 2025/2026"
            const startMonth = MONTH_NAMES[selectedWeekStart.getMonth()].substring(0, 3);
            const endMonth = MONTH_NAMES[friday.getMonth()].substring(0, 3);
            const startDay = selectedWeekStart.getDate();
            const endDay = friday.getDate();
            
            let displayText;
            if (selectedWeekStart.getMonth() === friday.getMonth()) {
                displayText = `${startMonth} ${startDay} - ${endDay}`;
            } else {
                displayText = `${startMonth} ${startDay} - ${endMonth} ${endDay}`;
            }
            
            // Update admin dashboard week display
            const adminMonthDisplay = document.getElementById('adminMonthDisplay');
            const adminYearDisplay = document.getElementById('adminYearDisplay');
            if (adminMonthDisplay) adminMonthDisplay.textContent = displayText;
            if (adminYearDisplay) adminYearDisplay.textContent = friday.getFullYear();
            
            // Show/hide Today button
            const adminTodayBtn = document.getElementById('adminTodayBtn');
            if (adminTodayBtn) adminTodayBtn.style.display = isCurrentWeek() ? 'none' : 'block';
            
            // Update status notice for week
            updateWeekStatusNotice();
        }
        
        function updateWeekStatusNotice() {
            const adminNotice = document.getElementById('adminMonthStatusNotice');
            if (!adminNotice) return;
            
            const today = new Date();
            const currentMonday = getMondayOfWeek(today);
            
            // Compare date strings to avoid time component issues
            const selectedWeekStr = formatDateLocal(selectedWeekStart);
            const currentMondayStr = formatDateLocal(currentMonday);
            
            let noticeHTML = '';
            
            if (selectedWeekStr < currentMondayStr) {
                const friday = new Date(selectedWeekStart);
                friday.setDate(friday.getDate() + 4);
                noticeHTML = `
                    <div class="historical-notice">
                        <strong>üìã Viewing Historical Data</strong>
                        You are viewing a past week. This is read-only historical data.
                    </div>
                `;
            } else if (selectedWeekStr > currentMondayStr) {
                noticeHTML = `
                    <div class="future-notice">
                        <strong>üìÖ Future Week Selected</strong>
                        You are viewing a future week. No PODs have been created yet.
                    </div>
                `;
            }
            
            adminNotice.innerHTML = noticeHTML;
            adminNotice.style.display = noticeHTML ? 'block' : 'none';
        }
        
        async function refreshForWeek() {
            // Load PODs and scheduled days for the week
            await db.loadPodsForWeek();
            await db.loadScheduledDaysForWeek();
            renderAdminCalendar();
        }
        
        function updateMonthStatusNotice() {
            const homeNotice = document.getElementById('monthStatusNotice');
            const adminNotice = document.getElementById('adminMonthStatusNotice');
            
            let noticeHTML = '';
            
            if (isPastMonth()) {
                noticeHTML = `
                    <div class="historical-notice">
                        <strong>üìã Viewing Historical Data</strong>
                        You are viewing ${MONTH_NAMES[selectedMonth]} ${selectedYear}. 
                        This is read-only historical data.
                    </div>
                `;
            } else if (isFutureMonth()) {
                noticeHTML = `
                    <div class="future-notice">
                        <strong>üìÖ Future Month Selected</strong>
                        You are viewing ${MONTH_NAMES[selectedMonth]} ${selectedYear}. 
                        No PODs have been created yet for this month.
                    </div>
                `;
            }
            
            if (homeNotice) {
                homeNotice.innerHTML = noticeHTML;
                homeNotice.style.display = noticeHTML ? 'block' : 'none';
            }
            if (adminNotice) {
                adminNotice.innerHTML = noticeHTML;
                adminNotice.style.display = noticeHTML ? 'block' : 'none';
            }
        }
        
        async function refreshForMonth() {
            // Reload PODs for the selected month
            await db.loadPodsForMonth();
            
            // Reload monthly skips for the selected month
            await db.loadMonthlySkips();
            
            // Re-render views
            renderRunDays();
            
            // Re-render admin calendar if visible
            if (document.getElementById('adminCalendarContainer') && 
                document.getElementById('adminCalendarContainer').style.display !== 'none') {
                renderAdminCalendar();
            }
            
            // If admin runsheet is visible, reload it
            const adminSelect = document.getElementById('adminServiceDaySelect');
            if (adminSelect && adminSelect.value) {
                loadAdminRunsheet();
            }
        }
        
        // Load Supabase on page load, but don't initialize app until auth succeeds
        loadSupabase().then(() => {
            const SUPABASE_URL = 'https://mslgedwzgbyccevnbdsk.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbGdlZHd6Z2J5Y2Nldm5iZHNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNDAyNDksImV4cCI6MjA4MzgxNjI0OX0.vnwOHjDKTg0kCtXW9zrln9beoVbTxoHX7_tozYSu8Ko';
            
            // Check if supabase is available
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase not found on window object');
                showToast('Failed to initialize database connection', 'error');
                return;
            }
            
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('Supabase initialized successfully');
            supabaseReady = true;
            
            // Don't auto-start app - wait for auth
        }).catch(error => {
            console.error('Error loading Supabase:', error);
            showToast('Failed to load database library. Please check your internet connection.', 'error');
        });

        // Database (now using Supabase)
        const db = {
            customers: [],
            products: [],
            pods: [],
            serviceDays: [],
            calendarUrl: '',
            invoiceStatus: {},
            serviceDayInvoiceStatus: {},
            tankMovements: [],
            monthlySkips: {}, // Tracks customers skipped for specific months (key: "customerId-YYYY-MM")
            
            async load() {
                try {
                    showToast('Loading data...', 'success');
                    
                    // Load customers (paginate to get all - Supabase has 1000 row default limit)
                    let allCustomers = [];
                    let page = 0;
                    const pageSize = 1000;
                    let hasMore = true;
                    
                    while (hasMore) {
                        const { data: batch, error: custError } = await supabase
                            .from('customers')
                            .select('*')
                            .order('order', { ascending: true })
                            .range(page * pageSize, (page + 1) * pageSize - 1);
                        if (custError) throw custError;
                        
                        if (batch && batch.length > 0) {
                            allCustomers = allCustomers.concat(batch);
                            page++;
                            hasMore = batch.length === pageSize;
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    // Map snake_case from DB to camelCase for JS
                    this.customers = allCustomers.map(c => ({
                        id: c.id,
                        name: c.name,
                        runDay: c.run_day,
                        address: c.address,
                        phone: c.phone,
                        serviceType: c.service_type,
                        carbsolve: c.carbsolve,
                        waste: c.waste,
                        code: c.code,
                        notes: c.notes,
                        specialInstructions: c.special_instructions,
                        businessGroup: c.business_group,
                        invoiceType: c.invoice_type,
                        order: c.order,
                        serviceMonths: c.service_months // Array of months [1,3,5,7,9,11] for bi-monthly, null for monthly
                    }));
                    
                    // Load service days
                    const { data: serviceDays, error: sdError } = await supabase
                        .from('service_days')
                        .select('*');
                    if (sdError) throw sdError;
                    this.serviceDays = serviceDays || [];
                    
                    // Sort service days naturally (Day 1, Day 2, ..., Day 10, Day 11, etc.)
                    this.serviceDays.sort((a, b) => {
                        const aName = a.name || '';
                        const bName = b.name || '';
                        // Extract the numeric part for natural sorting
                        const aMatch = aName.match(/^(Day\s*)(\d+\.?\d*)/i);
                        const bMatch = bName.match(/^(Day\s*)(\d+\.?\d*)/i);
                        if (aMatch && bMatch) {
                            return parseFloat(aMatch[2]) - parseFloat(bMatch[2]);
                        }
                        return aName.localeCompare(bName, undefined, { numeric: true });
                    });
                    
                    // Load products with categories
                    const { data: products, error: prodError } = await supabase
                        .from('products')
                        .select('*')
                        .eq('is_active', true)
                        .order('category', { ascending: true })
                        .order('display_name', { ascending: true });
                    if (prodError) throw prodError;
                    this.products = products || [];
                    // Keep flat list of names for backward compatibility
                    this.productNames = this.products.map(p => p.display_name || p.name);
                    
                    // Load PODs for selected month
                    await this.loadPodsForMonth();
                    
                    // Load invoice status
                    const { data: invoices, error: invError } = await supabase
                        .from('invoice_status')
                        .select('*');
                    if (invError) throw invError;
                    this.invoiceStatus = {};
                    if (invoices) {
                        invoices.forEach(inv => {
                            this.invoiceStatus[inv.pod_id] = inv.invoiced;
                        });
                    }
                    
                    // Load service day invoice status
                    await this.loadServiceDayInvoiceStatus();
                    
                    // Load tank movements for selected month
                    await this.loadTankMovementsForMonth();
                    
                    // Load monthly skips for selected month
                    await this.loadMonthlySkips();
                    
                    // Load calendar URL from localStorage (not in DB)
                    const calUrl = localStorage.getItem('podCalendarUrl');
                    if (calUrl) this.calendarUrl = calUrl;
                    
                    // Load calendar sync settings
                    await this.loadCalendarSyncSettings();
                    
                    console.log('Data loaded:', {
                        customers: this.customers.length,
                        serviceDays: this.serviceDays.length,
                        products: this.products.length,
                        pods: this.pods.length
                    });
                    
                } catch (error) {
                    console.error('Error loading data:', error);
                    showToast('Error loading data: ' + error.message, 'error');
                }
            },
            
            scheduledDays: [],
            calendarSyncSettings: null,
            
            async loadCalendarSyncSettings() {
                try {
                    const { data, error } = await supabase
                        .from('calendar_sync_settings')
                        .select('*')
                        .eq('id', 1)
                        .single();
                    
                    if (!error && data) {
                        this.calendarSyncSettings = data;
                    }
                } catch (e) {
                    console.log('Calendar sync settings not configured yet');
                }
            },
            
            async loadScheduledDaysForMonth() {
                try {
                    const { start, end } = getMonthDateRange();
                    const startStr = formatDateLocal(start);
                    const endStr = formatDateLocal(end);
                    
                    // Use worker_calendar_events which syncs successfully
                    const { data, error } = await supabase
                        .from('worker_calendar_events')
                        .select('*')
                        .gte('event_date', startStr)
                        .lte('event_date', endStr)
                        .eq('is_service_day', true);
                    
                    if (!error && data) {
                        this.scheduledDays = data.map(sd => ({
                            serviceDayName: sd.service_day_name,
                            scheduledDate: sd.event_date,
                            eventTitle: sd.event_title,
                            calendarOwner: sd.calendar_owner
                        }));
                        console.log(`Loaded ${this.scheduledDays.length} scheduled days for ${MONTH_NAMES[selectedMonth]} ${selectedYear}`);
                    }
                } catch (e) {
                    console.log('Error loading scheduled days:', e);
                    this.scheduledDays = [];
                }
            },
            
            async saveCalendarIcsUrl(icsUrl) {
                try {
                    const { error } = await supabase
                        .from('calendar_sync_settings')
                        .upsert({
                            id: 1,
                            ics_url: icsUrl,
                            updated_at: new Date().toISOString()
                        });
                    
                    if (error) throw error;
                    this.calendarSyncSettings = { ...this.calendarSyncSettings, ics_url: icsUrl };
                    return true;
                } catch (e) {
                    console.error('Error saving ICS URL:', e);
                    return false;
                }
            },
            
            async triggerCalendarSync() {
                try {
                    const response = await fetch(
                        'https://mslgedwzgbyccevnbdsk.supabase.co/functions/v1/sync-google-calendar',
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zbGdlZHd6Z2J5Y2Nldm5iZHNrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNDAyNDksImV4cCI6MjA4MzgxNjI0OX0.vnwOHjDKTg0kCtXW9zrln9beoVbTxoHX7_tozYSu8Ko`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );
                    const result = await response.json();
                    return result;
                } catch (e) {
                    console.error('Error triggering calendar sync:', e);
                    return { success: false, error: e.message };
                }
            },
            
            async loadPodsForMonth() {
                try {
                    const { start, end } = getMonthDateRange();
                    const startStr = start.toISOString().split('T')[0];
                    const endStr = end.toISOString().split('T')[0];
                    
                    const { data: pods, error: podsError } = await supabase
                        .from('pods')
                        .select('*')
                        .gte('date', startStr)
                        .lte('date', endStr)
                        .order('timestamp', { ascending: false });
                    
                    if (podsError) throw podsError;
                    
                    // Map snake_case from DB to camelCase for JS
                    this.pods = (pods || []).map(p => ({
                        id: p.id,
                        customerId: p.customer_id,
                        customerName: p.customer_name,
                        customerAddress: p.customer_address,
                        runDay: p.run_day,
                        date: p.date,
                        timestamp: p.timestamp,
                        serviceType: p.service_type,
                        carbsolve: p.carbsolve,
                        tankServiced: p.tank_serviced,
                        serviceNotes: p.service_notes,
                        products: p.products,
                        notes: p.notes,
                        photo: p.photo,
                        signature: p.signature,
                        customerNotAvailable: p.customer_not_available,
                        isAdHoc: p.is_ad_hoc || false,
                        sourceRunDay: p.source_run_day,
                        archived: p.archived
                    }));
                    
                    // Also load scheduled days for the month
                    await this.loadScheduledDaysForMonth();
                    
                    console.log(`Loaded ${this.pods.length} PODs for ${MONTH_NAMES[selectedMonth]} ${selectedYear}`);
                } catch (error) {
                    console.error('Error loading PODs for month:', error);
                    showToast('Error loading PODs: ' + error.message, 'error');
                }
            },
            
            async loadPodsForWeek() {
                try {
                    const startStr = formatDateLocal(selectedWeekStart);
                    const friday = new Date(selectedWeekStart);
                    friday.setDate(friday.getDate() + 4);
                    const endStr = formatDateLocal(friday);
                    
                    const { data: pods, error: podsError } = await supabase
                        .from('pods')
                        .select('*')
                        .gte('date', startStr)
                        .lte('date', endStr)
                        .order('timestamp', { ascending: false });
                    
                    if (podsError) throw podsError;
                    
                    this.pods = (pods || []).map(p => ({
                        id: p.id,
                        customerId: p.customer_id,
                        customerName: p.customer_name,
                        customerAddress: p.customer_address,
                        runDay: p.run_day,
                        date: p.date,
                        timestamp: p.timestamp,
                        serviceType: p.service_type,
                        carbsolve: p.carbsolve,
                        tankServiced: p.tank_serviced,
                        serviceNotes: p.service_notes,
                        products: p.products,
                        notes: p.notes,
                        photo: p.photo,
                        signature: p.signature,
                        customerNotAvailable: p.customer_not_available,
                        isAdHoc: p.is_ad_hoc || false,
                        sourceRunDay: p.source_run_day,
                        archived: p.archived
                    }));
                    
                    console.log(`Loaded ${this.pods.length} PODs for week starting ${startStr}`);
                } catch (error) {
                    console.error('Error loading PODs for week:', error);
                    showToast('Error loading PODs: ' + error.message, 'error');
                }
            },
            
            // Load PODs for a specific month (used for progress tiles)
            async loadPodsForSpecificMonth(month, year) {
                try {
                    const start = new Date(year, month, 1);
                    const end = new Date(year, month + 1, 0);
                    const startStr = formatDateLocal(start);
                    const endStr = formatDateLocal(end);
                    
                    const { data: pods, error: podsError } = await supabase
                        .from('pods')
                        .select('*')
                        .gte('date', startStr)
                        .lte('date', endStr)
                        .order('timestamp', { ascending: false });
                    
                    if (podsError) throw podsError;
                    
                    // Return mapped PODs (don't overwrite this.pods)
                    return (pods || []).map(p => ({
                        id: p.id,
                        customerId: p.customer_id,
                        customerName: p.customer_name,
                        customerAddress: p.customer_address,
                        runDay: p.run_day,
                        date: p.date,
                        timestamp: p.timestamp,
                        serviceType: p.service_type,
                        carbsolve: p.carbsolve,
                        tankServiced: p.tank_serviced,
                        serviceNotes: p.service_notes,
                        products: p.products,
                        notes: p.notes,
                        photo: p.photo,
                        signature: p.signature,
                        customerNotAvailable: p.customer_not_available,
                        isAdHoc: p.is_ad_hoc || false,
                        sourceRunDay: p.source_run_day,
                        archived: p.archived
                    }));
                } catch (error) {
                    console.error('Error loading PODs for specific month:', error);
                    return [];
                }
            },
            
            async loadScheduledDaysForWeek() {
                try {
                    const startStr = formatDateLocal(selectedWeekStart);
                    const friday = new Date(selectedWeekStart);
                    friday.setDate(friday.getDate() + 4);
                    const endStr = formatDateLocal(friday);
                    
                    // Use worker_calendar_events which syncs successfully
                    const { data, error } = await supabase
                        .from('worker_calendar_events')
                        .select('*')
                        .gte('event_date', startStr)
                        .lte('event_date', endStr)
                        .eq('is_service_day', true);
                    
                    if (!error && data) {
                        this.scheduledDays = data.map(sd => ({
                            serviceDayName: sd.service_day_name,
                            scheduledDate: sd.event_date,
                            eventTitle: sd.event_title,
                            calendarOwner: sd.calendar_owner
                        }));
                        console.log(`Loaded ${this.scheduledDays.length} scheduled days for week starting ${startStr}`);
                    }
                } catch (e) {
                    console.log('Error loading scheduled days:', e);
                    this.scheduledDays = [];
                }
            },
            
            async saveCustomer(customer) {
                try {
                    const { data, error } = await supabase
                        .from('customers')
                        .upsert({
                            id: customer.id,
                            name: customer.name,
                            run_day: customer.runDay,
                            address: customer.address,
                            phone: customer.phone,
                            service_type: customer.serviceType,
                            carbsolve: customer.carbsolve,
                            waste: customer.waste,
                            code: customer.code,
                            notes: customer.notes,
                            special_instructions: customer.specialInstructions,
                            business_group: customer.businessGroup,
                            order: customer.order,
                            service_months: customer.serviceMonths
                        });
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Error saving customer:', error);
                    showToast('Error saving customer: ' + error.message, 'error');
                    return false;
                }
            },
            
            async deleteCustomer(id) {
                try {
                    const { error } = await supabase
                        .from('customers')
                        .delete()
                        .eq('id', id);
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Error deleting customer:', error);
                    showToast('Error deleting customer: ' + error.message, 'error');
                    return false;
                }
            },
            
            async saveServiceDay(serviceDay) {
                try {
                    const { data, error } = await supabase
                        .from('service_days')
                        .upsert({
                            name: serviceDay.name,
                            employee: serviceDay.employee,
                            date: serviceDay.date
                        });
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Error saving service day:', error);
                    showToast('Error saving service day: ' + error.message, 'error');
                    return false;
                }
            },
            
            async deleteServiceDay(name) {
                try {
                    const { error } = await supabase
                        .from('service_days')
                        .delete()
                        .eq('name', name);
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Error deleting service day:', error);
                    showToast('Error deleting service day: ' + error.message, 'error');
                    return false;
                }
            },
            
            async saveProduct(productName) {
                try {
                    const { data, error } = await supabase
                        .from('products')
                        .upsert({ name: productName });
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Error saving product:', error);
                    showToast('Error saving product: ' + error.message, 'error');
                    return false;
                }
            },
            
            async deleteProduct(productName) {
                try {
                    const { error } = await supabase
                        .from('products')
                        .delete()
                        .eq('name', productName);
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showToast('Error deleting product: ' + error.message, 'error');
                    return false;
                }
            },
            
            async savePOD(pod) {
                try {
                    const { data, error } = await supabase
                        .from('pods')
                        .upsert({
                            id: pod.id,
                            customer_id: pod.customerId,
                            customer_name: pod.customerName,
                            customer_address: pod.customerAddress,
                            run_day: pod.runDay,
                            date: pod.date,
                            timestamp: pod.timestamp,
                            service_type: pod.serviceType,
                            carbsolve: pod.carbsolve,
                            tank_serviced: pod.tankServiced,
                            service_notes: pod.serviceNotes,
                            products: pod.products,
                            notes: pod.notes,
                            photo: pod.photo,
                            signature: pod.signature,
                            customer_not_available: pod.customerNotAvailable,
                            is_ad_hoc: pod.isAdHoc || false,
                            source_run_day: pod.sourceRunDay || null,
                            archived: pod.archived || false
                        });
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Error saving POD:', error);
                    showToast('Error saving POD: ' + error.message, 'error');
                    return false;
                }
            },
            
            async saveInvoiceStatus(podId, invoiced) {
                try {
                    const { data, error } = await supabase
                        .from('invoice_status')
                        .upsert({
                            pod_id: podId,
                            invoiced: invoiced
                        });
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Error saving invoice status:', error);
                    return false;
                }
            },
            
            async loadServiceDayInvoiceStatus() {
                try {
                    const { data, error } = await supabase
                        .from('service_day_invoice_status')
                        .select('*');
                    
                    this.serviceDayInvoiceStatus = {};
                    if (!error && data) {
                        data.forEach(item => {
                            // Key by "serviceDayName|date" for unique identification
                            const key = `${item.service_day_name}|${item.service_date}`;
                            this.serviceDayInvoiceStatus[key] = {
                                invoiced: item.invoiced,
                                invoicedAt: item.invoiced_at
                            };
                        });
                    }
                } catch (e) {
                    console.log('Service day invoice status table not set up yet');
                    this.serviceDayInvoiceStatus = {};
                }
            },
            
            async saveServiceDayInvoiceStatus(serviceDayName, serviceDate, invoiced) {
                try {
                    const { error } = await supabase
                        .from('service_day_invoice_status')
                        .upsert({
                            service_day_name: serviceDayName,
                            service_date: serviceDate,
                            invoiced: invoiced,
                            invoiced_at: invoiced ? new Date().toISOString() : null
                        });
                    
                    if (error) throw error;
                    
                    // Update local cache
                    const key = `${serviceDayName}|${serviceDate}`;
                    this.serviceDayInvoiceStatus[key] = {
                        invoiced: invoiced,
                        invoicedAt: invoiced ? new Date().toISOString() : null
                    };
                    
                    return true;
                } catch (e) {
                    console.error('Error saving service day invoice status:', e);
                    return false;
                }
            },
            
            isServiceDayInvoiced(serviceDayName, serviceDate) {
                const key = `${serviceDayName}|${serviceDate}`;
                return this.serviceDayInvoiceStatus[key]?.invoiced || false;
            },
            
            getServiceDayInvoicedAt(serviceDayName, serviceDate) {
                const key = `${serviceDayName}|${serviceDate}`;
                return this.serviceDayInvoiceStatus[key]?.invoicedAt || null;
            },
            
            async loadTankMovementsForMonth() {
                try {
                    const { start, end } = getMonthDateRange();
                    const startStr = start.toISOString().split('T')[0];
                    const endStr = end.toISOString().split('T')[0];
                    
                    const { data, error } = await supabase
                        .from('tank_movements')
                        .select('*')
                        .gte('date', startStr)
                        .lte('date', endStr)
                        .order('timestamp', { ascending: false });
                    
                    if (error) {
                        console.log('Tank movements table may not exist yet');
                        this.tankMovements = [];
                        return;
                    }
                    
                    this.tankMovements = (data || []).map(tm => ({
                        id: tm.id,
                        customerId: tm.customer_id,
                        customerName: tm.customer_name,
                        runDay: tm.run_day,
                        date: tm.date,
                        timestamp: tm.timestamp,
                        movementType: tm.movement_type,
                        tankNoPlaced: tm.tank_no_placed,
                        tankNoPulled: tm.tank_no_pulled,
                        carbsolve: tm.carbsolve,
                        reason: tm.reason,
                        sourceRunDay: tm.source_run_day
                    }));
                    
                    console.log(`Loaded ${this.tankMovements.length} tank movements`);
                } catch (e) {
                    console.log('Error loading tank movements:', e);
                    this.tankMovements = [];
                }
            },
            
            async saveTankMovement(movement) {
                try {
                    const { data, error } = await supabase
                        .from('tank_movements')
                        .upsert({
                            id: movement.id,
                            customer_id: movement.customerId,
                            customer_name: movement.customerName,
                            run_day: movement.runDay,
                            date: movement.date,
                            timestamp: movement.timestamp,
                            movement_type: movement.movementType,
                            tank_no_placed: movement.tankNoPlaced,
                            tank_no_pulled: movement.tankNoPulled,
                            carbsolve: movement.carbsolve,
                            reason: movement.reason,
                            source_run_day: movement.sourceRunDay || null
                        });
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Error saving tank movement:', error);
                    showToast('Error saving tank movement: ' + error.message, 'error');
                    return false;
                }
            },
            
            // Monthly skip functions - for customers to be skipped in a particular month
            async loadMonthlySkips() {
                try {
                    const yearMonth = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}`;
                    
                    const { data, error } = await supabase
                        .from('customer_monthly_skips')
                        .select('*')
                        .eq('year_month', yearMonth);
                    
                    if (error) {
                        // Table might not exist yet - that's okay
                        console.log('Monthly skips table may not exist yet');
                        this.monthlySkips = {};
                        return;
                    }
                    
                    this.monthlySkips = {};
                    if (data) {
                        data.forEach(skip => {
                            const key = `${skip.customer_id}-${skip.year_month}`;
                            this.monthlySkips[key] = {
                                reason: skip.reason || '',
                                createdAt: skip.created_at
                            };
                        });
                    }
                    
                    console.log(`Loaded ${Object.keys(this.monthlySkips).length} monthly skips for ${yearMonth}`);
                } catch (e) {
                    console.log('Error loading monthly skips:', e);
                    this.monthlySkips = {};
                }
            },
            
            async saveMonthlySkip(customerId, yearMonth, reason = '') {
                try {
                    const { error } = await supabase
                        .from('customer_monthly_skips')
                        .upsert({
                            customer_id: customerId,
                            year_month: yearMonth,
                            reason: reason,
                            created_at: new Date().toISOString()
                        }, { onConflict: 'customer_id,year_month' });
                    
                    if (error) throw error;
                    
                    // Update local cache
                    const key = `${customerId}-${yearMonth}`;
                    this.monthlySkips[key] = {
                        reason: reason,
                        createdAt: new Date().toISOString()
                    };
                    
                    return true;
                } catch (e) {
                    console.error('Error saving monthly skip:', e);
                    return false;
                }
            },
            
            async removeMonthlySkip(customerId, yearMonth) {
                try {
                    const { error } = await supabase
                        .from('customer_monthly_skips')
                        .delete()
                        .eq('customer_id', customerId)
                        .eq('year_month', yearMonth);
                    
                    if (error) throw error;
                    
                    // Update local cache
                    const key = `${customerId}-${yearMonth}`;
                    delete this.monthlySkips[key];
                    
                    return true;
                } catch (e) {
                    console.error('Error removing monthly skip:', e);
                    return false;
                }
            },
            
            isCustomerSkipped(customerId, month, year) {
                const yearMonth = `${year}-${String(month + 1).padStart(2, '0')}`;
                const key = `${customerId}-${yearMonth}`;
                return !!this.monthlySkips[key];
            },
            
            getSkipReason(customerId, month, year) {
                const yearMonth = `${year}-${String(month + 1).padStart(2, '0')}`;
                const key = `${customerId}-${yearMonth}`;
                return this.monthlySkips[key]?.reason || '';
            }
        };

        // Service months helper functions
        const SHORT_MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        
        function formatServiceMonths(serviceMonths) {
            if (!serviceMonths || serviceMonths.length === 0) return null;
            // serviceMonths is array like [1,3,5,7,9,11] (1-indexed months)
            return serviceMonths.map(m => SHORT_MONTH_NAMES[m - 1]).join(', ');
        }
        
        function isServiceMonth(serviceMonths, month) {
            // month is 0-indexed (JS style), serviceMonths is 1-indexed array
            if (!serviceMonths || serviceMonths.length === 0) return true; // Monthly = always service
            return serviceMonths.includes(month + 1);
        }
        
        function isOffMonth(customer, month, year) {
            // Returns true if this customer has a bi-monthly schedule and this is an off-month
            if (!customer.serviceMonths || customer.serviceMonths.length === 0) return false;
            return !customer.serviceMonths.includes(month + 1);
        }
        
        function getScheduleLabel(serviceMonths) {
            if (!serviceMonths || serviceMonths.length === 0) return null;
            if (serviceMonths.length === 6) {
                // Check if it's odd or even months
                const isOdd = serviceMonths.every(m => m % 2 === 1);
                const isEven = serviceMonths.every(m => m % 2 === 0);
                if (isOdd) return 'Bi-monthly (odd)';
                if (isEven) return 'Bi-monthly (even)';
            }
            if (serviceMonths.length === 4) {
                return 'Quarterly';
            }
            return 'Bi-monthly';
        }

        // Signature pad
        let signaturePad = null;
        let isDrawing = false;

        function initSignaturePad() {
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';

            signaturePad = { canvas, ctx, isEmpty: true };

            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signaturePad.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            signaturePad.ctx.beginPath();
            signaturePad.ctx.moveTo(x, y);
            signaturePad.isEmpty = false;
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = signaturePad.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            signaturePad.ctx.lineTo(x, y);
            signaturePad.ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signaturePad.canvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signaturePad.canvas.dispatchEvent(mouseEvent);
        }

        function clearSignature() {
            signaturePad.ctx.clearRect(0, 0, signaturePad.canvas.width, signaturePad.canvas.height);
            signaturePad.isEmpty = true;
        }

        function toggleSignatureRequirement() {
            const checkbox = document.getElementById('customerNotAvailable');
            const canvas = document.getElementById('signaturePad');
            
            if (checkbox.checked) {
                canvas.style.opacity = '0.3';
                canvas.style.pointerEvents = 'none';
            } else {
                canvas.style.opacity = '1';
                canvas.style.pointerEvents = 'auto';
            }
        }

        // Photo preview with compression
        document.getElementById('photoInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                try {
                    const compressedImage = await compressImage(file, 1280, 0.7);
                    const preview = document.getElementById('photoPreview');
                    preview.src = compressedImage;
                    preview.style.display = 'block';
                    // Store compressed image for later use
                    preview.dataset.compressed = compressedImage;
                    
                    // Show size savings
                    const originalSize = (file.size / 1024).toFixed(1);
                    const compressedSize = (compressedImage.length * 0.75 / 1024).toFixed(1); // Base64 is ~33% larger
                    console.log(`Image compressed: ${originalSize}KB ‚Üí ${compressedSize}KB`);
                } catch (error) {
                    console.error('Error compressing image:', error);
                    showToast('Error processing image', 'error');
                }
            }
        });

        // Image compression function
        function compressImage(file, maxWidth = 1280, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Calculate new dimensions
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to compressed JPEG
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Current state
        let currentRunDay = '';
        let currentServiceDate = null; // Track which date worker is working on
        let currentCustomer = null;

        // Toast notification system (replaces alerts)
        function showToast(message, type = 'success') {
            // Remove any existing toasts
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Format timestamp for display in AEST
        function formatTimestamp(isoString) {
            if (!isoString) return 'Unknown';
            
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return 'Unknown';
            
            // Format the time in AEST
            const timeStr = date.toLocaleTimeString('en-AU', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true,
                timeZone: 'Australia/Brisbane'
            });
            
            // Get the date portion in AEST for comparison
            const aestDateStr = date.toLocaleDateString('en-CA', { timeZone: 'Australia/Brisbane' }); // YYYY-MM-DD format
            const todayAestStr = new Date().toLocaleDateString('en-CA', { timeZone: 'Australia/Brisbane' });
            
            if (aestDateStr === todayAestStr) {
                return `Today at ${timeStr}`;
            } else {
                const dateStr = date.toLocaleDateString('en-AU', { 
                    month: 'short', 
                    day: 'numeric',
                    timeZone: 'Australia/Brisbane'
                });
                return `${dateStr} at ${timeStr}`;
            }
        }

        // Initialize
        async function initializeApp() {
            await db.load();

            // Add some demo data if none exists (for testing)
            if (db.customers.length === 0 && db.serviceDays.length === 0) {
                // Create demo service days
                const demoServiceDays = [
                    { name: '12.2', employee: 'Drew', date: '2024-11-18' },
                    { name: 'North A', employee: '', date: null }
                ];
                
                for (const sd of demoServiceDays) {
                    await db.saveServiceDay(sd);
                    db.serviceDays.push(sd);
                }
                
                // Create demo customers
                const demoCustomers = [
                    { 
                        id: Date.now(), 
                        name: 'ABC Restaurant', 
                        runDay: '12.2', 
                        address: '123 Main St, Brisbane', 
                        phone: '07 3000 1234', 
                        serviceType: 'Service',
                        carbsolve: '10kg',
                        waste: 'Drum',
                        code: '1234',
                        notes: 'Call before arrival', 
                        order: 0 
                    },
                    { 
                        id: Date.now() + 1, 
                        name: 'XYZ Cafe', 
                        runDay: '12.2', 
                        address: '456 Queen St, Brisbane', 
                        phone: '07 3000 5678',
                        serviceType: 'Delivery',
                        carbsolve: '7kg',
                        waste: '',
                        code: '',
                        notes: '', 
                        order: 1 
                    },
                    { 
                        id: Date.now() + 2, 
                        name: 'Fresh Bakery', 
                        runDay: 'North A', 
                        address: '789 George St, Brisbane', 
                        phone: '07 3000 9012',
                        serviceType: 'Check',
                        carbsolve: '4kg spcl',
                        waste: '',
                        code: '5678',
                        notes: 'Back entrance only', 
                        order: 0 
                    }
                ];
                
                for (const customer of demoCustomers) {
                    await db.saveCustomer(customer);
                    db.customers.push(customer);
                }
                
                // Create demo products
                const demoProducts = ['Ovensolve 20L', 'Ovensolve 5L', 'Carbsolve 10Kg', 'Carbsolve 7Kg'];
                for (const product of demoProducts) {
                    await db.saveProduct(product);
                    db.products.push(product);
                }
                
                showToast('Demo data created!', 'success');
            }
            
            // Initialize period display
            updateWorkerPeriodDisplay();
            
            // Clear any saved worker selection to default to "All Workers" calendar view
            currentSelectedWorker = '';
            localStorage.removeItem('selectedWorker');
            
            // Render initial UI
            renderRunDays();
            loadCalendar();
            
            // Load worker calendar events to show calendar view on initial load
            await loadWorkerCalendarEvents();
        }
        
        // initializeApp is now called from the Supabase loader above

        // Views
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function showHomeView() {
            // Clean up any existing other-workers-section before re-rendering
            const existingOther = document.querySelector('.other-workers-section');
            if (existingOther) existingOther.remove();
            
            showView('homeView');
            currentServiceDate = null; // Clear service date when returning home
            updateWorkerPeriodDisplay(); // Sync worker period display
            renderRunDays(); // Refresh run days to show updated progress
        }

        function showCustomerListView(runDay) {
            currentRunDay = runDay;
            showView('customerListView');
            renderCustomerList();
        }

        function showPodView(customer) {
            currentCustomer = customer;
            returnToRunDay = null; // Clear since we're opening from the regular runsheet
            
            // For historical months, only show existing PODs
            if (isPastMonth()) {
                // Find any existing POD for this customer in the selected month
                const existingPod = db.pods.find(pod => 
                    pod.customerId === customer.id
                );
                
                if (existingPod) {
                    showExistingPod(existingPod);
                } else {
                    showToast('No POD recorded for this customer in ' + MONTH_NAMES[selectedMonth] + ' ' + selectedYear, 'error');
                    return;
                }
            } else {
                // Current or future month - use service date if set, otherwise today
                const workDate = currentServiceDate || formatDateLocal(new Date());
                
                // Check if POD already exists for this customer on the work date
                const existingPod = db.pods.find(pod => 
                    pod.customerId === customer.id && 
                    pod.date === workDate
                );
                
                if (existingPod) {
                    // Show existing POD with edit option
                    showExistingPod(existingPod);
                } else {
                    // Show blank form for new POD
                    showNewPodForm();
                }
            }
        }

        function showNewPodForm() {
            showView('podView');
            document.getElementById('podCustomerName').textContent = currentCustomer.name;
            document.getElementById('podForm').style.display = 'block';
            document.getElementById('existingPodView').style.display = 'none';
            clearSignature();
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('photoPreview').dataset.compressed = '';
            document.getElementById('photoInput').value = '';
            document.getElementById('customerNotAvailable').checked = false;
            toggleSignatureRequirement();
            renderProductLines();
            
            // Display service type - for ad-hoc use selected type, otherwise use customer data
            const displayServiceType = isAdHocService ? adHocServiceType : (currentCustomer.serviceType || 'Service');
            document.getElementById('podServiceTypeDisplay').textContent = displayServiceType;
            
            // Display carbsolve from customer data (read-only) - hide for deliveries
            const isDelivery = displayServiceType === 'Delivery';
            const carbsolveContainer = document.getElementById('podCarbsolveContainer');
            if (carbsolveContainer) {
                carbsolveContainer.style.display = isDelivery ? 'none' : 'block';
            }
            const customerCarbsolve = currentCustomer.carbsolve || '-';
            document.getElementById('podCarbsolveDisplay').textContent = customerCarbsolve;
            
            // Display waste if applicable
            const wasteContainer = document.getElementById('podWasteContainer');
            if (currentCustomer.waste) {
                wasteContainer.style.display = 'block';
            } else {
                wasteContainer.style.display = 'none';
            }
            
            // Reset tank serviced
            document.querySelectorAll('input[name="tankServiced"]').forEach(r => r.checked = false);
            document.getElementById('serviceNotes').value = '';
            document.getElementById('notes').value = '';
            
            // Show/hide tank serviced section - hide for Delivery type
            const tankSection = document.getElementById('tankServicedSection');
            if (tankSection) {
                const isDelivery = displayServiceType === 'Delivery';
                tankSection.style.display = isDelivery ? 'none' : 'block';
            }
        }

        function showExistingPod(pod) {
            showView('podView');
            document.getElementById('podCustomerName').textContent = currentCustomer.name;
            document.getElementById('podForm').style.display = 'none';
            
            // Show existing POD view
            const existingView = document.getElementById('existingPodView');
            if (!existingView) {
                // Create the existing POD view container (will add to HTML)
                console.error('existingPodView element not found');
                return;
            }
            
            const isDelivery = pod.serviceType === 'Delivery';
            
            // Clean up carbsolve display - only show for non-deliveries
            let carbsolveDisplay = pod.carbsolve || '-';
            if (carbsolveDisplay && carbsolveDisplay !== '-') {
                carbsolveDisplay = carbsolveDisplay.replace(/^(Carbsolve\s*[-:]\s*|Carb:\s*)/i, '');
            }
            
            // Build service details section - different for deliveries vs services
            let serviceDetailsHtml = '';
            if (isDelivery) {
                serviceDetailsHtml = `
                    <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                        <div><span style="color: #6b7280; font-size: 12px;">Type</span><br><strong>üì¶ Delivery</strong></div>
                    </div>
                `;
            } else {
                serviceDetailsHtml = `
                    <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                        <div><span style="color: #6b7280; font-size: 12px;">Type</span><br><strong>${pod.serviceType || 'Service'}</strong></div>
                        <div><span style="color: #6b7280; font-size: 12px;">Carbsolve</span><br><strong>${carbsolveDisplay}</strong></div>
                        <div><span style="color: #6b7280; font-size: 12px;">Tank Serviced</span><br><strong>${pod.tankServiced === 'yes' ? 'Yes' : (pod.tankServiced === 'n/a' ? 'N/A' : 'No')}</strong></div>
                    </div>
                    ${pod.serviceNotes ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;"><strong>Service Notes:</strong> ${pod.serviceNotes}</div>` : ''}
                `;
            }
            
            existingView.style.display = 'block';
            existingView.innerHTML = `
                <div class="card" style="background: #f0fdf4; border: 2px solid #16a34a;">
                    <h3 style="color: #16a34a; margin-bottom: 12px;">‚úì POD Completed</h3>
                    <p style="color: #6b7280; font-size: 14px;">Completed: ${formatTimestamp(pod.timestamp)}</p>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 12px;">${isDelivery ? 'Delivery Details' : 'Service Details'}</h3>
                    ${serviceDetailsHtml}
                </div>

                ${pod.products && pod.products.length > 0 ? `
                    ${pod.products.filter(p => p.type !== 'repair').length > 0 ? `
                        <div class="card">
                            <h3 style="margin-bottom: 12px;">Products Delivered</h3>
                            ${pod.products.filter(p => p.type !== 'repair').map(p => `<div>‚Ä¢ ${p.product} x ${p.quantity}</div>`).join('')}
                        </div>
                    ` : ''}
                    ${pod.products.filter(p => p.type === 'repair').length > 0 ? `
                        <div class="card">
                            <h3 style="margin-bottom: 12px;">Repair Items</h3>
                            ${pod.products.filter(p => p.type === 'repair').map(p => `<div>‚Ä¢ ${p.product} x ${p.quantity}</div>`).join('')}
                        </div>
                    ` : ''}
                ` : ''}

                ${pod.notes ? `
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Notes</h3>
                        <p>${pod.notes}</p>
                    </div>
                ` : ''}

                ${pod.photo ? `
                    <div class="card">
                        <h3 style="margin-bottom: 12px;">Photo</h3>
                        <img src="${pod.photo}" style="max-width: 100%; border-radius: 8px;">
                    </div>
                ` : ''}

                <div class="card">
                    <h3 style="margin-bottom: 12px;">Customer Signature</h3>
                    ${pod.customerNotAvailable ? 
                        '<p style="color: #f59e0b;">‚ö†Ô∏è Customer not available - No signature obtained</p>' : 
                        pod.signature ? `<img src="${pod.signature}" style="max-width: 200px; border: 1px solid #d1d5db; border-radius: 4px;">` : 
                        '<p>No signature</p>'
                    }
                </div>

                <button class="btn" onclick="editExistingPod(${pod.id})">Edit POD</button>
                <button class="btn btn-secondary" onclick="backToCustomerList()">Back to List</button>
            `;
        }

        function editExistingPod(podId) {
            const pod = db.pods.find(p => p.id === podId);
            if (!pod) return;
            
            // Switch to edit mode - load POD data into form
            document.getElementById('podForm').style.display = 'block';
            document.getElementById('existingPodView').style.display = 'none';
            
            // Display service type from the POD (for ad-hoc this might differ from customer's default)
            const podServiceType = pod.serviceType || currentCustomer.serviceType || 'Service';
            const isDelivery = podServiceType === 'Delivery';
            document.getElementById('podServiceTypeDisplay').textContent = podServiceType;
            
            // Hide carbsolve for deliveries
            const carbsolveContainer = document.getElementById('podCarbsolveContainer');
            if (carbsolveContainer) {
                carbsolveContainer.style.display = isDelivery ? 'none' : 'block';
            }
            
            const customerCarbsolve = currentCustomer.carbsolve || '-';
            document.getElementById('podCarbsolveDisplay').textContent = customerCarbsolve;
            
            // Display waste if applicable
            const wasteContainer = document.getElementById('podWasteContainer');
            if (currentCustomer.waste) {
                wasteContainer.style.display = 'block';
            } else {
                wasteContainer.style.display = 'none';
            }
            
            // Show/hide tank serviced section based on type
            const tankSection = document.getElementById('tankServicedSection');
            if (tankSection) {
                tankSection.style.display = isDelivery ? 'none' : 'block';
            }
            
            // Tank serviced - only set if not delivery
            if (!isDelivery && pod.tankServiced && pod.tankServiced !== 'n/a') {
                const tankRadio = document.querySelector(`input[name="tankServiced"][value="${pod.tankServiced}"]`);
                if (tankRadio) tankRadio.checked = true;
            }
            document.getElementById('serviceNotes').value = pod.serviceNotes || '';
            document.getElementById('notes').value = pod.notes || '';
            
            // Load products into separate sections (sale vs repair)
            const saleContainer = document.getElementById('productLines');
            const repairContainer = document.getElementById('repairLines');
            saleContainer.innerHTML = '';
            if (repairContainer) repairContainer.innerHTML = '';
            
            if (pod.products && pod.products.length > 0) {
                const saleProducts = pod.products.filter(p => p.type !== 'repair');
                const repairProducts = pod.products.filter(p => p.type === 'repair');
                
                // Load sale products
                saleProducts.forEach(product => {
                    const line = document.createElement('div');
                    line.className = 'product-line';
                    line.dataset.type = 'sale';
                    line.style.background = '#f0fdf4';
                    line.style.border = '2px solid #16a34a';
                    line.style.borderRadius = '6px';
                    line.style.padding = '8px';
                    line.dataset.confirmed = 'true';
                    line.innerHTML = `
                        <select class="product-select" disabled onchange="checkProductLineComplete(this)">
                            ${getProductOptionsHtml('sale')}
                        </select>
                        <input type="number" class="product-quantity" disabled placeholder="Qty" min="0" value="${product.quantity}" onchange="checkProductLineComplete(this)">
                        <button type="button" class="product-confirm-btn" disabled style="background: #16a34a; cursor: default;">Locked ‚úì</button>
                        <button type="button" onclick="removeProductLine(this)">Remove</button>
                    `;
                    // Set selected value
                    line.querySelector('.product-select').value = product.product;
                    saleContainer.appendChild(line);
                });
                
                // Load repair products
                if (repairContainer) {
                    repairProducts.forEach(product => {
                        const line = document.createElement('div');
                        line.className = 'product-line';
                        line.dataset.type = 'repair';
                        line.style.background = '#f0fdf4';
                        line.style.border = '2px solid #16a34a';
                        line.style.borderRadius = '6px';
                        line.style.padding = '8px';
                        line.dataset.confirmed = 'true';
                        line.innerHTML = `
                            <select class="product-select" disabled onchange="checkProductLineComplete(this)">
                                ${getProductOptionsHtml('repair')}
                            </select>
                            <input type="number" class="product-quantity" disabled placeholder="Qty" min="0" value="${product.quantity}" onchange="checkProductLineComplete(this)">
                            <button type="button" class="product-confirm-btn" disabled style="background: #16a34a; cursor: default;">Locked ‚úì</button>
                            <button type="button" onclick="removeProductLine(this)">Remove</button>
                        `;
                        // Set selected value
                        line.querySelector('.product-select').value = product.product;
                        repairContainer.appendChild(line);
                    });
                }
                
                // Add empty lines if needed
                if (saleProducts.length === 0) {
                    addProductLine('sale');
                }
                if (repairContainer && repairProducts.length === 0) {
                    addProductLine('repair');
                }
            } else {
                renderProductLines();
            }
            
            // Load photo
            if (pod.photo) {
                const preview = document.getElementById('photoPreview');
                preview.src = pod.photo;
                preview.style.display = 'block';
                preview.dataset.compressed = pod.photo;
            }
            
            // Load signature
            if (pod.signature) {
                const canvas = signaturePad.canvas;
                const ctx = signaturePad.ctx;
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                    signaturePad.isEmpty = false;
                };
                img.src = pod.signature;
            }
            
            document.getElementById('customerNotAvailable').checked = pod.customerNotAvailable || false;
            toggleSignatureRequirement();
            
            // Store the POD ID so we know we're editing
            currentEditingPodId = pod.id;
            currentEditingServiceType = pod.serviceType || 'Service';
        }

        let currentEditingPodId = null;
        let currentEditingServiceType = null;

        function showAdminPanelView() {
            showView('adminView');
            renderCustomerAdminList();
            renderProductAdminList();
            renderServiceDayAdminList();
        }

        async function showAdminDashboard() {
            showView('adminDashboardView');
            populateAdminServiceDaySelect();
            updatePeriodDisplay();
            await refreshForPeriod();
        }
        
        function showAdminCalendarView() {
            document.getElementById('adminCalendarContainer').style.display = 'block';
            document.getElementById('adminListContainer').style.display = 'none';
            document.getElementById('adminRunsheetContainer').style.display = 'none';
            document.getElementById('bimonthlyContainer').style.display = 'none';
            document.getElementById('calendarViewTab').classList.add('active');
            document.getElementById('listViewTab').classList.remove('active');
            document.getElementById('bimonthlyViewTab').classList.remove('active');
            renderAdminCalendar();
        }
        
        function showAdminListView() {
            document.getElementById('adminCalendarContainer').style.display = 'none';
            document.getElementById('adminListContainer').style.display = 'block';
            document.getElementById('bimonthlyContainer').style.display = 'none';
            document.getElementById('calendarViewTab').classList.remove('active');
            document.getElementById('listViewTab').classList.add('active');
            document.getElementById('bimonthlyViewTab').classList.remove('active');
        }
        
        let bimonthlyFilter = 'all';
        
        function showBimonthlyView() {
            document.getElementById('adminCalendarContainer').style.display = 'none';
            document.getElementById('adminListContainer').style.display = 'none';
            document.getElementById('adminRunsheetContainer').style.display = 'none';
            document.getElementById('bimonthlyContainer').style.display = 'block';
            document.getElementById('calendarViewTab').classList.remove('active');
            document.getElementById('listViewTab').classList.remove('active');
            document.getElementById('bimonthlyViewTab').classList.add('active');
            renderBimonthlyList();
        }
        
        function filterBimonthlyView(filter) {
            bimonthlyFilter = filter;
            // Update button states
            ['all', 'odd', 'even', 'quarterly', 'custom'].forEach(f => {
                const btn = document.getElementById('biFilter' + f.charAt(0).toUpperCase() + f.slice(1));
                if (btn) {
                    btn.style.background = (f === filter) ? '#1e3a5f' : '#e5e7eb';
                    btn.style.color = (f === filter) ? 'white' : '#374151';
                }
            });
            renderBimonthlyList();
        }
        
        function renderBimonthlyList() {
            const container = document.getElementById('bimonthlyList');
            const bimonthlyCustomers = db.customers.filter(c => c.serviceMonths && c.serviceMonths.length > 0);
            
            // Apply filter
            let filtered = bimonthlyCustomers;
            if (bimonthlyFilter === 'odd') {
                filtered = bimonthlyCustomers.filter(c => c.serviceMonths.every(m => m % 2 === 1));
            } else if (bimonthlyFilter === 'even') {
                filtered = bimonthlyCustomers.filter(c => c.serviceMonths.every(m => m % 2 === 0));
            } else if (bimonthlyFilter === 'quarterly') {
                filtered = bimonthlyCustomers.filter(c => c.serviceMonths.length <= 4);
            } else if (bimonthlyFilter === 'custom') {
                // Custom = not standard odd/even/quarterly patterns
                filtered = bimonthlyCustomers.filter(c => {
                    const isOdd = c.serviceMonths.every(m => m % 2 === 1);
                    const isEven = c.serviceMonths.every(m => m % 2 === 0);
                    const isQuarterly = c.serviceMonths.length === 4;
                    return !isOdd && !isEven && !isQuarterly;
                });
            }
            
            // Sort by run day then name
            filtered.sort((a, b) => {
                const dayA = a.runDay || 'ZZZ';
                const dayB = b.runDay || 'ZZZ';
                if (dayA !== dayB) return dayA.localeCompare(dayB, undefined, {numeric: true});
                return a.name.localeCompare(b.name);
            });
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 24px;">No customers match this filter.</p>';
                return;
            }
            
            const currentMonth = selectedMonth + 1; // 1-indexed for display
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: #f3f4f6; text-align: left;">
                            <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Run Day</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Customer</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Schedule Type</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e5e7eb;">Service Months</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e5e7eb; text-align: center;">${MONTH_NAMES[selectedMonth]} Status</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e5e7eb; text-align: center;">Edit</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filtered.forEach(customer => {
                const scheduleType = getScheduleLabel(customer.serviceMonths);
                const months = formatServiceMonths(customer.serviceMonths);
                const isActive = customer.serviceMonths.includes(currentMonth);
                
                html += `
                    <tr style="border-bottom: 1px solid #e5e7eb; ${isActive ? '' : 'background: #fefce8;'}">
                        <td style="padding: 12px;">${customer.runDay || '-'}</td>
                        <td style="padding: 12px; font-weight: 500;">${customer.name}</td>
                        <td style="padding: 12px;">
                            <span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 10px; font-size: 12px;">
                                ${scheduleType}
                            </span>
                        </td>
                        <td style="padding: 12px; font-size: 12px; color: #6b7280;">${months}</td>
                        <td style="padding: 12px; text-align: center;">
                            ${isActive 
                                ? '<span style="color: #16a34a; font-weight: 600;">‚úì Active</span>' 
                                : '<span style="color: #9ca3af;">‚è∏Ô∏è Off Month</span>'
                            }
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="showCustomerEditModal(${customer.id})" 
                                    style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; padding: 6px 12px; cursor: pointer;">
                                ‚úèÔ∏è Edit
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <p style="margin-top: 16px; font-size: 13px; color: #6b7280;">
                    Showing ${filtered.length} of ${bimonthlyCustomers.length} bi-monthly/quarterly customers
                </p>
            `;
            
            container.innerHTML = html;
        }
        
        function renderAdminCalendar() {
            const grid = document.getElementById('adminCalendarGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // Get today for highlighting
            const today = new Date();
            const todayStr = formatDateLocal(today);
            
            // Group PODs by date
            const podsByDate = {};
            db.pods.forEach(pod => {
                if (!podsByDate[pod.date]) {
                    podsByDate[pod.date] = [];
                }
                podsByDate[pod.date].push(pod);
            });
            
            if (calendarPeriod === 'week') {
                // Render Monday through Friday of selected week
                for (let i = 0; i < 5; i++) {
                    const date = new Date(selectedWeekStart);
                    date.setDate(date.getDate() + i);
                    const cell = createCalendarDayCell(date, podsByDate, false, todayStr);
                    grid.appendChild(cell);
                }
            } else {
                // Render full month view
                const firstDay = new Date(selectedYear, selectedMonth, 1);
                const lastDay = new Date(selectedYear, selectedMonth + 1, 0);
                const totalDays = lastDay.getDate();
                const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
                
                // Add empty cells for days before the 1st
                for (let i = 0; i < startDayOfWeek; i++) {
                    const prevMonthDay = new Date(selectedYear, selectedMonth, 0 - (startDayOfWeek - i - 1));
                    const cell = createCalendarDayCell(prevMonthDay, podsByDate, true, todayStr);
                    grid.appendChild(cell);
                }
                
                // Add days of the month
                for (let day = 1; day <= totalDays; day++) {
                    const date = new Date(selectedYear, selectedMonth, day);
                    const cell = createCalendarDayCell(date, podsByDate, false, todayStr);
                    grid.appendChild(cell);
                }
                
                // Add empty cells for days after the last day to complete the grid
                const endDayOfWeek = lastDay.getDay();
                for (let i = endDayOfWeek + 1; i <= 6; i++) {
                    const nextMonthDay = new Date(selectedYear, selectedMonth + 1, i - endDayOfWeek);
                    const cell = createCalendarDayCell(nextMonthDay, podsByDate, true, todayStr);
                    grid.appendChild(cell);
                }
            }
        }
        
        function createCalendarDayCell(date, podsByDate, isOtherMonth, todayStr) {
            const dateStr = formatDateLocal(date);
            const isToday = dateStr === todayStr;
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const cell = document.createElement('div');
            cell.className = `calendar-day${isOtherMonth ? ' other-month' : ''}${isToday ? ' today' : ''}`;
            
            // Day header - different format for week vs month view
            const dayNum = document.createElement('div');
            dayNum.className = 'calendar-day-number';
            
            if (calendarPeriod === 'week') {
                // Week view: "Mon 13 Jan"
                dayNum.textContent = `${dayNames[date.getDay()]} ${date.getDate()} ${monthNames[date.getMonth()]}`;
            } else {
                // Month view: just the number
                dayNum.textContent = date.getDate();
            }
            cell.appendChild(dayNum);
            
            // Service days container
            const serviceDaysContainer = document.createElement('div');
            serviceDaysContainer.className = 'calendar-service-days';
            
            // Get PODs for this date
            const podsOnDate = podsByDate[dateStr] || [];
            
            // Group PODs by service day
            const serviceDayPods = {};
            podsOnDate.forEach(pod => {
                const runDay = pod.runDay || 'Ad-Hoc';
                if (!serviceDayPods[runDay]) {
                    serviceDayPods[runDay] = [];
                }
                serviceDayPods[runDay].push(pod);
            });
            
            // Get scheduled service days for this date (from Google Calendar sync)
            const scheduledOnDate = db.scheduledDays.filter(sd => sd.scheduledDate === dateStr);
            
            // Only show SCHEDULED service days on calendar
            // Plus any "Ad-Hoc" items from main menu
            const allServiceDays = new Set();
            scheduledOnDate.forEach(sd => allServiceDays.add(sd.serviceDayName));
            
            // Check for truly ad-hoc items (from main menu, not from a runsheet)
            // These have runDay = 'Ad-Hoc' and sourceRunDay = null
            const trulyAdHocPods = podsOnDate.filter(p => p.runDay === 'Ad-Hoc' && !p.sourceRunDay);
            const trulyAdHocTankMoves = db.tankMovements.filter(tm => 
                tm.date === dateStr && tm.runDay === 'Ad-Hoc' && !tm.sourceRunDay
            );
            
            if (trulyAdHocPods.length > 0 || trulyAdHocTankMoves.length > 0) {
                allServiceDays.add('Ad-Hoc');
            }
            
            // Render each service day
            allServiceDays.forEach(runDay => {
                const pods = serviceDayPods[runDay] || [];
                const scheduledDay = scheduledOnDate.find(sd => sd.serviceDayName === runDay);
                
                // For Ad-Hoc, count only truly ad-hoc items
                let completedCount, totalCustomers;
                if (runDay === 'Ad-Hoc') {
                    completedCount = trulyAdHocPods.length + trulyAdHocTankMoves.length;
                    totalCustomers = 0; // No scheduled total for ad-hoc
                } else {
                    completedCount = pods.length;
                    totalCustomers = db.customers.filter(c => c.runDay === runDay).length;
                }
                
                // Check if this service day is invoiced
                const isInvoiced = db.isServiceDayInvoiced(runDay, dateStr);
                
                // Get employee color class - special case for Ad-Hoc
                const calendarOwner = scheduledDay?.calendarOwner || '';
                const employeeClass = runDay === 'Ad-Hoc' ? 'employee-adhoc' : ('employee-' + calendarOwner.toLowerCase().replace(/[^a-z]/g, ''));
                
                const serviceDayEl = document.createElement('div');
                serviceDayEl.className = `calendar-service-day ${employeeClass || 'employee-unknown'}${isInvoiced ? ' invoiced' : ''}`;
                
                // Special styling for Ad-Hoc
                if (runDay === 'Ad-Hoc') {
                    serviceDayEl.style.background = '#fef3c7';
                    serviceDayEl.style.borderLeftColor = '#f59e0b';
                }
                
                // Show different info based on whether it's scheduled vs just has PODs
                if (scheduledDay || completedCount > 0) {
                    const invoicedTick = isInvoiced ? '<span style="color: #16a34a; margin-right: 4px;">‚úì</span>' : '';
                    serviceDayEl.innerHTML = `${invoicedTick}<span class="pod-count">${runDay}</span> (${completedCount}${totalCustomers > 0 ? '/' + totalCustomers : ''})`;
                }
                
                serviceDayEl.onclick = (e) => {
                    e.stopPropagation();
                    openRunsheetForDate(runDay, dateStr);
                };
                serviceDaysContainer.appendChild(serviceDayEl);
            });
            
            cell.appendChild(serviceDaysContainer);
            return cell;
        }
        
        async function openRunsheetForDate(runDay, dateStr) {
            // Set the service day select
            const select = document.getElementById('adminServiceDaySelect');
            
            // For Ad-Hoc, add it as a temporary option if not present
            if (runDay === 'Ad-Hoc') {
                let adHocOption = select.querySelector('option[value="Ad-Hoc"]');
                if (!adHocOption) {
                    adHocOption = document.createElement('option');
                    adHocOption.value = 'Ad-Hoc';
                    adHocOption.textContent = 'üìã Ad-Hoc Services';
                    select.appendChild(adHocOption);
                }
            }
            
            select.value = runDay;
            
            // Show list view with runsheet
            document.getElementById('adminCalendarContainer').style.display = 'none';
            document.getElementById('adminListContainer').style.display = 'block';
            document.getElementById('calendarViewTab').classList.remove('active');
            document.getElementById('listViewTab').classList.add('active');
            
            // For Ad-Hoc, we skip the normal date population and just show the date
            if (runDay === 'Ad-Hoc') {
                const dateSelect = document.getElementById('adminDateSelect');
                dateSelect.innerHTML = `<option value="${dateStr}">${formatDisplayDate(dateStr)}</option>`;
                dateSelect.value = dateStr;
                currentAdminDateFilter = dateStr;
                loadAdminAdHocRunsheet(dateStr);
            } else {
                // Populate the date dropdown and set the date
                await onServiceDaySelectChange();
                
                const dateSelect = document.getElementById('adminDateSelect');
                dateSelect.value = dateStr;
                
                // Store the date filter for the runsheet
                currentAdminDateFilter = dateStr;
                
                // Load the runsheet
                loadAdminRunsheet();
            }
        }
        
        // Track date filter for admin runsheet
        let currentAdminDateFilter = null;

        function showExportView() {
            showView('exportView');
            populateExportServiceDayFilter();
            filterPODs();
        }

        function backToCustomerList() {
            // If this was an ad-hoc service creation, go back to home
            if (isAdHocService) {
                isAdHocService = false;
                adHocCustomerName = '';
                adHocServiceType = 'Service';
                showHomeView();
            } else if (returnToRunDay) {
                // If we came from viewing a POD on a specific runsheet, go back there
                const targetRunDay = returnToRunDay;
                returnToRunDay = null;
                showCustomerListView(targetRunDay);
                renderRunDays();
            } else if (currentRunDay === 'Ad-Hoc') {
                // Viewing an ad-hoc POD but no specific runsheet to return to
                showHomeView();
            } else {
                showCustomerListView(currentRunDay);
                renderRunDays(); // Also refresh the home screen run day cards
            }
        }
        
        // Track which runsheet to return to after viewing a POD
        let returnToRunDay = null;

        // Render service days (replaces renderRunDays)
        let currentSelectedWorker = localStorage.getItem('selectedWorker') || '';
        
        function getUniqueWorkers() {
            const workers = new Set();
            db.serviceDays.forEach(sd => {
                if (sd.employee && sd.employee.trim()) {
                    workers.add(sd.employee.trim());
                }
            });
            // Always include Matt (does ad-hoc services, not regular service days)
            workers.add('Matt');
            return Array.from(workers).sort();
        }
        
        function populateWorkerSelect() {
            const select = document.getElementById('workerSelect');
            const workers = getUniqueWorkers();
            
            // Keep current selection
            const currentValue = select.value || currentSelectedWorker;
            
            select.innerHTML = '<option value="">All Workers</option>';
            workers.forEach(worker => {
                const option = document.createElement('option');
                option.value = worker;
                option.textContent = worker;
                select.appendChild(option);
            });
            
            // Restore selection if valid
            if (currentValue && workers.includes(currentValue)) {
                select.value = currentValue;
            } else if (currentSelectedWorker && workers.includes(currentSelectedWorker)) {
                select.value = currentSelectedWorker;
            }
        }
        
        async function handleWorkerChange() {
            const select = document.getElementById('workerSelect');
            currentSelectedWorker = select.value;
            localStorage.setItem('selectedWorker', currentSelectedWorker);
            renderRunDays();
            await loadWorkerCalendarEvents();
        }
        
        let workerCalendarView = 'week'; // 'week' or 'list'
        let workerWeekStart = getMondayOfWeek(new Date()); // Track which week we're viewing
        let workerPeriod = 'week'; // 'week' or 'month' - for the top selector
        let workerMonthYear = { month: new Date().getMonth(), year: new Date().getFullYear() };
        
        // Worker period functions (for top selector)
        function setWorkerPeriod(period) {
            workerPeriod = period;
            document.getElementById('workerWeekPeriodBtn').classList.toggle('active', period === 'week');
            document.getElementById('workerMonthPeriodBtn').classList.toggle('active', period === 'month');
            updateWorkerPeriodDisplay();
            loadWorkerCalendarEvents();
            renderRunDays(); // Update service day tiles for new period
        }
        
        function navigateWorkerPeriod(delta) {
            if (workerPeriod === 'week') {
                workerWeekStart = new Date(workerWeekStart);
                workerWeekStart.setDate(workerWeekStart.getDate() + (delta * 7));
            } else {
                workerMonthYear.month += delta;
                if (workerMonthYear.month > 11) {
                    workerMonthYear.month = 0;
                    workerMonthYear.year++;
                } else if (workerMonthYear.month < 0) {
                    workerMonthYear.month = 11;
                    workerMonthYear.year--;
                }
            }
            updateWorkerPeriodDisplay();
            loadWorkerCalendarEvents();
            renderRunDays(); // Update service day tiles for new period
        }
        
        function goToWorkerCurrentPeriod() {
            if (workerPeriod === 'week') {
                workerWeekStart = getMondayOfWeek(new Date());
            } else {
                const now = new Date();
                workerMonthYear = { month: now.getMonth(), year: now.getFullYear() };
            }
            updateWorkerPeriodDisplay();
            loadWorkerCalendarEvents();
            renderRunDays(); // Update service day tiles for current period
        }
        
        function updateWorkerPeriodDisplay() {
            const periodDisplay = document.getElementById('workerPeriodDisplay');
            const yearDisplay = document.getElementById('workerYearDisplay');
            const todayBtn = document.getElementById('workerTodayBtnTop');
            
            if (!periodDisplay || !yearDisplay) return;
            
            const now = new Date();
            let isCurrentPeriod = false;
            
            if (workerPeriod === 'week') {
                const friday = new Date(workerWeekStart);
                friday.setDate(friday.getDate() + 4);
                
                const startMonth = MONTH_NAMES[workerWeekStart.getMonth()].substring(0, 3);
                const endMonth = MONTH_NAMES[friday.getMonth()].substring(0, 3);
                const startDay = workerWeekStart.getDate();
                const endDay = friday.getDate();
                
                let displayText;
                if (workerWeekStart.getMonth() === friday.getMonth()) {
                    displayText = `${startMonth} ${startDay} - ${endDay}`;
                } else {
                    displayText = `${startMonth} ${startDay} - ${endMonth} ${endDay}`;
                }
                
                periodDisplay.textContent = displayText;
                yearDisplay.textContent = workerWeekStart.getFullYear();
                
                const currentMonday = getMondayOfWeek(now);
                isCurrentPeriod = formatDateLocal(workerWeekStart) === formatDateLocal(currentMonday);
            } else {
                periodDisplay.textContent = MONTH_NAMES[workerMonthYear.month];
                yearDisplay.textContent = workerMonthYear.year;
                isCurrentPeriod = workerMonthYear.month === now.getMonth() && workerMonthYear.year === now.getFullYear();
            }
            
            if (todayBtn) {
                todayBtn.style.display = isCurrentPeriod ? 'none' : 'inline-block';
            }
        }
        
        function navigateWorkerWeek(delta) {
            workerWeekStart = new Date(workerWeekStart);
            workerWeekStart.setDate(workerWeekStart.getDate() + (delta * 7));
            updateWorkerPeriodDisplay();
            loadWorkerCalendarEvents();
            renderRunDays(); // Update service day tiles for new week
        }
        
        function goToWorkerCurrentWeek() {
            workerWeekStart = getMondayOfWeek(new Date());
            updateWorkerPeriodDisplay();
            loadWorkerCalendarEvents();
            renderRunDays(); // Update service day tiles for current week
        }
        
        function updateWorkerWeekLabel() {
            // Now handled by updateWorkerPeriodDisplay
            updateWorkerPeriodDisplay();
        }
        
        function setWorkerCalendarView(view) {
            workerCalendarView = view;
            document.getElementById('workerWeekViewBtn').classList.toggle('active', view === 'week');
            document.getElementById('workerListViewBtn').classList.toggle('active', view === 'list');
            document.getElementById('workerWeekView').style.display = view === 'week' ? 'block' : 'none';
            document.getElementById('workerListView').style.display = view === 'list' ? 'block' : 'none';
        }
        
        async function loadWorkerCalendarEvents() {
            const eventsContainer = document.getElementById('workerCalendarEvents');
            
            try {
                const today = new Date();
                const todayStr = formatDateLocal(today);
                let startDate, endDate, monday;
                
                if (workerPeriod === 'week') {
                    // Get the selected week's date range (Mon-Fri) using workerWeekStart
                    monday = new Date(workerWeekStart);
                    const friday = new Date(monday);
                    friday.setDate(friday.getDate() + 4);
                    
                    startDate = formatDateLocal(monday);
                    endDate = formatDateLocal(friday);
                } else {
                    // Month view - get full month
                    const firstDay = new Date(workerMonthYear.year, workerMonthYear.month, 1);
                    const lastDay = new Date(workerMonthYear.year, workerMonthYear.month + 1, 0);
                    
                    startDate = formatDateLocal(firstDay);
                    endDate = formatDateLocal(lastDay);
                    monday = firstDay; // Used for rendering
                }
                
                // Update the period display
                updateWorkerPeriodDisplay();
                
                // Fetch calendar events - for all workers if none selected, or specific worker
                let query = supabase
                    .from('worker_calendar_events')
                    .select('*')
                    .gte('event_date', startDate)
                    .lte('event_date', endDate)
                    .order('event_date', { ascending: true });
                
                // Filter by worker if one is selected
                if (currentSelectedWorker) {
                    query = query.eq('calendar_owner', currentSelectedWorker);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                // Group by date
                const byDate = {};
                if (data) {
                    data.forEach(event => {
                        if (!byDate[event.event_date]) {
                            byDate[event.event_date] = [];
                        }
                        byDate[event.event_date].push(event);
                    });
                }
                
                // Update grid styling based on period
                const weekHeader = document.getElementById('workerWeekHeader');
                const weekGrid = document.getElementById('workerWeekGrid');
                
                if (workerPeriod === 'month') {
                    weekHeader.style.gridTemplateColumns = 'repeat(7, 1fr)';
                    weekHeader.innerHTML = `
                        <div class="calendar-header-cell">Sun</div>
                        <div class="calendar-header-cell">Mon</div>
                        <div class="calendar-header-cell">Tue</div>
                        <div class="calendar-header-cell">Wed</div>
                        <div class="calendar-header-cell">Thu</div>
                        <div class="calendar-header-cell">Fri</div>
                        <div class="calendar-header-cell">Sat</div>
                    `;
                    renderWorkerMonthView(byDate, todayStr);
                } else {
                    // Reset to week view styling
                    weekHeader.style.gridTemplateColumns = 'repeat(5, 1fr)';
                    weekGrid.className = '';
                    weekGrid.style.display = 'grid';
                    weekGrid.style.gridTemplateColumns = 'repeat(5, 1fr)';
                    weekGrid.style.gap = '1px';
                    weekGrid.style.background = '#e2e8f0';
                    renderWorkerWeekView(monday, byDate, todayStr);
                }
                
                // Render list view
                renderWorkerListView(byDate, todayStr);
                
                eventsContainer.style.display = 'block';
                
            } catch (e) {
                console.error('Error loading worker calendar events:', e);
                // Fallback to scheduled_service_days
                await loadWorkerCalendarEventsFallback();
            }
        }
        
        function renderWorkerWeekView(monday, byDate, todayStr) {
            const headerEl = document.getElementById('workerWeekHeader');
            const gridEl = document.getElementById('workerWeekGrid');
            
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Build header
            let headerHtml = '';
            for (let i = 0; i < 5; i++) {
                const date = new Date(monday);
                date.setDate(date.getDate() + i);
                const dateStr = formatDateLocal(date);
                const isToday = dateStr === todayStr;
                
                headerHtml += `
                    <div style="padding: 10px 8px; text-align: center; font-weight: 600; font-size: 12px; overflow: hidden; ${isToday ? 'background: #3b82f6;' : ''}">
                        ${dayNames[i]} ${date.getDate()} ${monthNames[date.getMonth()]}
                    </div>
                `;
            }
            headerEl.innerHTML = headerHtml;
            
            // Build grid
            let gridHtml = '';
            for (let i = 0; i < 5; i++) {
                const date = new Date(monday);
                date.setDate(date.getDate() + i);
                const dateStr = formatDateLocal(date);
                const isToday = dateStr === todayStr;
                const isPast = dateStr < todayStr;
                const events = byDate[dateStr] || [];
                
                gridHtml += `
                    <div style="background: ${isToday ? '#eff6ff' : 'white'}; min-height: 150px; padding: 8px; ${isToday ? 'box-shadow: inset 0 0 0 2px #3b82f6;' : ''} overflow: hidden;">
                `;
                
                if (events.length === 0) {
                    gridHtml += `<p style="color: #9ca3af; font-size: 12px; text-align: center; margin-top: 20px;">No events</p>`;
                } else {
                    events.forEach(event => {
                        const isServiceDay = event.is_service_day;
                        const icon = isServiceDay ? 'üöõ' : 'üìã';
                        // Use event's calendar_owner for color when showing all workers
                        const eventWorker = currentSelectedWorker || event.calendar_owner || '';
                        const bgColor = isServiceDay ? getWorkerColorLight(eventWorker) : '#f3f4f6';
                        const borderColor = isServiceDay ? getWorkerColor(eventWorker) : '#d1d5db';
                        const clickable = isServiceDay;
                        // Show worker name when viewing all workers
                        const showWorkerName = !currentSelectedWorker && event.calendar_owner;
                        
                        gridHtml += `
                            <div onclick="${clickable ? `openWorkerRunsheet('${event.service_day_name}', '${dateStr}')` : ''}" 
                                 style="display: flex; align-items: flex-start; gap: 6px; padding: 8px; background: ${bgColor}; 
                                        border-radius: 6px; margin-bottom: 6px; border-left: 3px solid ${borderColor};
                                        ${clickable ? 'cursor: pointer;' : ''} transition: transform 0.1s; overflow: hidden;"
                                 ${clickable ? 'onmouseover="this.style.transform=\'scale(1.02)\'" onmouseout="this.style.transform=\'scale(1)\'"' : ''}>
                                <span style="font-size: 14px; flex-shrink: 0;">${icon}</span>
                                <div style="flex: 1; min-width: 0; overflow: hidden;">
                                    <div style="font-weight: 600; font-size: 12px; color: #1e3a5f; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${event.service_day_name || event.event_title}</div>
                                    ${showWorkerName ? `<div style="font-size: 10px; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üë§ ${event.calendar_owner}</div>` : ''}
                                    ${isServiceDay && event.event_title !== event.service_day_name ? `<div style="font-size: 10px; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${event.event_title}</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                gridHtml += '</div>';
            }
            gridEl.innerHTML = gridHtml;
        }
        
        function renderWorkerMonthView(byDate, todayStr) {
            const gridEl = document.getElementById('workerWeekGrid');
            const headerEl = document.getElementById('workerWeekHeader');
            
            // Apply month-view CSS classes
            gridEl.className = 'calendar-grid month-view';
            headerEl.className = 'calendar-header show month-view';
            headerEl.style.display = 'grid';
            headerEl.style.background = '#374151';
            headerEl.style.color = 'white';
            
            const firstDay = new Date(workerMonthYear.year, workerMonthYear.month, 1);
            const lastDay = new Date(workerMonthYear.year, workerMonthYear.month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayOfWeek = firstDay.getDay(); // 0 = Sunday
            
            let gridHtml = '';
            
            // Add empty cells for days before first of month
            for (let i = 0; i < startDayOfWeek; i++) {
                const prevMonthDay = new Date(workerMonthYear.year, workerMonthYear.month, 0 - (startDayOfWeek - i - 1));
                gridHtml += createWorkerCalendarDayHtml(prevMonthDay, byDate, true, todayStr);
            }
            
            // Add cells for each day of month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(workerMonthYear.year, workerMonthYear.month, day);
                gridHtml += createWorkerCalendarDayHtml(date, byDate, false, todayStr);
            }
            
            // Add empty cells after last day to complete the grid
            const endDayOfWeek = lastDay.getDay();
            for (let i = endDayOfWeek + 1; i <= 6; i++) {
                const nextMonthDay = new Date(workerMonthYear.year, workerMonthYear.month + 1, i - endDayOfWeek);
                gridHtml += createWorkerCalendarDayHtml(nextMonthDay, byDate, true, todayStr);
            }
            
            gridEl.innerHTML = gridHtml;
        }
        
        function createWorkerCalendarDayHtml(date, byDate, isOtherMonth, todayStr) {
            const dateStr = formatDateLocal(date);
            const isToday = dateStr === todayStr;
            const events = byDate[dateStr] || [];
            
            let classes = 'calendar-day';
            if (isOtherMonth) classes += ' other-month';
            if (isToday) classes += ' today';
            
            let html = `<div class="${classes}">`;
            
            // Day number
            html += `<div class="calendar-day-number">${date.getDate()}</div>`;
            
            // Events/service days container
            html += `<div class="calendar-service-days">`;
            
            // Show events (limit to first 4, show +N more if more)
            const maxEvents = 4;
            events.slice(0, maxEvents).forEach(event => {
                const isServiceDay = event.is_service_day;
                const eventWorker = event.calendar_owner || '';
                const employeeClass = 'employee-' + eventWorker.toLowerCase().replace(/[^a-z]/g, '');
                const clickable = isServiceDay;
                
                html += `
                    <div class="calendar-service-day ${employeeClass}"
                         onclick="${clickable ? `openWorkerRunsheet('${event.service_day_name}', '${dateStr}')` : ''}"
                         style="${clickable ? 'cursor: pointer;' : ''}"
                         title="${event.event_title || ''}">
                        <span class="pod-count">${event.event_title || event.service_day_name}</span>
                    </div>
                `;
            });
            
            if (events.length > maxEvents) {
                html += `<div style="font-size: 10px; color: #6b7280; padding: 2px;">+${events.length - maxEvents} more</div>`;
            }
            
            html += '</div></div>';
            return html;
        }
        
        function renderWorkerListView(byDate, todayStr) {
            const eventsList = document.getElementById('workerEventsList');
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            if (Object.keys(byDate).length === 0) {
                eventsList.innerHTML = '<p style="color: #6b7280; font-size: 13px;">No events scheduled for this week.</p>';
                return;
            }
            
            let html = '';
            Object.keys(byDate).sort().forEach(dateStr => {
                const date = new Date(dateStr + 'T00:00:00');
                const dayName = dayNames[date.getDay()];
                const dayNum = date.getDate();
                const isToday = dateStr === todayStr;
                
                html += `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 600; font-size: 12px; color: ${isToday ? '#1e3a5f' : '#6b7280'}; margin-bottom: 6px; ${isToday ? 'background: #dbeafe; padding: 4px 8px; border-radius: 4px;' : ''}">
                            ${isToday ? '‚≠ê TODAY - ' : ''}${dayName} ${dayNum}
                        </div>
                `;
                
                byDate[dateStr].forEach(event => {
                    const isServiceDay = event.is_service_day;
                    const icon = isServiceDay ? 'üöõ' : 'üìã';
                    const bgColor = isServiceDay ? 'white' : '#f8fafc';
                    // Use event's calendar_owner for color when showing all workers
                    const eventWorker = currentSelectedWorker || event.calendar_owner || '';
                    const showWorkerName = !currentSelectedWorker && event.calendar_owner;
                    
                    html += `
                        <div onclick="${isServiceDay ? `openWorkerRunsheet('${event.service_day_name}', '${dateStr}')` : ''}"
                             style="display: flex; align-items: center; gap: 8px; padding: 8px; background: ${bgColor}; border-radius: 6px; margin-bottom: 4px; margin-left: 12px; border-left: 3px solid ${getWorkerColor(eventWorker)}; ${isServiceDay ? 'cursor: pointer;' : ''}">
                            <span>${icon}</span>
                            <div style="flex: 1;">
                                                <div style="font-weight: 500; font-size: 13px;">${event.service_day_name || event.event_title}</div>
                                                ${showWorkerName ? `<div style="font-size: 11px; color: #6b7280;">üë§ ${event.calendar_owner}</div>` : ''}
                                                ${isServiceDay && event.event_title !== event.service_day_name ? `<div style="font-size: 11px; color: #6b7280;">${event.event_title}</div>` : ''}
                                            </div>
                            ${isServiceDay ? '<span style="color: #6b7280; font-size: 12px;">‚Üí</span>' : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            eventsList.innerHTML = html;
        }
        
        function openWorkerRunsheet(serviceDayName, dateStr) {
            // Store the date we're working on
            currentServiceDate = dateStr;
            // Navigate to customer list for this service day
            showCustomerListView(serviceDayName);
        }
        
        function getWorkerColorLight(worker) {
            const colors = {
                'allan': '#dbeafe',
                'drew': '#dcfce7',
                'matt': '#fef3c7',
                'michael': '#f3e8ff',
                'red': '#fee2e2',
                'stephen': '#ccfbf1'
            };
            return (worker && colors[worker.toLowerCase()]) || '#f3f4f6';
        }
        
        async function loadWorkerCalendarEventsFallback() {
            const eventsContainer = document.getElementById('workerCalendarEvents');
            
            try {
                const today = new Date();
                const monday = new Date(workerWeekStart);
                const friday = new Date(monday);
                friday.setDate(friday.getDate() + 4);
                
                const startDate = formatDateLocal(monday);
                const endDate = formatDateLocal(friday);
                const todayStr = formatDateLocal(today);
                
                let query = supabase
                    .from('scheduled_service_days')
                    .select('*')
                    .gte('scheduled_date', startDate)
                    .lte('scheduled_date', endDate)
                    .order('scheduled_date', { ascending: true });
                
                // Filter by worker if one is selected
                if (currentSelectedWorker) {
                    query = query.eq('calendar_owner', currentSelectedWorker);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                // Convert to same format as worker_calendar_events
                const byDate = {};
                if (data) {
                    data.forEach(event => {
                        const dateStr = event.scheduled_date;
                        if (!byDate[dateStr]) {
                            byDate[dateStr] = [];
                        }
                        byDate[dateStr].push({
                            event_date: dateStr,
                            event_title: event.calendar_event_title,
                            is_service_day: true,
                            service_day_name: event.service_day_name,
                            calendar_owner: event.calendar_owner
                        });
                    });
                }
                
                // Render week view
                renderWorkerWeekView(monday, byDate, todayStr);
                
                // Render list view
                renderWorkerListView(byDate, todayStr);
                
                eventsContainer.style.display = 'block';
                
            } catch (e) {
                console.error('Fallback also failed:', e);
                eventsContainer.style.display = 'none';
            }
        }
        
        function getWorkerColor(worker) {
            const colors = {
                'allan': '#3b82f6',
                'drew': '#22c55e',
                'matt': '#f59e0b',
                'michael': '#a855f7',
                'red': '#ef4444',
                'stephen': '#14b8a6'
            };
            return (worker && colors[worker.toLowerCase()]) || '#6b7280';
        }
        
        async function renderRunDays() {
            const selector = document.getElementById('runDaySelector');
            const today = formatDateLocal(new Date());
            const noServiceDaysMsg = document.getElementById('noServiceDays');
            const workerDayCount = document.getElementById('workerDayCount');
            const monthProgressHeading = document.getElementById('monthProgressHeading');
            
            // Determine the month for counting completions based on the viewed week
            let countMonth, countYear;
            if (workerPeriod === 'week') {
                // For week view: if today is within the selected week, use today's month
                // This handles cross-month weeks (e.g., Mar 30 - Apr 3)
                const todayDate = new Date();
                const weekEnd = new Date(workerWeekStart);
                weekEnd.setDate(weekEnd.getDate() + 4); // Friday
                
                const todayStr = formatDateLocal(todayDate);
                const weekStartStr = formatDateLocal(workerWeekStart);
                const weekEndStr = formatDateLocal(weekEnd);
                
                if (todayStr >= weekStartStr && todayStr <= weekEndStr) {
                    // Today is within the viewed week - use today's month
                    countMonth = todayDate.getMonth();
                    countYear = todayDate.getFullYear();
                } else {
                    // Viewing a different week - use week start's month
                    countMonth = workerWeekStart.getMonth();
                    countYear = workerWeekStart.getFullYear();
                }
            } else {
                // Month view - use workerMonthYear
                countMonth = workerMonthYear.month;
                countYear = workerMonthYear.year;
            }
            
            // Check if we need to load PODs for a different month than what's currently loaded
            // This happens in cross-month weeks where progress month differs from week start month
            let progressPods = db.pods; // Default to existing PODs
            if (workerPeriod === 'week') {
                const weekStartMonth = workerWeekStart.getMonth();
                const weekStartYear = workerWeekStart.getFullYear();
                if (countMonth !== weekStartMonth || countYear !== weekStartYear) {
                    // Need to load PODs for the progress month
                    console.log(`Loading PODs for progress month: ${MONTH_NAMES[countMonth]} ${countYear}`);
                    progressPods = await db.loadPodsForSpecificMonth(countMonth, countYear);
                }
            }
            
            // Update the month progress heading
            if (monthProgressHeading) {
                monthProgressHeading.innerHTML = `<span style="font-weight: 600; color: #1e40af;">üìä ${MONTH_NAMES[countMonth]} ${countYear} Progress</span>`;
            }
            
            // Clean up any existing other-workers-section
            const existingOther = document.querySelector('.other-workers-section');
            if (existingOther) existingOther.remove();
            
            // Populate worker dropdown
            populateWorkerSelect();
            
            if (db.serviceDays.length === 0) {
                selector.innerHTML = '';
                noServiceDaysMsg.style.display = 'block';
                workerDayCount.style.display = 'none';
                return;
            }
            
            noServiceDaysMsg.style.display = 'none';
            selector.innerHTML = '';
            
            // Filter service days by selected worker
            let filteredDays = db.serviceDays;
            let otherDays = [];
            
            if (currentSelectedWorker) {
                filteredDays = db.serviceDays.filter(sd => 
                    sd.employee && sd.employee.trim().toLowerCase() === currentSelectedWorker.toLowerCase()
                );
                otherDays = db.serviceDays.filter(sd => 
                    !sd.employee || sd.employee.trim().toLowerCase() !== currentSelectedWorker.toLowerCase()
                );
                
                // Show count
                workerDayCount.style.display = 'block';
                workerDayCount.className = 'worker-day-count';
                workerDayCount.innerHTML = `<strong>${currentSelectedWorker}</strong> has ${filteredDays.length} service day${filteredDays.length !== 1 ? 's' : ''} assigned`;
            } else {
                workerDayCount.style.display = 'block';
                workerDayCount.className = 'worker-day-count all-workers';
                workerDayCount.innerHTML = `Showing all ${db.serviceDays.length} service days`;
            }
            
            // Render filtered days
            filteredDays.forEach(serviceDay => {
                selector.appendChild(createServiceDayCard(serviceDay, today, countMonth, countYear, progressPods));
            });
            
            // If worker selected and there are other days, show them in a separate section
            if (currentSelectedWorker && otherDays.length > 0) {
                const otherSection = document.createElement('div');
                otherSection.className = 'other-workers-section';
                otherSection.innerHTML = `
                    <div style="margin-top: 24px; margin-bottom: 12px; padding: 8px 12px; background: #fefce8; border-left: 4px solid #eab308; border-radius: 4px; text-align: center;">
                        <span style="font-weight: 600; color: #854d0e;">üìã Other Workers' Days (for covering)</span>
                    </div>
                `;
                
                const otherGrid = document.createElement('div');
                otherGrid.className = 'run-day-selector';
                otherGrid.style.marginTop = '12px';
                
                otherDays.forEach(serviceDay => {
                    otherGrid.appendChild(createServiceDayCard(serviceDay, today, countMonth, countYear, progressPods, true));
                });
                
                otherSection.appendChild(otherGrid);
                selector.parentElement.appendChild(otherSection);
            }
        }
        
        function createServiceDayCard(serviceDay, today, countMonth, countYear, progressPods, isOtherWorker = false) {
            const allCustomers = db.customers.filter(c => c.runDay === serviceDay.name);
            
            // Filter out skipped customers AND off-month customers for this month
            const activeCustomers = allCustomers.filter(c => 
                !db.isCustomerSkipped(c.id, countMonth, countYear) && 
                !isOffMonth(c, countMonth, countYear)
            );
            const skippedCount = allCustomers.filter(c => db.isCustomerSkipped(c.id, countMonth, countYear)).length;
            const offMonthCount = allCustomers.filter(c => 
                !db.isCustomerSkipped(c.id, countMonth, countYear) && 
                isOffMonth(c, countMonth, countYear)
            ).length;
            const excludedCount = skippedCount + offMonthCount;
            const count = activeCustomers.length;
            
            // Check if we're viewing a past month
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const isHistorical = countYear < currentYear || (countYear === currentYear && countMonth < currentMonth);
            
            // Count PODs completed in the specified month (only for active customers)
            // Use progressPods parameter which may be different from db.pods for cross-month weeks
            const completedCount = activeCustomers.filter(customer => 
                progressPods.some(pod => {
                    if (pod.customerId !== customer.id) return false;
                    const podDate = new Date(pod.date + 'T00:00:00');
                    return podDate.getMonth() === countMonth && podDate.getFullYear() === countYear;
                })
            ).length;
            
            const completionPercent = count > 0 ? Math.round((completedCount / count) * 100) : 0;
            const isFullyCompleted = count > 0 && completedCount === count;
            
            const card = document.createElement('div');
            card.className = `run-day-card ${isFullyCompleted ? 'completed' : ''}`;
            
            if (isOtherWorker) {
                card.style.opacity = '0.85';
            }
            
            // For historical months, add a subtle indicator
            if (isHistorical) {
                card.style.borderLeft = '4px solid #f59e0b';
            }
            
            const dateLine = serviceDay.date ? 
                `<div style="font-size: 12px; color: #6b7280; margin-top: 4px;">${formatServiceDate(serviceDay.date)}</div>` : '';
            
            const employeeLine = isOtherWorker && serviceDay.employee ? 
                `<div style="font-size: 11px; color: #9ca3af; margin-top: 2px;">üë§ ${serviceDay.employee}</div>` : '';
            
            // Different wording for historical view
            let statusText = isHistorical ? 
                `${completedCount}/${count} serviced` : 
                `${completedCount}/${count} completed`;
            
            // Add excluded indicator if any (skipped + off-month)
            if (excludedCount > 0) {
                const excludedLabel = skippedCount > 0 && offMonthCount > 0 
                    ? `${skippedCount} skipped, ${offMonthCount} off-month`
                    : (offMonthCount > 0 ? `${offMonthCount} off-month` : `${skippedCount} skipped`);
                statusText += ` <span style="font-size: 11px; color: #9ca3af;">(${excludedLabel})</span>`;
            }
            
            card.innerHTML = `
                <h3>${serviceDay.name}</h3>
                ${employeeLine}
                ${dateLine}
                <p>${statusText}</p>
                ${isFullyCompleted ? '<span class="completion-badge">‚úì Complete</span>' : ''}
                <div class="progress-bar" style="width: ${completionPercent}%"></div>
            `;
            card.onclick = () => {
                currentServiceDate = formatDateLocal(new Date()); // Working on today
                showCustomerListView(serviceDay.name);
            };
            return card;
        }

        function formatServiceDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        }

        // Render customer list with drag-and-drop reordering
        function renderCustomerList() {
            const customers = db.customers
                .filter(c => c.runDay === currentRunDay)
                .sort((a, b) => (a.order || 0) - (b.order || 0));
            
            const list = document.getElementById('customerList');
            const today = formatDateLocal(new Date());
            const workDate = currentServiceDate || today;
            const isHistorical = isPastMonth();
            
            // Update header with date context
            let headerText = currentRunDay;
            if (isHistorical) {
                headerText += ` - ${MONTH_NAMES[selectedMonth]} ${selectedYear}`;
            } else if (currentServiceDate && currentServiceDate !== today) {
                // Show the date if working on a different day
                headerText += ` - ${formatDisplayDate(currentServiceDate)}`;
            }
            document.getElementById('currentRunDay').textContent = headerText;
            
            // Count skipped and off-month customers
            const skippedCount = customers.filter(c => db.isCustomerSkipped(c.id, selectedMonth, selectedYear)).length;
            const offMonthCount = customers.filter(c => 
                !db.isCustomerSkipped(c.id, selectedMonth, selectedYear) && 
                isOffMonth(c, selectedMonth, selectedYear)
            ).length;
            const excludedTotal = skippedCount + offMonthCount;
            const activeCount = customers.length - excludedTotal;
            let countText = `${customers.length} customers`;
            if (excludedTotal > 0) {
                const excludedLabel = skippedCount > 0 && offMonthCount > 0 
                    ? `${skippedCount} skipped, ${offMonthCount} off-month`
                    : (offMonthCount > 0 ? `${offMonthCount} off-month` : `${skippedCount} skipped`);
                countText = `${activeCount} active (${excludedLabel})`;
            }
            document.getElementById('customerCount').textContent = countText;
            
            list.innerHTML = '';
            
            // For historical months, show notice
            if (isHistorical) {
                const notice = document.createElement('li');
                notice.className = 'historical-notice';
                notice.innerHTML = '<strong>üìã Historical View</strong>Viewing completed PODs from ' + MONTH_NAMES[selectedMonth] + ' ' + selectedYear;
                list.appendChild(notice);
            }
            
            customers.forEach((customer, index) => {
                // Check if customer is skipped for the current month
                const isSkipped = db.isCustomerSkipped(customer.id, selectedMonth, selectedYear);
                const skipReason = isSkipped ? db.getSkipReason(customer.id, selectedMonth, selectedYear) : '';
                
                // Check if this is an off-month for bi-monthly customers
                const customerIsOffMonth = isOffMonth(customer, selectedMonth, selectedYear);
                const scheduleLabel = getScheduleLabel(customer.serviceMonths);
                
                // Treat off-month as effectively skipped (auto-strikethrough)
                const effectivelySkipped = isSkipped || customerIsOffMonth;
                
                // Find completed POD for the selected month (matches service day card logic)
                const completedPod = db.pods.find(pod => {
                    if (pod.customerId !== customer.id) return false;
                    const podDate = new Date(pod.date + 'T00:00:00');
                    return podDate.getMonth() === selectedMonth && podDate.getFullYear() === selectedYear;
                });
                
                const li = document.createElement('li');
                li.className = `customer-item ${completedPod ? 'completed' : ''} ${effectivelySkipped ? 'skipped' : ''}`;
                li.dataset.customerId = customer.id;
                
                // Build schedule badge HTML (only for bi-monthly/quarterly)
                let scheduleBadgeHtml = '';
                if (scheduleLabel && !isSkipped) {
                    if (customerIsOffMonth) {
                        scheduleBadgeHtml = `<span class="schedule-badge off-month">‚è∏Ô∏è OFF MONTH</span>`;
                    } else {
                        scheduleBadgeHtml = `<span class="schedule-badge">üìÖ ${scheduleLabel}</span>`;
                    }
                }
                
                // Determine skip reason display
                let skipDisplay = '';
                if (isSkipped && skipReason) {
                    skipDisplay = `<span class="skip-reason-badge">${skipReason}</span>`;
                } else if (customerIsOffMonth && !isSkipped) {
                    skipDisplay = scheduleBadgeHtml;
                    scheduleBadgeHtml = ''; // Don't show twice
                }
                
                // Build customer info HTML
                let customerInfoHtml = `
                    <div class="customer-name">${customer.name}${skipDisplay}${scheduleBadgeHtml}</div>
                    ${customer.address ? `<div class="customer-address">${customer.address}</div>` : ''}
                    ${customer.phone ? `<div class="customer-phone">üìû ${customer.phone}</div>` : ''}
                `;
                
                // Add service type, carbsolve badge, waste badge, and access code on same line
                customerInfoHtml += '<div style="margin-top: 6px;">';
                
                // Always show service type
                const displayServiceType = customer.serviceType || 'Service';
                const typeColors = {
                    'Service': { bg: '#e5e7eb', text: '#374151' },
                    'Delivery': { bg: '#3b82f6', text: 'white' },
                    'Check': { bg: '#f59e0b', text: 'white' }
                };
                const typeStyle = typeColors[displayServiceType] || typeColors['Service'];
                customerInfoHtml += `<span style="background: ${typeStyle.bg}; color: ${typeStyle.text}; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-right: 6px;">${displayServiceType}</span>`;
                
                if (customer.carbsolve) {
                    customerInfoHtml += `<span class="customer-carbsolve">${customer.carbsolve}</span>`;
                }
                if (customer.waste) {
                    customerInfoHtml += `<span class="customer-waste">üõ¢Ô∏è ${customer.waste}</span>`;
                }
                if (customer.code) {
                    customerInfoHtml += `<span class="customer-access-code">üîë ${customer.code}</span>`;
                }
                customerInfoHtml += '</div>';
                
                // Add special instructions (prominent warning style)
                if (customer.specialInstructions) {
                    customerInfoHtml += `<div class="customer-special-instructions">‚ö†Ô∏è ${customer.specialInstructions}</div>`;
                } else if (customer.notes) {
                    customerInfoHtml += `<div class="customer-notes">üìù ${customer.notes}</div>`;
                }
                
                if (completedPod) {
                    customerInfoHtml += `<div class="timestamp">Completed: ${formatTimestamp(completedPod.timestamp)}</div>`;
                }
                
                // For historical months, hide drag handle and show different status
                const showDragHandle = !isHistorical;
                
                li.innerHTML = `
                    ${showDragHandle ? '<span class="drag-handle" draggable="true">‚ò∞</span>' : ''}
                    <div class="customer-info" style="flex: 1;">
                        ${customerInfoHtml}
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        ${!isHistorical && !customerIsOffMonth ? `
                            <button class="skip-btn ${isSkipped ? 'active' : ''}" 
                                    onclick="event.stopPropagation(); toggleCustomerSkip(${customer.id}, ${isSkipped})" 
                                    title="${isSkipped ? 'Unskip this customer' : 'Skip this customer for this month'}">
                                ${isSkipped ? '‚Ü©Ô∏è' : '‚è≠Ô∏è'}
                            </button>
                        ` : ''}
                        <button class="edit-customer-btn" onclick="event.stopPropagation(); showCustomerEditModal(${customer.id})" 
                                style="background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 12px;"
                                title="Edit Notes">üìù</button>
                        ${effectivelySkipped ? 
                            (customerIsOffMonth && !isSkipped ? 
                                '<span class="status-badge" style="background: #fef3c7; color: #92400e;">Off Month</span>' :
                                '<span class="status-badge" style="background: #e5e7eb; color: #6b7280;">Skipped</span>'
                            ) :
                            (isHistorical ? 
                                (completedPod ? '<span class="status-badge completed">‚úì Completed</span>' : '<span class="status-badge" style="background: #e5e7eb; color: #6b7280;">Not Serviced</span>') :
                                `<span class="status-badge ${completedPod ? 'completed' : 'pending'}">${completedPod ? '‚úì Completed' : 'Pending'}</span>`
                            )
                        }
                    </div>
                `;
                
                // Only enable drag-and-drop for current/future months
                if (!isHistorical) {
                    const dragHandle = li.querySelector('.drag-handle');
                    if (dragHandle) {
                        dragHandle.addEventListener('mousedown', (e) => {
                            li.draggable = true;
                        });
                        dragHandle.addEventListener('touchstart', (e) => {
                            li.draggable = true;
                        });
                    }
                    
                    li.addEventListener('dragstart', handleDragStart);
                    li.addEventListener('dragover', handleDragOver);
                    li.addEventListener('drop', handleDrop);
                    li.addEventListener('dragend', (e) => {
                        handleDragEnd.call(li, e);
                        li.draggable = false;
                    });
                }
                
                // Click to view (entire card except drag handle and edit button)
                li.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('drag-handle') && !e.target.classList.contains('edit-customer-btn')) {
                        showPodView(customer);
                    }
                });
                
                list.appendChild(li);
            });
            
            // Add ad-hoc PODs section - show ad-hocs that belong to this runsheet
            // New PODs: runDay = service day, isAdHoc = true
            // Old PODs: runDay = 'Ad-Hoc', sourceRunDay = service day
            const adHocPods = db.pods.filter(pod => {
                // New format: isAdHoc flag and runDay matches
                if (pod.isAdHoc && pod.runDay === currentRunDay) {
                    return true;
                }
                // Legacy format: runDay is 'Ad-Hoc' and sourceRunDay matches
                if (pod.runDay === 'Ad-Hoc' && pod.sourceRunDay === currentRunDay) {
                    return true;
                }
                return false;
            });
            
            if (adHocPods.length > 0) {
                // Add section header
                const headerLi = document.createElement('li');
                headerLi.className = 'adhoc-section-header';
                headerLi.innerHTML = `
                    <div style="padding: 12px 16px; background: #fef3c7; border-left: 4px solid #f59e0b; margin-top: 16px; border-radius: 6px;">
                        <strong style="color: #92400e;">üìã Ad-Hoc Services (${adHocPods.length})</strong>
                        <span style="color: #92400e; font-size: 12px; margin-left: 8px;">Added to this runsheet</span>
                    </div>
                `;
                list.appendChild(headerLi);
                
                // Add each ad-hoc POD
                adHocPods.forEach(pod => {
                    const li = document.createElement('li');
                    li.className = 'customer-item completed adhoc-item';
                    li.style.cssText = 'background: #fffbeb; border-left: 4px solid #f59e0b;';
                    
                    const customer = db.customers.find(c => c.id === pod.customerId);
                    const customerName = customer ? customer.name : (pod.customerName || 'Unknown Customer');
                    const productsStr = pod.products && pod.products.length > 0 
                        ? pod.products.map(p => `${p.product} x${p.quantity}`).join(', ')
                        : '';
                    const isDelivery = pod.serviceType === 'Delivery';
                    const typeIcon = isDelivery ? 'üì¶' : 'üîß';
                    
                    li.innerHTML = `
                        <div class="customer-info" style="flex: 1;">
                            <div class="customer-name">
                                ${customerName}
                                <span style="background: #f59e0b; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">Ad-Hoc</span>
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                ${formatDisplayDate(pod.date)} ‚Ä¢ ${typeIcon} ${pod.serviceType || 'Service'}
                            </div>
                            ${productsStr ? `<div style="font-size: 12px; color: #6b7280; margin-top: 2px;">Products: ${productsStr}</div>` : ''}
                            ${pod.notes ? `<div style="font-size: 12px; color: #6b7280; margin-top: 2px; font-style: italic;">üìù ${pod.notes}</div>` : ''}
                        </div>
                        <div class="status-indicator completed">‚úì</div>
                    `;
                    
                    li.addEventListener('click', () => {
                        returnToRunDay = currentRunDay; // Remember which runsheet we're on
                        viewPODFromOverview(pod.id);
                    });
                    list.appendChild(li);
                });
            }
            
            // Add tank movements section - show movements that belong to this runsheet
            const tankMoves = db.tankMovements.filter(tm => {
                // Regular movement for this service day
                if (tm.runDay === currentRunDay) return true;
                // Ad-hoc created from this runsheet
                if (tm.sourceRunDay === currentRunDay) return true;
                return false;
            });
            
            if (tankMoves.length > 0) {
                // Add section header
                const headerLi = document.createElement('li');
                headerLi.className = 'tank-section-header';
                headerLi.innerHTML = `
                    <div style="padding: 12px 16px; background: #dbeafe; border-left: 4px solid #3b82f6; margin-top: 16px; border-radius: 6px;">
                        <strong style="color: #1e40af;">üîÑ Tank Movements (${tankMoves.length})</strong>
                        <span style="color: #1e40af; font-size: 12px; margin-left: 8px;">Added to this runsheet</span>
                    </div>
                `;
                list.appendChild(headerLi);
                
                // Add each tank movement
                tankMoves.forEach(tm => {
                    const li = document.createElement('li');
                    li.className = 'customer-item completed tank-item';
                    li.style.cssText = 'background: #eff6ff; border-left: 4px solid #3b82f6;';
                    
                    const customer = db.customers.find(c => c.id === tm.customerId);
                    const customerName = customer ? customer.name : (tm.customerName || 'Unknown Customer');
                    
                    li.innerHTML = `
                        <div class="customer-info" style="flex: 1;">
                            <div class="customer-name">
                                ${customerName}
                                <span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">Tank ${tm.movementType || 'Movement'}</span>
                            </div>
                            <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                                ${formatDisplayDate(tm.date)}
                                ${tm.carbsolve ? ` ‚Ä¢ ${tm.carbsolve}` : ''}
                                ${tm.tankNoPulled ? ` ‚Ä¢ Out: ${tm.tankNoPulled}` : ''}
                                ${tm.tankNoPlaced ? ` ‚Ä¢ In: ${tm.tankNoPlaced}` : ''}
                            </div>
                            ${tm.reason ? `<div style="font-size: 12px; color: #6b7280; margin-top: 2px; font-style: italic;">üìù ${tm.reason}</div>` : ''}
                        </div>
                        <div class="status-indicator completed">‚úì</div>
                    `;
                    
                    list.appendChild(li);
                });
            }
        }

        // Drag and drop handlers
        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
            return false;
        }

        async function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const draggedId = parseInt(draggedElement.dataset.customerId);
                const targetId = parseInt(this.dataset.customerId);
                
                // Get all customers for this service day
                const customers = db.customers
                    .filter(c => c.runDay === currentRunDay)
                    .sort((a, b) => (a.order || 0) - (b.order || 0));
                
                const draggedIdx = customers.findIndex(c => c.id === draggedId);
                const targetIdx = customers.findIndex(c => c.id === targetId);
                
                // Reorder
                const [removed] = customers.splice(draggedIdx, 1);
                customers.splice(targetIdx, 0, removed);
                
                // Update order property and save to database
                for (let idx = 0; idx < customers.length; idx++) {
                    const customer = db.customers.find(cust => cust.id === customers[idx].id);
                    if (customer) {
                        customer.order = idx;
                        await db.saveCustomer(customer);
                    }
                }
                
                renderCustomerList();
            }
            
            this.classList.remove('drag-over');
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.customer-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        // Toggle customer skip status for the current month
        async function toggleCustomerSkip(customerId, isCurrentlySkipped) {
            const yearMonth = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}`;
            
            if (isCurrentlySkipped) {
                // Unskip
                const success = await db.removeMonthlySkip(customerId, yearMonth);
                if (success) {
                    showToast('Customer restored for ' + MONTH_NAMES[selectedMonth], 'success');
                    renderCustomerList();
                    renderRunDays();
                } else {
                    showToast('Error restoring customer', 'error');
                }
            } else {
                // Show skip reason dialog
                showSkipReasonModal(customerId, yearMonth);
            }
        }
        
        function showSkipReasonModal(customerId, yearMonth) {
            const customer = db.customers.find(c => c.id === customerId);
            const customerName = customer ? customer.name : 'Customer';
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'search-modal-overlay active';
            modal.id = 'skipReasonModal';
            modal.innerHTML = `
                <div class="search-modal" style="max-width: 400px;">
                    <div class="search-modal-header">
                        <h2>Skip ${customerName}</h2>
                        <button class="search-modal-close" onclick="closeSkipReasonModal()">√ó</button>
                    </div>
                    <div class="search-modal-body">
                        <p style="color: #6b7280; margin-bottom: 16px;">This customer will be marked as skipped for ${MONTH_NAMES[selectedMonth]} ${selectedYear}.</p>
                        
                        <div class="form-group">
                            <label>Reason (optional)</label>
                            <select id="skipReasonSelect" style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 16px;">
                                <option value="">No reason specified</option>
                                <option value="Bi-monthly (off month)">Bi-monthly (off month)</option>
                                <option value="Already serviced">Already serviced by another worker</option>
                                <option value="Tank pulled">Tank pulled for repairs</option>
                                <option value="Customer request">Customer requested skip</option>
                                <option value="Access issue">Access issue</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <button class="btn" onclick="confirmSkipCustomer(${customerId}, '${yearMonth}')" style="margin-top: 8px;">
                            Skip Customer
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeSkipReasonModal() {
            const modal = document.getElementById('skipReasonModal');
            if (modal) modal.remove();
        }
        
        async function confirmSkipCustomer(customerId, yearMonth) {
            const reason = document.getElementById('skipReasonSelect').value;
            
            const success = await db.saveMonthlySkip(customerId, yearMonth, reason);
            if (success) {
                closeSkipReasonModal();
                showToast('Customer skipped for ' + MONTH_NAMES[selectedMonth], 'success');
                renderCustomerList();
                renderRunDays();
            } else {
                showToast('Error skipping customer', 'error');
            }
        }

        // Product lines with categories
        function getProductOptionsHtml(category) {
            // Filter products by category
            let filteredProducts = [];
            
            if (category === 'sale') {
                filteredProducts = db.products.filter(p => typeof p === 'object' && p.category === 'sale');
            } else if (category === 'repair') {
                filteredProducts = db.products.filter(p => typeof p === 'object' && p.category === 'repair');
            }
            
            // Fallback for old data format (no categories)
            if (filteredProducts.length === 0) {
                const allProducts = db.productNames || db.products || [];
                allProducts.forEach(p => {
                    const name = typeof p === 'string' ? p : (p.display_name || p.name);
                    filteredProducts.push({ display_name: name, name: name });
                });
            }
            
            let html = '<option value="">Select ' + (category === 'repair' ? 'repair item' : 'product') + '...</option>';
            filteredProducts.forEach(p => {
                const name = p.display_name || p.name;
                html += `<option value="${name}">${name}</option>`;
            });
            
            return html;
        }

        function renderProductLines() {
            // Render sale products section
            const saleContainer = document.getElementById('productLines');
            saleContainer.innerHTML = `
                <div class="product-line" data-type="sale">
                    <select class="product-select" onchange="checkProductLineComplete(this)">
                        ${getProductOptionsHtml('sale')}
                    </select>
                    <input type="number" class="product-quantity" placeholder="Qty" min="0" value="0" onchange="checkProductLineComplete(this)">
                    <button type="button" class="product-confirm-btn" onclick="confirmProductLine(this)" disabled style="background: #9ca3af; cursor: not-allowed;">Confirm</button>
                    <button type="button" onclick="removeProductLine(this)">Remove</button>
                </div>
            `;
            
            // Render repair items section
            const repairContainer = document.getElementById('repairLines');
            if (repairContainer) {
                repairContainer.innerHTML = `
                    <div class="product-line" data-type="repair">
                        <select class="product-select" onchange="checkProductLineComplete(this)">
                            ${getProductOptionsHtml('repair')}
                        </select>
                        <input type="number" class="product-quantity" placeholder="Qty" min="0" value="0" onchange="checkProductLineComplete(this)">
                        <button type="button" class="product-confirm-btn" onclick="confirmProductLine(this)" disabled style="background: #9ca3af; cursor: not-allowed;">Confirm</button>
                        <button type="button" onclick="removeProductLine(this)">Remove</button>
                    </div>
                `;
            }
        }

        function addProductLine(category = 'sale') {
            const containerId = category === 'repair' ? 'repairLines' : 'productLines';
            const container = document.getElementById(containerId);
            const line = document.createElement('div');
            line.className = 'product-line';
            line.dataset.type = category;
            line.innerHTML = `
                <select class="product-select" onchange="checkProductLineComplete(this)">
                    ${getProductOptionsHtml(category)}
                </select>
                <input type="number" class="product-quantity" placeholder="Qty" min="0" value="0" onchange="checkProductLineComplete(this)">
                <button type="button" class="product-confirm-btn" onclick="confirmProductLine(this)" disabled style="background: #9ca3af; cursor: not-allowed;">Confirm</button>
                <button type="button" onclick="removeProductLine(this)">Remove</button>
            `;
            container.appendChild(line);
        }

        function checkProductLineComplete(element) {
            const line = element.closest('.product-line');
            const product = line.querySelector('.product-select').value;
            const quantity = parseInt(line.querySelector('.product-quantity').value);
            const confirmBtn = line.querySelector('.product-confirm-btn');
            
            // Enable confirm button if both filled
            if (product && quantity > 0) {
                confirmBtn.disabled = false;
                confirmBtn.style.background = '#16a34a';
                confirmBtn.style.cursor = 'pointer';
            } else {
                confirmBtn.disabled = true;
                confirmBtn.style.background = '#9ca3af';
                confirmBtn.style.cursor = 'not-allowed';
            }
        }

        function confirmProductLine(button) {
            const line = button.closest('.product-line');
            const product = line.querySelector('.product-select').value;
            const quantity = line.querySelector('.product-quantity').value;
            
            if (!product || !quantity || quantity <= 0) return;
            
            // Lock the line
            line.style.background = '#f0fdf4';
            line.style.border = '2px solid #16a34a';
            line.style.borderRadius = '6px';
            line.style.padding = '8px';
            line.dataset.confirmed = 'true';
            
            // Disable inputs
            line.querySelector('.product-select').disabled = true;
            line.querySelector('.product-quantity').disabled = true;
            
            // Change confirm button to "Locked ‚úì"
            button.textContent = 'Locked ‚úì';
            button.disabled = true;
            button.style.background = '#16a34a';
            button.style.cursor = 'default';
            
            showToast(`${product} x${quantity} confirmed`, 'success');
        }

        function highlightProductLine(element) {
            // Keep for backward compatibility but checkProductLineComplete handles it now
            checkProductLineComplete(element);
        }

        function removeProductLine(btn) {
            btn.parentElement.remove();
        }

        // Submit POD - called directly from button
        async function savePOD() {
            console.log('savePOD called');
            
            // Prevent saving PODs in historical months
            if (isPastMonth()) {
                showToast('Cannot create PODs for past months. Switch to the current month to create new PODs.', 'error');
                return;
            }

            // Determine service type:
            // - If editing existing POD, use its service type
            // - If creating new ad-hoc, use selected ad-hoc type
            // - Otherwise use customer's default type
            let serviceType;
            if (currentEditingPodId && currentEditingServiceType) {
                serviceType = currentEditingServiceType;
            } else if (isAdHocService) {
                serviceType = adHocServiceType;
            } else {
                serviceType = currentCustomer.serviceType || 'Service';
            }
            const isDelivery = serviceType === 'Delivery';

            // Check tank serviced is selected (skip for deliveries)
            const tankServiced = document.querySelector('input[name="tankServiced"]:checked');
            if (!isDelivery && !tankServiced) {
                showToast('Please select whether tank was serviced', 'error');
                return;
            }

            // Check signature requirement
            const customerNotAvailable = document.getElementById('customerNotAvailable').checked;
            const hasSignature = !signaturePad.isEmpty;
            
            if (!hasSignature && !customerNotAvailable) {
                showToast('Please provide a customer signature or check "Customer not available"', 'error');
                return;
            }

            // Validation based on tank serviced status (skip for deliveries)
            if (!isDelivery && tankServiced && tankServiced.value === 'no') {
                // If tank NOT serviced, service notes are required
                const serviceNotes = document.getElementById('serviceNotes').value.trim();
                if (!serviceNotes) {
                    showToast('Service notes are required when tank is not serviced', 'error');
                    return;
                }
            }

            // Gather and validate products - only include confirmed ones from both sections
            const products = [];
            let hasUnconfirmedProduct = false;
            
            // Check both productLines (sale) and repairLines (repair)
            document.querySelectorAll('#productLines .product-line, #repairLines .product-line').forEach(line => {
                const product = line.querySelector('.product-select').value;
                const quantity = parseInt(line.querySelector('.product-quantity').value);
                const isConfirmed = line.dataset.confirmed === 'true';
                const type = line.dataset.type || 'sale';
                
                // Check for unconfirmed entries
                if (product && quantity > 0 && !isConfirmed) {
                    hasUnconfirmedProduct = true;
                } else if (isConfirmed && product && quantity > 0) {
                    products.push({ product, quantity, type });
                }
            });
            
            if (hasUnconfirmedProduct) {
                showToast('Please confirm all products/repairs by clicking the Confirm button', 'error');
                return;
            }

            // If we get here, validation passed
            // Get photo (already compressed)
            const photoPreview = document.getElementById('photoPreview');
            let photoData = null;
            if (photoPreview.dataset.compressed) {
                photoData = photoPreview.dataset.compressed;
            }

            // Get signature (or note that customer wasn't available)
            let signatureData = null;
            if (hasSignature) {
                signatureData = signaturePad.canvas.toDataURL();
            }

            // Create or update POD with AEST timestamp
            const nowUTC = new Date();
            const nowAEST = new Date(nowUTC.toLocaleString('en-US', { timeZone: 'Australia/Brisbane' }));
            
            // Use the service date if set (when working from calendar), otherwise today
            const podDate = currentServiceDate || formatDateLocal(nowAEST);
            
            // Get carbsolve from customer data
            const carbsolve = currentCustomer.carbsolve || '';
            
            // For deliveries, tank serviced is N/A
            const tankServicedValue = isDelivery ? 'n/a' : (tankServiced ? tankServiced.value : 'n/a');
            
            const podId = currentEditingPodId || Date.now();
            const pod = {
                id: podId,
                customerId: currentCustomer.id, // Will be null for freetext ad-hoc
                customerName: currentCustomer.name,
                customerAddress: currentCustomer.address || '',
                runDay: currentRunDay,
                date: podDate,
                timestamp: nowUTC.toISOString(), // Store as UTC, display as AEST
                serviceType: serviceType,
                carbsolve: carbsolve,
                tankServiced: tankServicedValue,
                serviceNotes: document.getElementById('serviceNotes').value,
                products: products,
                notes: document.getElementById('notes').value,
                photo: photoData,
                signature: signatureData,
                customerNotAvailable: customerNotAvailable,
                isAdHoc: isAdHocService,
                sourceRunDay: isAdHocService ? adHocSourceRunDay : null // Track which runsheet ad-hoc was created from
            };

            console.log('Saving POD:', pod);
            
            const success = await db.savePOD(pod);
            if (success) {
                // Update or add to local array
                const existingIndex = db.pods.findIndex(p => p.id === podId);
                if (existingIndex !== -1) {
                    db.pods[existingIndex] = pod;
                } else {
                    db.pods.push(pod);
                }
                
                currentEditingPodId = null; // Reset editing state
                const wasAdHoc = isAdHocService;
                isAdHocService = false; // Reset ad-hoc state
                adHocCustomerName = '';
                
                showToast('POD saved successfully!', 'success');
                setTimeout(() => {
                    if (wasAdHoc) {
                        showHomeView();
                    } else {
                        backToCustomerList();
                    }
                }, 1000);
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Admin - Add customer
        document.getElementById('addCustomerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const serviceDay = document.getElementById('newCustomerServiceDay').value;
            const customer = {
                id: Date.now(),
                name: document.getElementById('newCustomerName').value,
                runDay: serviceDay,
                address: document.getElementById('newCustomerAddress').value,
                phone: document.getElementById('newCustomerPhone').value,
                serviceType: document.getElementById('newCustomerServiceType').value,
                carbsolve: document.getElementById('newCustomerCarbsolve').value,
                waste: document.getElementById('newCustomerWaste').value,
                code: document.getElementById('newCustomerCode').value,
                notes: document.getElementById('newCustomerNotes').value,
                order: db.customers.filter(c => c.runDay === serviceDay).length
            };
            
            const success = await db.saveCustomer(customer);
            if (success) {
                db.customers.push(customer);
                
                // Add service day if it doesn't exist
                if (!db.serviceDays.some(sd => sd.name === serviceDay)) {
                    const newServiceDay = {
                        name: serviceDay,
                        employee: '',
                        date: null
                    };
                    await db.saveServiceDay(newServiceDay);
                    db.serviceDays.push(newServiceDay);
                }
                
                this.reset();
                renderCustomerAdminList();
                renderServiceDayAdminList();
                renderRunDays();
                showToast('Customer added successfully!', 'success');
            }
        });

        // Admin - Add product
        document.getElementById('addProductForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const product = document.getElementById('newProductName').value;
            if (!db.products.includes(product)) {
                const success = await db.saveProduct(product);
                if (success) {
                    db.products.push(product);
                    this.reset();
                    renderProductAdminList();
                    showToast('Product added successfully!', 'success');
                }
            } else {
                showToast('Product already exists!', 'warning');
            }
        });

        let customerAdminSearchTerm = '';
        
        function filterCustomerAdminList(searchTerm) {
            customerAdminSearchTerm = searchTerm.toLowerCase();
            renderCustomerAdminList();
        }
        
        function renderCustomerAdminList() {
            const list = document.getElementById('customerAdminList');
            const countEl = document.getElementById('customerAdminCount');
            list.innerHTML = '';
            
            // Sort customers alphabetically
            const sortedCustomers = [...db.customers].sort((a, b) => 
                a.name.localeCompare(b.name, undefined, { sensitivity: 'base' })
            );
            
            // Filter by customer name only
            let filteredCustomers = sortedCustomers;
            if (customerAdminSearchTerm) {
                filteredCustomers = sortedCustomers.filter(c => 
                    c.name.toLowerCase().includes(customerAdminSearchTerm)
                );
            }
            
            // Limit display for performance
            const displayLimit = 50;
            const displayCustomers = filteredCustomers.slice(0, displayLimit);
            
            // Update count - match ad-hoc search format
            if (countEl) {
                if (customerAdminSearchTerm) {
                    if (filteredCustomers.length > displayLimit) {
                        countEl.textContent = `${displayLimit} of ${filteredCustomers.length} matches shown`;
                    } else {
                        countEl.textContent = `${filteredCustomers.length} matches found`;
                    }
                } else {
                    countEl.textContent = `${db.customers.length} customers total (showing first ${displayLimit})`;
                }
            }
            
            displayCustomers.forEach(customer => {
                const div = document.createElement('div');
                div.className = 'customer-admin-item';
                div.id = `customer-${customer.id}`;
                
                const details = [];
                details.push(customer.runDay);
                if (customer.serviceType && customer.serviceType !== 'Service') details.push(customer.serviceType);
                if (customer.carbsolve) details.push(customer.carbsolve);
                if (customer.waste) details.push('Drum');
                if (customer.phone) details.push(customer.phone);
                
                div.innerHTML = `
                    <div class="customer-admin-info">
                        <strong>${customer.name}</strong>
                        <small>${details.join(' | ')}</small>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" style="padding: 6px 12px; font-size: 12px; background: #374151;" onclick="editCustomer(${customer.id})">Edit</button>
                        <button class="delete-btn" onclick="deleteCustomer(${customer.id})">Delete</button>
                    </div>
                `;
                list.appendChild(div);
            });
            
            // Show message if more results exist
            if (filteredCustomers.length > displayLimit) {
                const moreDiv = document.createElement('div');
                moreDiv.style.cssText = 'padding: 16px; text-align: center; color: #6b7280; background: #f3f4f6; border-radius: 6px; margin-top: 8px;';
                moreDiv.textContent = `Refine your search to see more results`;
                list.appendChild(moreDiv);
            }
        }

        function editCustomer(id) {
            const customer = db.customers.find(c => c.id === id);
            if (!customer) return;
            
            const div = document.getElementById(`customer-${id}`);
            div.innerHTML = `
                <div style="flex: 1;">
                    <div class="form-group" style="margin-bottom: 8px;">
                        <input type="text" id="edit-name-${id}" value="${customer.name}" placeholder="Customer Name" style="width: 100%; padding: 8px; margin-bottom: 4px;">
                        <input type="text" id="edit-runday-${id}" value="${customer.runDay}" placeholder="Service Day" style="width: 100%; padding: 8px; margin-bottom: 4px;">
                        <input type="text" id="edit-address-${id}" value="${customer.address || ''}" placeholder="Address" style="width: 100%; padding: 8px; margin-bottom: 4px;">
                        <input type="text" id="edit-phone-${id}" value="${customer.phone || ''}" placeholder="Phone" style="width: 100%; padding: 8px; margin-bottom: 4px;">
                        
                        <select id="edit-servicetype-${id}" style="width: 100%; padding: 8px; margin-bottom: 4px;">
                            <option value="">Service Type...</option>
                            <option value="Service" ${customer.serviceType === 'Service' ? 'selected' : ''}>Service</option>
                            <option value="Delivery" ${customer.serviceType === 'Delivery' ? 'selected' : ''}>Delivery</option>
                            <option value="Check" ${customer.serviceType === 'Check' ? 'selected' : ''}>Check</option>
                        </select>
                        
                        <select id="edit-carbsolve-${id}" style="width: 100%; padding: 8px; margin-bottom: 4px;">
                            <option value="">Carbsolve...</option>
                            <option value="4kg" ${customer.carbsolve === '4kg' ? 'selected' : ''}>4kg</option>
                            <option value="4kg spcl" ${customer.carbsolve === '4kg spcl' ? 'selected' : ''}>4kg spcl</option>
                            <option value="7kg" ${customer.carbsolve === '7kg' ? 'selected' : ''}>7kg</option>
                            <option value="7kg spcl" ${customer.carbsolve === '7kg spcl' ? 'selected' : ''}>7kg spcl</option>
                            <option value="10kg" ${customer.carbsolve === '10kg' ? 'selected' : ''}>10kg</option>
                            <option value="11kg spcl" ${customer.carbsolve === '11kg spcl' ? 'selected' : ''}>11kg spcl</option>
                            <option value="14kg" ${customer.carbsolve === '14kg' ? 'selected' : ''}>14kg</option>
                            <option value="17kg" ${customer.carbsolve === '17kg' ? 'selected' : ''}>17kg</option>
                            <option value="21kg" ${customer.carbsolve === '21kg' ? 'selected' : ''}>21kg</option>
                        </select>
                        
                        <select id="edit-waste-${id}" style="width: 100%; padding: 8px; margin-bottom: 4px;">
                            <option value="">Waste...</option>
                            <option value="Drum" ${customer.waste === 'Drum' ? 'selected' : ''}>Drum</option>
                        </select>
                        
                        <input type="text" id="edit-code-${id}" value="${customer.code || ''}" placeholder="Code" style="width: 100%; padding: 8px; margin-bottom: 4px;">
                        <textarea id="edit-notes-${id}" placeholder="Notes" style="width: 100%; padding: 8px; min-height: 60px;">${customer.notes || ''}</textarea>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-success" style="padding: 6px 12px; font-size: 12px;" onclick="saveCustomer(${id})">Save</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="renderCustomerAdminList()">Cancel</button>
                </div>
            `;
        }

        async function saveCustomer(id) {
            const customer = db.customers.find(c => c.id === id);
            if (!customer) return;
            
            customer.name = document.getElementById(`edit-name-${id}`).value;
            customer.runDay = document.getElementById(`edit-runday-${id}`).value;
            customer.address = document.getElementById(`edit-address-${id}`).value;
            customer.phone = document.getElementById(`edit-phone-${id}`).value;
            customer.serviceType = document.getElementById(`edit-servicetype-${id}`).value;
            customer.carbsolve = document.getElementById(`edit-carbsolve-${id}`).value;
            customer.waste = document.getElementById(`edit-waste-${id}`).value;
            customer.code = document.getElementById(`edit-code-${id}`).value;
            customer.notes = document.getElementById(`edit-notes-${id}`).value;
            
            const success = await db.saveCustomer(customer);
            if (success) {
                renderCustomerAdminList();
                renderRunDays();
                showToast('Customer updated successfully!', 'success');
            }
        }

        // Service Day Management
        document.getElementById('addServiceDayForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const serviceDay = {
                name: document.getElementById('newServiceDayName').value,
                employee: document.getElementById('newServiceDayEmployee').value,
                date: document.getElementById('newServiceDayDate').value || null
            };
            
            if (!db.serviceDays.some(sd => sd.name === serviceDay.name)) {
                const success = await db.saveServiceDay(serviceDay);
                if (success) {
                    db.serviceDays.push(serviceDay);
                    this.reset();
                    renderServiceDayAdminList();
                    renderRunDays();
                    showToast('Service day added successfully!', 'success');
                }
            } else {
                showToast('Service day already exists!', 'warning');
            }
        });

        function renderServiceDayAdminList() {
            const list = document.getElementById('serviceDayAdminList');
            list.innerHTML = '';
            db.serviceDays.forEach((serviceDay, index) => {
                const div = document.createElement('div');
                div.className = 'customer-admin-item';
                div.id = `serviceday-${index}`;
                const customerCount = db.customers.filter(c => c.runDay === serviceDay.name).length;
                div.innerHTML = `
                    <div class="customer-admin-info">
                        <strong>${serviceDay.name}</strong>
                        <small>
                            ${serviceDay.employee ? `Employee: ${serviceDay.employee}` : 'No employee'} | 
                            ${serviceDay.date ? formatServiceDate(serviceDay.date) : 'No date set'} | 
                            ${customerCount} customers
                        </small>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" style="padding: 6px 12px; font-size: 12px; background: #374151;" onclick="editServiceDay(${index})">Edit</button>
                        <button class="delete-btn" onclick="deleteServiceDay(${index})">Delete</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function editServiceDay(index) {
            const serviceDay = db.serviceDays[index];
            if (!serviceDay) return;
            
            const div = document.getElementById(`serviceday-${index}`);
            div.innerHTML = `
                <div style="flex: 1;">
                    <div class="form-group" style="margin-bottom: 8px;">
                        <input type="text" id="edit-sdname-${index}" value="${serviceDay.name}" placeholder="Service Day Name" style="width: 100%; padding: 8px; margin-bottom: 4px;">
                        <input type="text" id="edit-employee-${index}" value="${serviceDay.employee || ''}" placeholder="Employee" style="width: 100%; padding: 8px; margin-bottom: 4px;">
                        <input type="date" id="edit-date-${index}" value="${serviceDay.date || ''}" style="width: 100%; padding: 8px;">
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-success" style="padding: 6px 12px; font-size: 12px;" onclick="saveServiceDay(${index})">Save</button>
                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="renderServiceDayAdminList()">Cancel</button>
                </div>
            `;
        }

        async function saveServiceDay(index) {
            const serviceDay = db.serviceDays[index];
            if (!serviceDay) return;
            
            const oldName = serviceDay.name;
            const newName = document.getElementById(`edit-sdname-${index}`).value;
            
            serviceDay.name = newName;
            serviceDay.employee = document.getElementById(`edit-employee-${index}`).value;
            serviceDay.date = document.getElementById(`edit-date-${index}`).value || null;
            
            // Update all customers with the old service day name
            if (oldName !== newName) {
                for (const customer of db.customers) {
                    if (customer.runDay === oldName) {
                        customer.runDay = newName;
                        await db.saveCustomer(customer);
                    }
                }
                
                // Delete old service day, save new one
                await db.deleteServiceDay(oldName);
            }
            
            const success = await db.saveServiceDay(serviceDay);
            if (success) {
                renderServiceDayAdminList();
                renderCustomerAdminList();
                renderRunDays();
                showToast('Service day updated successfully!', 'success');
            }
        }

        async function deleteServiceDay(index) {
            const serviceDay = db.serviceDays[index];
            const hasCustomers = db.customers.some(c => c.runDay === serviceDay.name);
            
            if (hasCustomers) {
                showToast('Cannot delete service day with customers assigned', 'error');
                return;
            }
            
            const success = await db.deleteServiceDay(serviceDay.name);
            if (success) {
                db.serviceDays.splice(index, 1);
                renderServiceDayAdminList();
                renderRunDays();
                showToast('Service day deleted', 'success');
            }
        }

        // Admin Dashboard Functions
        function populateAdminServiceDaySelect() {
            const select = document.getElementById('adminServiceDaySelect');
            select.innerHTML = '<option value="">Choose a service day...</option>';
            db.serviceDays.forEach(sd => {
                const option = document.createElement('option');
                option.value = sd.name;
                option.textContent = sd.name;
                select.appendChild(option);
            });
        }

        let currentAdminServiceDay = null;

        async function onServiceDaySelectChange() {
            const serviceDayName = document.getElementById('adminServiceDaySelect').value;
            const dateSelect = document.getElementById('adminDateSelect');
            
            if (!serviceDayName) {
                dateSelect.innerHTML = '<option value="">Choose a date...</option>';
                document.getElementById('adminRunsheetContainer').style.display = 'none';
                return;
            }
            
            // Fetch dates from both PODs and worker_calendar_events
            try {
                // Get POD dates
                const { data: podData, error: podError } = await supabase
                    .from('pods')
                    .select('date')
                    .eq('run_day', serviceDayName)
                    .order('date', { ascending: false });
                
                if (podError) throw podError;
                
                // Get scheduled dates from Google Calendar sync (worker_calendar_events)
                const { data: scheduledData, error: schedError } = await supabase
                    .from('worker_calendar_events')
                    .select('event_date')
                    .eq('service_day_name', serviceDayName)
                    .eq('is_service_day', true)
                    .order('event_date', { ascending: false });
                
                // Combine and deduplicate dates
                const allDates = new Set();
                if (podData) podData.forEach(p => allDates.add(p.date));
                if (scheduledData) scheduledData.forEach(s => allDates.add(s.event_date));
                
                // Filter dates: all past dates plus future dates in current month
                const today = formatDateLocal(new Date());
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                
                const validDates = [...allDates]
                    .filter(date => {
                        // Always include past dates
                        if (date <= today) return true;
                        // Include future dates only if they're in the current month
                        const dateObj = new Date(date + 'T00:00:00');
                        return dateObj.getMonth() === currentMonth && dateObj.getFullYear() === currentYear;
                    })
                    .sort((a, b) => b.localeCompare(a)) // newest first
                    .slice(0, 15); // increased limit to accommodate future dates
                
                // Build dropdown
                dateSelect.innerHTML = '<option value="">Choose a date...</option>';
                
                // Add dates (most recent/upcoming first)
                validDates.forEach(date => {
                    const isFuture = date > today;
                    const label = isFuture 
                        ? `${formatDisplayDate(date)} (upcoming)` 
                        : formatDisplayDate(date);
                    dateSelect.innerHTML += `<option value="${date}">${label}</option>`;
                });
                
            } catch (e) {
                console.error('Error fetching dates:', e);
                dateSelect.innerHTML = '<option value="">Error loading dates</option>';
            }
            
            document.getElementById('adminRunsheetContainer').style.display = 'none';
        }
        
        function formatDisplayDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-AU', { 
                weekday: 'short', 
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
        }
        
        function loadAdminRunsheet() {
            const serviceDayName = document.getElementById('adminServiceDaySelect').value;
            const selectedDate = document.getElementById('adminDateSelect').value;
            
            if (!serviceDayName || !selectedDate) {
                document.getElementById('adminRunsheetContainer').style.display = 'none';
                return;
            }

            currentAdminServiceDay = serviceDayName;
            currentAdminDateFilter = selectedDate;
            
            const serviceDay = db.serviceDays.find(sd => sd.name === serviceDayName);
            const customers = db.customers
                .filter(c => c.runDay === serviceDayName)
                .sort((a, b) => (a.order || 0) - (b.order || 0));
            
            const today = formatDateLocal(new Date());
            const isHistorical = selectedDate < today;
            
            // Determine the month to look for PODs (based on selected date)
            const selectedDateObj = new Date(selectedDate + 'T00:00:00');
            const viewMonth = selectedDateObj.getMonth();
            const viewYear = selectedDateObj.getFullYear();
            
            // Update header with context
            let titleText = `Service Day: ${serviceDayName} - ${formatDisplayDate(selectedDate)}`;
            document.getElementById('adminRunsheetTitle').textContent = titleText;
            document.getElementById('adminRunsheetEmployee').textContent = `Employee: ${serviceDay ? serviceDay.employee || 'Not assigned' : 'Not assigned'}`;
            document.getElementById('adminRunsheetDate').textContent = isHistorical ? 'Historical Data' : 'Current';
            
            // Show day invoiced checkbox (may have been hidden by ad-hoc view)
            const dayInvoicedContainer = document.getElementById('dayInvoicedContainer');
            if (dayInvoicedContainer) {
                dayInvoicedContainer.style.display = 'flex';
            }
            
            // Update day invoiced checkbox
            updateDayInvoicedUI(serviceDayName, selectedDate);
            
            // Build table
            const tbody = document.getElementById('adminRunsheetTableBody');
            tbody.innerHTML = '';
            
            // Add back to calendar button row
            const backRow = document.createElement('tr');
            backRow.innerHTML = `
                <td colspan="7" style="padding: 8px; background: #f3f4f6;">
                    <button class="btn btn-secondary" style="padding: 6px 16px; font-size: 13px;" onclick="backToAdminCalendar()">
                        ‚Üê Back to Calendar
                    </button>
                    <span style="margin-left: 12px; color: #6b7280;">Viewing: ${formatDisplayDate(selectedDate)} (${MONTH_NAMES[viewMonth]} ${viewYear})</span>
                </td>
            `;
            tbody.appendChild(backRow);
            
            customers.forEach(customer => {
                // Find POD for this customer within the viewed month (matches worker view logic)
                const pod = db.pods.find(p => {
                    if (p.customerId !== customer.id) return false;
                    const podDate = new Date(p.date + 'T00:00:00');
                    return podDate.getMonth() === viewMonth && podDate.getFullYear() === viewYear;
                });
                
                // Check if customer is skipped for this month
                const isSkipped = db.isCustomerSkipped(customer.id, viewMonth, viewYear);
                const skipReason = isSkipped ? db.getSkipReason(customer.id, viewMonth, viewYear) : '';
                
                // Check if this is an off-month for bi-monthly customers
                const customerIsOffMonth = isOffMonth(customer, viewMonth, viewYear);
                const scheduleLabel = getScheduleLabel(customer.serviceMonths);
                
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #e5e7eb';
                
                if (isSkipped) {
                    tr.style.background = '#f9fafb';
                    tr.style.opacity = '0.7';
                } else if (customerIsOffMonth) {
                    tr.style.background = '#fffbeb';
                }
                
                if (pod && !isSkipped) {
                    tr.style.cursor = 'pointer';
                    tr.onclick = () => viewPODFromOverview(pod.id);
                    tr.onmouseover = () => tr.style.background = '#f9fafb';
                    tr.onmouseout = () => tr.style.background = isSkipped ? '#f9fafb' : (customerIsOffMonth ? '#fffbeb' : '');
                }
                
                const productsStr = pod && pod.products && pod.products.length > 0 
                    ? pod.products.map(p => `${p.product} x${p.quantity}`).join(', ')
                    : '-';
                
                // Get service type and carbsolve from POD if available, otherwise show customer's values
                // Default to 'Service' if not set (most common type)
                const serviceType = pod ? (pod.serviceType || customer.serviceType || 'Service') : (customer.serviceType || 'Service');
                let carbsolve = pod ? (pod.carbsolve || customer.carbsolve || '-') : (customer.carbsolve || '-');
                // Clean up carbsolve display - strip any "Carbsolve - " or "Carb: " prefixes from old data
                if (carbsolve && carbsolve !== '-') {
                    carbsolve = carbsolve.replace(/^(Carbsolve\s*[-:]\s*|Carb:\s*)/i, '');
                }
                
                // Build schedule badge for bi-monthly customers
                let scheduleBadgeHtml = '';
                if (scheduleLabel && !isSkipped) {
                    if (customerIsOffMonth) {
                        scheduleBadgeHtml = ` <span style="background: #fef3c7; color: #92400e; padding: 2px 6px; border-radius: 8px; font-size: 10px;">‚è∏Ô∏è OFF MONTH</span>`;
                    } else {
                        scheduleBadgeHtml = ` <span style="background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 8px; font-size: 10px;">üìÖ ${scheduleLabel}</span>`;
                    }
                }
                
                // Customer name with skip indicator
                const customerNameDisplay = isSkipped 
                    ? `<span style="text-decoration: line-through; color: #9ca3af;">${customer.name}</span> <span style="background: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 8px; font-size: 10px;">${skipReason || 'Skipped'}</span>`
                    : customer.name + scheduleBadgeHtml;
                
                // Status column
                let statusDisplay;
                if (isSkipped) {
                    statusDisplay = '<span style="color: #9ca3af; font-size: 12px;">‚Äî</span>';
                } else if (pod) {
                    statusDisplay = '<span style="color: #16a34a; font-size: 18px;">‚úì</span>';
                } else {
                    statusDisplay = '-';
                }
                
                tr.innerHTML = `
                    <td style="padding: 12px; text-align: center;">
                        ${statusDisplay}
                    </td>
                    <td style="padding: 12px; text-align: center;" onclick="event.stopPropagation();">
                        ${customer.invoiceType === 'No Invoice' 
                            ? '<span style="color: #888; font-size: 12px;">No inv</span>'
                            : (isSkipped 
                                ? '<span style="color: #9ca3af;">‚Äî</span>'
                                : `<input type="checkbox" class="invoice-checkbox" data-pod-id="${pod ? pod.id : 0}" ${pod && db.invoiceStatus[pod.id] ? 'checked' : ''} 
                                   onchange="toggleInvoice(${pod ? pod.id : 0})" ${!pod ? 'disabled' : ''}>`)
                        }
                    </td>
                    <td style="padding: 12px;">${customerNameDisplay}</td>
                    <td style="padding: 12px;">${serviceType}</td>
                    <td style="padding: 12px;">${carbsolve}</td>
                    <td style="padding: 12px;">${productsStr}</td>
                    <td style="padding: 12px; font-size: 12px; font-style: italic;">${pod && pod.notes ? pod.notes : (customer.notes || '-')}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Update select all checkbox state
            updateInvoiceSelectAllState();
            
            // Render ad-hoc PODs for this date
            renderAdHocPodsTable(selectedDate);
            
            // Render tank movements for this date
            renderTankMovementsTable(serviceDayName, selectedDate);
            
            document.getElementById('adminRunsheetContainer').style.display = 'block';
        }
        
        function loadAdminAdHocRunsheet(selectedDate) {
            // Special view for truly ad-hoc items (from main menu, not from a runsheet)
            currentAdminServiceDay = 'Ad-Hoc';
            currentAdminDateFilter = selectedDate;
            
            // Get truly ad-hoc PODs (runDay = 'Ad-Hoc' and no sourceRunDay)
            const adHocPods = db.pods.filter(pod => 
                pod.date === selectedDate && 
                pod.runDay === 'Ad-Hoc' && 
                !pod.sourceRunDay
            );
            
            // Get truly ad-hoc tank movements
            const adHocTankMoves = db.tankMovements.filter(tm => 
                tm.date === selectedDate && 
                tm.runDay === 'Ad-Hoc' && 
                !tm.sourceRunDay
            );
            
            // Update header
            document.getElementById('adminRunsheetTitle').textContent = `Ad-Hoc Services - ${formatDisplayDate(selectedDate)}`;
            document.getElementById('adminRunsheetEmployee').textContent = 'Standalone ad-hoc services (not from a runsheet)';
            document.getElementById('adminRunsheetDate').textContent = '';
            
            // Hide day invoiced checkbox for ad-hoc
            const dayInvoicedContainer = document.getElementById('dayInvoicedContainer');
            if (dayInvoicedContainer) {
                dayInvoicedContainer.style.display = 'none';
            }
            
            // Build table
            const tbody = document.getElementById('adminRunsheetTableBody');
            tbody.innerHTML = '';
            
            // Add back to calendar button row
            const backRow = document.createElement('tr');
            backRow.innerHTML = `
                <td colspan="7" style="padding: 8px; background: #f3f4f6;">
                    <button class="btn" onclick="showCalendarView()" style="padding: 8px 16px;">
                        ‚Üê Back to Calendar
                    </button>
                </td>
            `;
            tbody.appendChild(backRow);
            
            // Add PODs
            adHocPods.forEach(pod => {
                const customer = db.customers.find(c => c.id === pod.customerId);
                const customerName = customer ? customer.name : (pod.customerName || 'Unknown');
                const productsStr = pod.products && pod.products.length > 0 
                    ? pod.products.map(p => `${p.product} x${p.quantity}`).join(', ')
                    : '-';
                const isDelivery = pod.serviceType === 'Delivery';
                const typeIcon = isDelivery ? 'üì¶' : 'üîß';
                const carbsolve = isDelivery ? '-' : (pod.carbsolve || '-');
                
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #e5e7eb';
                tr.style.background = '#fffbeb';
                tr.innerHTML = `
                    <td style="padding: 12px; text-align: center;">
                        <span style="color: #16a34a; font-size: 18px;">‚úì</span>
                    </td>
                    <td style="padding: 12px; text-align: center;">-</td>
                    <td style="padding: 12px;">${customerName}</td>
                    <td style="padding: 12px;">${typeIcon} ${pod.serviceType || 'Service'}</td>
                    <td style="padding: 12px;">${carbsolve}</td>
                    <td style="padding: 12px;">${productsStr}</td>
                    <td style="padding: 12px; font-size: 12px; font-style: italic;">${pod.notes || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Add tank movements
            adHocTankMoves.forEach(tm => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #e5e7eb';
                tr.style.background = '#eff6ff';
                tr.innerHTML = `
                    <td style="padding: 12px; text-align: center;">
                        <span style="color: #16a34a; font-size: 18px;">‚úì</span>
                    </td>
                    <td style="padding: 12px; text-align: center;">-</td>
                    <td style="padding: 12px;">${tm.customerName} <span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px;">Tank ${tm.movementType}</span></td>
                    <td style="padding: 12px;">üîÑ Tank ${tm.movementType}</td>
                    <td style="padding: 12px;">${tm.carbsolve || '-'}</td>
                    <td style="padding: 12px;">Placed: ${tm.tankNoPlaced || '-'} / Pulled: ${tm.tankNoPulled || '-'}</td>
                    <td style="padding: 12px; font-size: 12px; font-style: italic;">${tm.reason || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
            
            if (adHocPods.length === 0 && adHocTankMoves.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="7" style="padding: 24px; text-align: center; color: #6b7280;">
                        No ad-hoc services for this date
                    </td>
                `;
                tbody.appendChild(emptyRow);
            }
            
            // Hide the regular ad-hoc and tank movement sections
            const adHocSection = document.getElementById('adHocPodsSection');
            if (adHocSection) adHocSection.style.display = 'none';
            const tankSection = document.getElementById('tankMovementsSection');
            if (tankSection) tankSection.style.display = 'none';
            
            document.getElementById('adminRunsheetContainer').style.display = 'block';
        }
        
        function renderAdHocPodsTable(selectedDate) {
            // Get ad-hoc PODs that belong to this runsheet
            // New PODs: runDay = service day, isAdHoc = true
            // Old PODs: runDay = 'Ad-Hoc', sourceRunDay = service day
            const adHocPods = db.pods.filter(pod => {
                if (pod.date !== selectedDate) return false;
                // New format: isAdHoc flag and runDay matches
                if (pod.isAdHoc && pod.runDay === currentAdminServiceDay) {
                    return true;
                }
                // Legacy format: runDay is 'Ad-Hoc' and sourceRunDay matches
                if (pod.runDay === 'Ad-Hoc' && pod.sourceRunDay === currentAdminServiceDay) {
                    return true;
                }
                return false;
            });
            
            // Find or create section
            let section = document.getElementById('adHocPodsSection');
            if (!section) {
                section = document.createElement('div');
                section.id = 'adHocPodsSection';
                section.innerHTML = `
                    <h3 style="margin: 24px 0 12px; color: #92400e;">üìã Ad-Hoc Services</h3>
                    <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                        <thead>
                            <tr style="background: #fef3c7;">
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #f59e0b; width: 40px;">‚úì</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #f59e0b; width: 40px;">Inv</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #f59e0b;">Customer</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #f59e0b;">Type</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #f59e0b;">Carbsolve</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #f59e0b;">Products</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #f59e0b;">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="adHocPodsTableBody">
                        </tbody>
                    </table>
                `;
                // Insert before tank movements section
                const tankSection = document.getElementById('tankMovementsSection');
                if (tankSection) {
                    tankSection.parentNode.insertBefore(section, tankSection);
                } else {
                    document.getElementById('adminRunsheetContainer').appendChild(section);
                }
            }
            
            const tbody = document.getElementById('adHocPodsTableBody');
            
            if (adHocPods.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            tbody.innerHTML = '';
            
            adHocPods.forEach(pod => {
                const customer = db.customers.find(c => c.id === pod.customerId);
                const customerName = customer ? customer.name : (pod.customerName || 'Unknown Customer');
                const productsStr = pod.products && pod.products.length > 0 
                    ? pod.products.map(p => `${p.product} x${p.quantity}`).join(', ')
                    : '-';
                const isDelivery = pod.serviceType === 'Delivery';
                const typeIcon = isDelivery ? 'üì¶' : 'üîß';
                let carbsolve = isDelivery ? '-' : (pod.carbsolve || '-');
                if (carbsolve && carbsolve !== '-') {
                    carbsolve = carbsolve.replace(/^(Carbsolve\s*[-:]\s*|Carb:\s*)/i, '');
                }
                
                const tr = document.createElement('tr');
                tr.style.cssText = 'border-bottom: 1px solid #fde68a; cursor: pointer; background: #fffbeb;';
                tr.onclick = () => viewPODFromOverview(pod.id);
                tr.onmouseover = () => tr.style.background = '#fef3c7';
                tr.onmouseout = () => tr.style.background = '#fffbeb';
                
                tr.innerHTML = `
                    <td style="padding: 12px; text-align: center;">
                        <span style="color: #16a34a; font-size: 18px;">‚úì</span>
                    </td>
                    <td style="padding: 12px; text-align: center;" onclick="event.stopPropagation();">
                        <input type="checkbox" class="invoice-checkbox" data-pod-id="${pod.id}" ${db.invoiceStatus[pod.id] ? 'checked' : ''} 
                           onchange="toggleInvoice(${pod.id})">
                    </td>
                    <td style="padding: 12px;">
                        ${customerName}
                        <span style="background: #f59e0b; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 8px;">Ad-Hoc</span>
                    </td>
                    <td style="padding: 12px;">${typeIcon} ${pod.serviceType || 'Service'}</td>
                    <td style="padding: 12px;">${carbsolve}</td>
                    <td style="padding: 12px;">${productsStr}</td>
                    <td style="padding: 12px; font-size: 12px; font-style: italic;">${pod.notes || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function renderTankMovementsTable(serviceDayName, selectedDate) {
            // Show tank movements that belong to this runsheet:
            // 1. Regular movements: runDay matches and date matches
            // 2. Ad-hoc from this runsheet: sourceRunDay matches and date matches
            const movements = db.tankMovements.filter(tm => {
                if (tm.date !== selectedDate) return false;
                // Regular movement for this service day
                if (tm.runDay === serviceDayName) return true;
                // Ad-hoc created from this runsheet
                if (tm.sourceRunDay === serviceDayName) return true;
                return false;
            });
            
            const section = document.getElementById('tankMovementsSection');
            const tbody = document.getElementById('tankMovementsTableBody');
            
            if (movements.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            tbody.innerHTML = '';
            
            movements.forEach(tm => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #e5e7eb';
                if (tm.runDay === 'Ad-Hoc') {
                    tr.style.background = '#eff6ff';
                }
                
                const adHocBadge = tm.runDay === 'Ad-Hoc' 
                    ? '<span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; margin-left: 8px;">Ad-Hoc</span>'
                    : '';
                
                tr.innerHTML = `
                    <td style="padding: 10px; text-align: center;">
                        <span style="color: #16a34a; font-size: 18px;">‚úì</span>
                    </td>
                    <td style="padding: 10px;">${tm.customerName}${adHocBadge}</td>
                    <td style="padding: 10px;">
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; 
                            background: ${tm.movementType === 'Swap' ? '#fef3c7' : tm.movementType === 'Pull' ? '#fee2e2' : '#dcfce7'}; 
                            color: ${tm.movementType === 'Swap' ? '#92400e' : tm.movementType === 'Pull' ? '#991b1b' : '#166534'};">
                            ${tm.movementType}
                        </span>
                    </td>
                    <td style="padding: 10px;">${tm.tankNoPlaced || '-'}</td>
                    <td style="padding: 10px;">${tm.tankNoPulled || '-'}</td>
                    <td style="padding: 10px;">${tm.carbsolve || '-'}</td>
                    <td style="padding: 10px; font-size: 12px; font-style: italic;">${tm.reason || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function backToAdminCalendar() {
            currentAdminDateFilter = null; // Clear date filter
            document.getElementById('adminRunsheetContainer').style.display = 'none';
            document.getElementById('adminListContainer').style.display = 'none';
            document.getElementById('adminCalendarContainer').style.display = 'block';
            document.getElementById('calendarViewTab').classList.add('active');
            document.getElementById('listViewTab').classList.remove('active');
            renderAdminCalendar();
        }
        
        function viewPODFromOverview(podId) {
            const pod = db.pods.find(p => p.id === podId);
            if (!pod) {
                showToast('POD not found', 'error');
                return;
            }
            
            // Find the customer
            const customer = db.customers.find(c => c.id === pod.customerId);
            if (customer) {
                currentCustomer = customer;
            } else {
                // For ad-hoc PODs without a customer record
                currentCustomer = {
                    id: pod.customerId,
                    name: pod.customerName,
                    address: pod.customerAddress || ''
                };
            }
            currentRunDay = pod.runDay;
            
            // Show the POD view with the existing POD
            showExistingPod(pod);
        }

        async function toggleInvoice(podId) {
            if (podId) {
                db.invoiceStatus[podId] = !db.invoiceStatus[podId];
                await db.saveInvoiceStatus(podId, db.invoiceStatus[podId]);
                updateInvoiceSelectAllState();
            }
        }
        
        function updateInvoiceSelectAllState() {
            const checkboxes = document.querySelectorAll('.invoice-checkbox:not([disabled])');
            const selectAllCheckbox = document.getElementById('invoiceSelectAll');
            if (!selectAllCheckbox || checkboxes.length === 0) return;
            
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const someChecked = Array.from(checkboxes).some(cb => cb.checked);
            
            selectAllCheckbox.checked = allChecked;
            selectAllCheckbox.indeterminate = someChecked && !allChecked;
        }
        
        async function toggleAllInvoices(checked) {
            const checkboxes = document.querySelectorAll('.invoice-checkbox:not([disabled])');
            for (const cb of checkboxes) {
                const podId = parseInt(cb.dataset.podId);
                if (podId && cb.checked !== checked) {
                    cb.checked = checked;
                    db.invoiceStatus[podId] = checked;
                    await db.saveInvoiceStatus(podId, checked);
                }
            }
        }
        
        async function markAllInvoiced() {
            const checkboxes = document.querySelectorAll('.invoice-checkbox:not([disabled])');
            const uncheckedCount = Array.from(checkboxes).filter(cb => !cb.checked).length;
            
            if (uncheckedCount === 0) {
                showToast('All completed PODs are already marked as invoiced', 'warning');
                return;
            }
            
            if (!confirm(`Mark ${uncheckedCount} POD(s) as invoiced?`)) return;
            
            for (const cb of checkboxes) {
                const podId = parseInt(cb.dataset.podId);
                if (podId && !cb.checked) {
                    cb.checked = true;
                    db.invoiceStatus[podId] = true;
                    await db.saveInvoiceStatus(podId, true);
                }
            }
            
            updateInvoiceSelectAllState();
            showToast(`Marked ${uncheckedCount} POD(s) as invoiced`, 'success');
        }

        function populateExportServiceDayFilter() {
            const select = document.getElementById('exportRunDayFilter');
            select.innerHTML = '<option value="all">All Service Days</option>';
            db.serviceDays.forEach(sd => {
                const option = document.createElement('option');
                option.value = sd.name;
                option.textContent = sd.name;
                select.appendChild(option);
            });
        }

        async function exportRunsheetExcel() {
            if (!currentAdminServiceDay) return;
            
            const serviceDay = db.serviceDays.find(sd => sd.name === currentAdminServiceDay);
            const customers = db.customers
                .filter(c => c.runDay === currentAdminServiceDay)
                .sort((a, b) => (a.order || 0) - (b.order || 0));
            
            const today = new Date().toISOString().split('T')[0];
            const isHistorical = isPastMonth();
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Create data array with month info
            const monthLabel = isHistorical ? `${MONTH_NAMES[selectedMonth]} ${selectedYear}` : 'Current Month';
            const data = [
                ['Service Day:', currentAdminServiceDay],
                ['Employee:', serviceDay.employee || ''],
                ['Service Date:', serviceDay.date ? formatServiceDate(serviceDay.date) : ''],
                ['Month:', monthLabel],
                [''],
                ['Done', 'Invoice', 'Company', 'Phone', 'Address', 'Products Delivered', 'Repair Items', 'Notes', 'POD Date']
            ];
            
            customers.forEach(customer => {
                // For historical months, find any POD for that customer in the month
                // For current month, find today's POD
                let pod;
                if (isHistorical) {
                    pod = db.pods.find(p => p.customerId === customer.id);
                } else {
                    pod = db.pods.find(p => p.customerId === customer.id && p.date === today);
                }
                
                const saleProducts = pod && pod.products ? pod.products.filter(p => p.type !== 'repair') : [];
                const repairProducts = pod && pod.products ? pod.products.filter(p => p.type === 'repair') : [];
                
                const productsStr = saleProducts.length > 0 
                    ? saleProducts.map(p => `${p.product} x${p.quantity}`).join(', ')
                    : '';
                const repairsStr = repairProducts.length > 0 
                    ? repairProducts.map(p => `${p.product} x${p.quantity}`).join(', ')
                    : '';
                
                data.push([
                    pod ? 'Yes' : 'No',
                    pod && db.invoiceStatus[pod.id] ? 'Yes' : 'No',
                    customer.name,
                    customer.phone || '',
                    customer.address || '',
                    productsStr,
                    repairsStr,
                    customer.notes || '',
                    pod ? pod.date : ''
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Runsheet');
            
            // Download with month in filename
            const filename = isHistorical 
                ? `${currentAdminServiceDay}_${MONTH_NAMES[selectedMonth]}_${selectedYear}.xlsx`
                : `${currentAdminServiceDay}_${today}.xlsx`;
            XLSX.writeFile(wb, filename);
            showToast('Excel file downloaded!', 'success');
        }

        function updateDayInvoicedUI(serviceDayName, serviceDate) {
            const checkbox = document.getElementById('dayInvoicedCheckbox');
            const container = document.getElementById('dayInvoicedContainer');
            const timestamp = document.getElementById('dayInvoicedTimestamp');
            
            const isInvoiced = db.isServiceDayInvoiced(serviceDayName, serviceDate);
            const invoicedAt = db.getServiceDayInvoicedAt(serviceDayName, serviceDate);
            
            checkbox.checked = isInvoiced;
            
            if (isInvoiced) {
                container.style.background = '#dcfce7';
                container.style.borderLeft = '4px solid #16a34a';
                if (invoicedAt) {
                    const date = new Date(invoicedAt);
                    timestamp.textContent = `‚úì Invoiced ${date.toLocaleDateString('en-AU')} at ${date.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' })}`;
                } else {
                    timestamp.textContent = '‚úì Invoiced';
                }
            } else {
                container.style.background = '#f3f4f6';
                container.style.borderLeft = 'none';
                timestamp.textContent = '';
            }
        }
        
        async function toggleDayInvoiced() {
            if (!currentAdminServiceDay || !currentAdminDateFilter) return;
            
            const checkbox = document.getElementById('dayInvoicedCheckbox');
            const isInvoiced = checkbox.checked;
            
            const success = await db.saveServiceDayInvoiceStatus(currentAdminServiceDay, currentAdminDateFilter, isInvoiced);
            
            if (success) {
                updateDayInvoicedUI(currentAdminServiceDay, currentAdminDateFilter);
                showToast(isInvoiced ? 'Day marked as invoiced' : 'Day marked as not invoiced', 'success');
                
                // Refresh calendar to show updated status
                renderAdminCalendar();
            } else {
                // Revert checkbox on failure
                checkbox.checked = !isInvoiced;
                showToast('Error updating invoice status', 'error');
            }
        }

        function renderProductAdminList() {
            const list = document.getElementById('productAdminList');
            list.innerHTML = '';
            
            // Group by category for display
            const saleProducts = db.products.filter(p => typeof p === 'object' && p.category === 'sale');
            const repairProducts = db.products.filter(p => typeof p === 'object' && p.category === 'repair');
            const otherProducts = db.products.filter(p => typeof p === 'string' || (typeof p === 'object' && !p.category));
            
            function renderProductGroup(products, title) {
                if (products.length === 0) return;
                
                const header = document.createElement('div');
                header.className = 'product-category-header';
                header.textContent = title;
                list.appendChild(header);
                
                products.forEach((product, index) => {
                    const div = document.createElement('div');
                    div.className = 'customer-admin-item';
                    const productName = typeof product === 'string' ? product : (product.display_name || product.name);
                    const productId = typeof product === 'string' ? product : product.id;
                    div.id = `product-${productId}`;
                    div.innerHTML = `
                        <div class="customer-admin-info">
                            <strong>${productName}</strong>
                            ${typeof product === 'object' && product.category ? `<small style="color: #6b7280; margin-left: 8px;">${product.category}</small>` : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="delete-btn" onclick="deleteProduct('${productId}')">Delete</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
            
            renderProductGroup(saleProducts, 'Sale Items');
            renderProductGroup(repairProducts, 'Repair Items');
            renderProductGroup(otherProducts, 'Other Products');
            
            // If all arrays empty, show simple list (backward compat)
            if (saleProducts.length === 0 && repairProducts.length === 0 && otherProducts.length === 0) {
                db.products.forEach((product, index) => {
                    const div = document.createElement('div');
                    div.className = 'customer-admin-item';
                    const productName = typeof product === 'string' ? product : (product.display_name || product.name);
                    div.id = `product-${index}`;
                    div.innerHTML = `
                        <div class="customer-admin-info">
                            <strong>${productName}</strong>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="delete-btn" onclick="deleteProduct('${productName}')">Delete</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
        }

        async function deleteCustomer(id) {
            const success = await db.deleteCustomer(id);
            if (success) {
                db.customers = db.customers.filter(c => c.id !== id);
                renderCustomerAdminList();
                showToast('Customer deleted', 'success');
            }
        }

        async function deleteProduct(productId) {
            const success = await db.deleteProduct(productId);
            if (success) {
                // Remove by id or name
                db.products = db.products.filter(p => {
                    if (typeof p === 'string') return p !== productId;
                    return p.id !== productId && p.name !== productId;
                });
                renderProductAdminList();
                showToast('Product deleted', 'success');
            }
        }

        function showAdminTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-tab').forEach(t => t.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').style.display = 'block';
            
            // Load calendar sync settings when tab is shown
            if (tab === 'calendarSync') {
                loadCalendarSyncUI();
            }
        }
        
        function loadCalendarSyncUI() {
            // Load current ICS URL
            const icsInput = document.getElementById('calendarIcsUrl');
            if (db.calendarSyncSettings && db.calendarSyncSettings.ics_url) {
                icsInput.value = db.calendarSyncSettings.ics_url;
            }
            
            // Show sync status
            updateCalendarSyncStatusUI();
        }
        
        function updateCalendarSyncStatusUI() {
            const statusDiv = document.getElementById('calendarSyncStatus');
            const settings = db.calendarSyncSettings;
            
            if (!settings) {
                statusDiv.innerHTML = `
                    <p style="color: #6b7280;">Calendar sync not configured yet. Add your ICS URL above to get started.</p>
                `;
                return;
            }
            
            let statusColor = '#6b7280';
            let statusIcon = '‚è≥';
            if (settings.last_sync_status === 'success') {
                statusColor = '#16a34a';
                statusIcon = '‚úì';
            } else if (settings.last_sync_status === 'error') {
                statusColor = '#dc2626';
                statusIcon = '‚úó';
            }
            
            const lastSyncTime = settings.last_sync_at 
                ? new Date(settings.last_sync_at).toLocaleString('en-AU')
                : 'Never';
            
            statusDiv.innerHTML = `
                <div style="display: grid; gap: 8px;">
                    <div><strong>Last Sync:</strong> ${lastSyncTime}</div>
                    <div><strong>Status:</strong> <span style="color: ${statusColor};">${statusIcon} ${settings.last_sync_status || 'Not synced'}</span></div>
                    ${settings.last_sync_message ? `<div><strong>Details:</strong> ${settings.last_sync_message}</div>` : ''}
                    <div><strong>Scheduled Days Loaded:</strong> ${db.scheduledDays.length} for current month</div>
                </div>
            `;
        }
        
        async function saveCalendarIcsUrl() {
            const icsUrl = document.getElementById('calendarIcsUrl').value.trim();
            
            if (!icsUrl) {
                showToast('Please enter an ICS URL', 'error');
                return;
            }
            
            // Basic validation
            if (!icsUrl.includes('calendar.google.com') && !icsUrl.endsWith('.ics')) {
                showToast('This doesn\'t look like a valid Google Calendar ICS URL', 'error');
                return;
            }
            
            showToast('Saving ICS URL...', 'success');
            const success = await db.saveCalendarIcsUrl(icsUrl);
            
            if (success) {
                showToast('ICS URL saved! Click "Sync Now" to pull calendar data.', 'success');
                await db.loadCalendarSyncSettings();
                updateCalendarSyncStatusUI();
            } else {
                showToast('Failed to save ICS URL', 'error');
            }
        }
        
        async function triggerCalendarSync() {
            const icsUrl = document.getElementById('calendarIcsUrl').value.trim();
            
            if (!icsUrl && (!db.calendarSyncSettings || !db.calendarSyncSettings.ics_url)) {
                showToast('Please save an ICS URL first', 'error');
                return;
            }
            
            showToast('Starting calendar sync...', 'success');
            
            const result = await db.triggerCalendarSync();
            
            if (result.success) {
                showToast(`Sync complete! ${result.message}`, 'success');
                // Reload data
                await db.loadCalendarSyncSettings();
                await db.loadScheduledDaysForMonth();
                updateCalendarSyncStatusUI();
                // Refresh calendar if visible
                if (document.getElementById('adminCalendarContainer') && 
                    document.getElementById('adminCalendarContainer').style.display !== 'none') {
                    renderAdminCalendar();
                }
            } else {
                showToast(`Sync failed: ${result.error || 'Unknown error'}`, 'error');
                await db.loadCalendarSyncSettings();
                updateCalendarSyncStatusUI();
            }
        }

        // Export PODs
        function filterPODs() {
            const runDayFilter = document.getElementById('exportRunDayFilter').value;
            const dateFilter = document.getElementById('exportDateFilter').value;
            
            let filteredPODs = db.pods;
            
            if (runDayFilter !== 'all') {
                filteredPODs = filteredPODs.filter(pod => pod.runDay === runDayFilter);
            }
            
            if (dateFilter) {
                filteredPODs = filteredPODs.filter(pod => pod.date === dateFilter);
            }
            
            renderExportList(filteredPODs);
        }

        function renderExportList(pods) {
            const list = document.getElementById('exportPodList');
            
            if (pods.length === 0) {
                list.innerHTML = '<div class="card"><p style="text-align: center; color: #6b7280;">No PODs found matching the filters.</p></div>';
                return;
            }
            
            list.innerHTML = '';
            pods.forEach(pod => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <strong style="font-size: 16px;">${pod.customerName}</strong>
                            <div style="color: #6b7280; font-size: 14px;">${pod.date} - ${pod.runDay}</div>
                            <div style="color: #9ca3af; font-size: 12px; font-style: italic; margin-top: 4px;">${formatTimestamp(pod.timestamp)}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" onclick="viewPOD(${pod.id})" style="flex: 1;">View</button>
                        <button class="btn btn-success" onclick="downloadPOD(${pod.id})" style="flex: 1;">Download PDF</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function viewPOD(podId) {
            const pod = db.pods.find(p => p.id === podId);
            if (!pod) return;

            const modalContent = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;" onclick="this.remove()">
                    <div style="max-width: 600px; margin: 20px auto; background: white; border-radius: 8px; padding: 20px;" onclick="event.stopPropagation()">
                        <div class="pod-header">
                            <h2 style="color: #374151;">Proof of Delivery</h2>
                            <div style="color: #6b7280; margin-top: 4px;">POD #${pod.id}</div>
                        </div>
                        
                        <div class="pod-section">
                            <h3>Customer Information</h3>
                            <div class="pod-field"><strong>Name:</strong> <span>${pod.customerName}</span></div>
                            <div class="pod-field"><strong>Address:</strong> <span>${pod.customerAddress}</span></div>
                            <div class="pod-field"><strong>Run Day:</strong> <span>${pod.runDay}</span></div>
                            <div class="pod-field"><strong>Date:</strong> <span>${pod.date}</span></div>
                            <div class="pod-field"><strong>Time:</strong> <span>${formatTimestamp(pod.timestamp)}</span></div>
                        </div>

                        <div class="pod-section">
                            <h3>Service Details</h3>
                            <div class="pod-field"><strong>Tank Serviced:</strong> <span>${pod.tankServiced}</span></div>
                            ${pod.serviceNotes ? `<div class="pod-field"><strong>Service Notes:</strong> <span>${pod.serviceNotes}</span></div>` : ''}
                        </div>

                        ${pod.products && pod.products.length > 0 ? `
                            ${pod.products.filter(p => p.type !== 'repair').length > 0 ? `
                                <div class="pod-section">
                                    <h3>Products Delivered</h3>
                                    ${pod.products.filter(p => p.type !== 'repair').map(p => `
                                        <div class="pod-field"><strong>${p.product}:</strong> <span>${p.quantity}</span></div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            ${pod.products.filter(p => p.type === 'repair').length > 0 ? `
                                <div class="pod-section">
                                    <h3>Repair Items</h3>
                                    ${pod.products.filter(p => p.type === 'repair').map(p => `
                                        <div class="pod-field"><strong>${p.product}:</strong> <span>${p.quantity}</span></div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        ` : ''}

                        ${pod.notes ? `
                            <div class="pod-section">
                                <h3>Notes</h3>
                                <p style="color: #374151;">${pod.notes}</p>
                            </div>
                        ` : ''}

                        ${pod.photo ? `
                            <div class="pod-section">
                                <h3>Photo</h3>
                                <img src="${pod.photo}" class="photo-image">
                            </div>
                        ` : ''}

                        <div class="pod-section">
                            <h3>Customer Signature</h3>
                            ${pod.customerNotAvailable ? 
                                '<p style="color: #f59e0b; font-weight: 500;">‚ö†Ô∏è Customer not available - No signature obtained</p>' : 
                                pod.signature ? '<img src="' + pod.signature + '" class="signature-image">' : '<p>No signature</p>'
                            }
                        </div>

                        <button class="btn btn-secondary" onclick="this.closest('div[style*=fixed]').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        async function downloadPOD(podId) {
            const pod = db.pods.find(p => p.id === podId);
            if (!pod) return;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            let yPos = 20;

            // Header
            pdf.setFontSize(20);
            pdf.setTextColor(37, 99, 235);
            pdf.text('PROOF OF DELIVERY', 20, yPos);
            yPos += 10;

            pdf.setFontSize(10);
            pdf.setTextColor(100, 100, 100);
            pdf.text(`POD #${pod.id}`, 20, yPos);
            yPos += 15;

            // Customer Information
            pdf.setFontSize(12);
            pdf.setTextColor(37, 99, 235);
            pdf.text('Customer Information', 20, yPos);
            yPos += 7;

            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);
            pdf.text(`Name: ${pod.customerName}`, 20, yPos);
            yPos += 6;
            pdf.text(`Address: ${pod.customerAddress}`, 20, yPos);
            yPos += 6;
            pdf.text(`Run Day: ${pod.runDay}`, 20, yPos);
            yPos += 6;
            pdf.text(`Date: ${pod.date}`, 20, yPos);
            yPos += 6;
            pdf.text(`Time: ${formatTimestamp(pod.timestamp)}`, 20, yPos);
            yPos += 12;

            // Service Details
            pdf.setFontSize(12);
            pdf.setTextColor(37, 99, 235);
            pdf.text('Service Details', 20, yPos);
            yPos += 7;

            pdf.setFontSize(10);
            pdf.setTextColor(0, 0, 0);
            pdf.text(`Tank Serviced: ${pod.tankServiced}`, 20, yPos);
            yPos += 6;
            if (pod.serviceNotes) {
                pdf.text(`Service Notes: ${pod.serviceNotes}`, 20, yPos);
                yPos += 6;
            }
            yPos += 6;

            // Products Delivered
            const saleProducts = pod.products ? pod.products.filter(p => p.type !== 'repair') : [];
            if (saleProducts.length > 0) {
                pdf.setFontSize(12);
                pdf.setTextColor(37, 99, 235);
                pdf.text('Products Delivered', 20, yPos);
                yPos += 7;

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                saleProducts.forEach(p => {
                    pdf.text(`${p.product}: ${p.quantity}`, 20, yPos);
                    yPos += 6;
                });
                yPos += 6;
            }

            // Repair Items
            const repairProducts = pod.products ? pod.products.filter(p => p.type === 'repair') : [];
            if (repairProducts.length > 0) {
                pdf.setFontSize(12);
                pdf.setTextColor(37, 99, 235);
                pdf.text('Repair Items', 20, yPos);
                yPos += 7;

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                repairProducts.forEach(p => {
                    pdf.text(`${p.product}: ${p.quantity}`, 20, yPos);
                    yPos += 6;
                });
                yPos += 6;
            }

            // Notes
            if (pod.notes) {
                pdf.setFontSize(12);
                pdf.setTextColor(37, 99, 235);
                pdf.text('Notes', 20, yPos);
                yPos += 7;

                pdf.setFontSize(10);
                pdf.setTextColor(0, 0, 0);
                const splitNotes = pdf.splitTextToSize(pod.notes, 170);
                pdf.text(splitNotes, 20, yPos);
                yPos += (splitNotes.length * 6) + 6;
            }

            // Photo
            if (pod.photo) {
                if (yPos > 220) {
                    pdf.addPage();
                    yPos = 20;
                }
                pdf.setFontSize(12);
                pdf.setTextColor(37, 99, 235);
                pdf.text('Photo', 20, yPos);
                yPos += 7;
                
                pdf.addImage(pod.photo, 'JPEG', 20, yPos, 80, 60);
                yPos += 66;
            }

            // Signature
            if (yPos > 200) {
                pdf.addPage();
                yPos = 20;
            }
            pdf.setFontSize(12);
            pdf.setTextColor(37, 99, 235);
            pdf.text('Customer Signature', 20, yPos);
            yPos += 7;
            
            if (pod.customerNotAvailable) {
                pdf.setFontSize(10);
                pdf.setTextColor(245, 158, 11);
                pdf.text('Customer not available - No signature obtained', 20, yPos);
            } else if (pod.signature) {
                pdf.addImage(pod.signature, 'PNG', 20, yPos, 60, 30);
            } else {
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100);
                pdf.text('No signature', 20, yPos);
            }

            // Save
            pdf.save(`POD_${pod.customerName.replace(/\s+/g, '_')}_${pod.date}.pdf`);
        }

        // Initialize signature pad
        initSignaturePad();

        // Excel Upload Functions
        const uploadArea = document.getElementById('uploadArea');
        
        // Drag and drop
        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) {
                    processExcelFile(file);
                }
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                processExcelFile(file);
            }
        }

        async function processExcelFile(file) {
            const statusDiv = document.getElementById('importStatus');
            statusDiv.innerHTML = '<div class="import-status">Processing file...</div>';

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    let importedCount = 0;
                    let errorCount = 0;

                    // Process rows (skip header if exists)
                    // Expected columns: Name | Service Day | Address | Phone | Service Type | Carbsolve | Waste | Code | Notes
                    for (let index = 0; index < jsonData.length; index++) {
                        const row = jsonData[index];
                        // Skip empty rows
                        if (!row[0] || !row[1]) continue;
                        
                        let customerName = String(row[0]).trim();
                        const serviceDay = String(row[1]).trim();
                        const address = row[2] ? String(row[2]).trim() : '';
                        const phone = row[3] ? String(row[3]).trim() : '';
                        const serviceType = row[4] ? String(row[4]).trim() : '';
                        const carbsolve = row[5] ? String(row[5]).trim() : '';
                        const waste = row[6] ? String(row[6]).trim() : '';
                        const code = row[7] ? String(row[7]).trim() : '';
                        const notes = row[8] ? String(row[8]).trim() : '';
                        
                        // Check for existing customers with same name (handle multi-tank scenarios)
                        const existingWithSameName = db.customers.filter(c => 
                            c.name.toLowerCase() === customerName.toLowerCase() ||
                            c.name.toLowerCase().startsWith(customerName.toLowerCase() + ' - tank')
                        );
                        
                        // Check if exact match exists (same name, same day, same carbsolve)
                        const exactMatch = existingWithSameName.find(c => 
                            c.runDay === serviceDay && 
                            c.carbsolve === carbsolve &&
                            !c.name.toLowerCase().includes(' - tank')
                        );
                        
                        if (exactMatch) {
                            // Skip true duplicates
                            continue;
                        }
                        
                        // Check if this is a multi-tank situation (same name, same day, different carbsolve)
                        const sameDayEntries = existingWithSameName.filter(c => c.runDay === serviceDay);
                        
                        if (sameDayEntries.length > 0) {
                            // This is a multi-tank customer - append tank number
                            const tankNumber = sameDayEntries.length + 1;
                            
                            // If first entry doesn't have tank suffix, rename it
                            const firstEntry = sameDayEntries.find(c => !c.name.toLowerCase().includes(' - tank'));
                            if (firstEntry) {
                                firstEntry.name = `${firstEntry.name} - Tank 1`;
                                await db.saveCustomer(firstEntry);
                            }
                            
                            customerName = `${customerName} - Tank ${tankNumber}`;
                        }
                        
                        // Check if this exact name now exists (after potential renaming)
                        const stillExists = db.customers.some(c => 
                            c.name.toLowerCase() === customerName.toLowerCase()
                        );
                        
                        if (!stillExists) {
                            const customer = {
                                id: Date.now() + index,
                                name: customerName,
                                runDay: serviceDay,
                                address: address,
                                phone: phone,
                                serviceType: serviceType,
                                carbsolve: carbsolve,
                                waste: waste,
                                code: code,
                                notes: notes,
                                order: db.customers.length + importedCount
                            };
                            
                            await db.saveCustomer(customer);
                            db.customers.push(customer);
                            importedCount++;
                            
                            // Add service day if it doesn't exist
                            if (!db.serviceDays.some(sd => sd.name === serviceDay)) {
                                const newServiceDay = {
                                    name: serviceDay,
                                    employee: '',
                                    date: null
                                };
                                await db.saveServiceDay(newServiceDay);
                                db.serviceDays.push(newServiceDay);
                            }
                        }
                    }

                    renderCustomerAdminList();
                    renderServiceDayAdminList();
                    renderRunDays();

                    statusDiv.innerHTML = `
                        <div class="import-status success">
                            ‚úì Successfully imported ${importedCount} customers
                            ${errorCount > 0 ? `<br>‚ö† ${errorCount} rows skipped (invalid data)` : ''}
                        </div>
                    `;

                    // Clear file input
                    document.getElementById('excelFileInput').value = '';

                } catch (error) {
                    statusDiv.innerHTML = `
                        <div class="import-status error">
                            ‚úó Error processing file: ${error.message}
                            <br>Expected columns: Name | Service Day | Address | Phone | Service Type | Carbsolve | Waste | Code | Notes
                        </div>
                    `;
                }
            };

            reader.onerror = function() {
                statusDiv.innerHTML = '<div class="import-status error">‚úó Error reading file</div>';
            };

            reader.readAsArrayBuffer(file);
        }

        // Customer Search Modal Functions
        let isAdHocService = false;
        let adHocCustomerName = '';
        let adHocServiceType = 'Service'; // 'Service' or 'Delivery'
        let adHocSourceRunDay = null; // Track which runsheet the ad-hoc was created from
        
        function updateAdHocTypeSelection() {
            const serviceLabel = document.getElementById('adHocServiceLabel');
            const deliveryLabel = document.getElementById('adHocDeliveryLabel');
            const selectedType = document.querySelector('input[name="adHocType"]:checked').value;
            adHocServiceType = selectedType;
            
            // Update visual selection
            serviceLabel.style.border = selectedType === 'Service' ? '2px solid #3b82f6' : '2px solid transparent';
            serviceLabel.style.background = selectedType === 'Service' ? '#dbeafe' : '#f3f4f6';
            deliveryLabel.style.border = selectedType === 'Delivery' ? '2px solid #3b82f6' : '2px solid transparent';
            deliveryLabel.style.background = selectedType === 'Delivery' ? '#dbeafe' : '#f3f4f6';
        }
        
        function showMainMenuAdHocWarning() {
            if (confirm('‚ö†Ô∏è Creating an ad-hoc service from the main menu.\n\nIf you are completing a service day, please add the ad-hoc service/delivery from the runsheet via the ‚ûï button instead.\n\nContinue from main menu?')) {
                showCustomerSearchModal(null); // null = main menu origin
            }
        }
        
        function showMainMenuTankWarning() {
            if (confirm('‚ö†Ô∏è Creating a tank movement from the main menu.\n\nIf you are completing a service day, please add the tank movement from the runsheet via the ‚ûï button instead.\n\nContinue from main menu?')) {
                showTankMovementModal(null); // null = main menu origin
            }
        }
        
        function showCustomerSearchModal(sourceRunDay = null) {
            // Prevent ad-hoc services in historical months
            if (isPastMonth()) {
                showToast('Cannot create new PODs for past months. Switch to the current month.', 'error');
                return;
            }
            
            // Track where this ad-hoc is being created from
            adHocSourceRunDay = sourceRunDay;
            
            document.getElementById('customerSearchModal').classList.add('active');
            document.getElementById('customerSearchInput').value = '';
            document.getElementById('freetextCustomerName').value = '';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchHint').style.display = 'block';
            
            // Reset service type selection to Service
            adHocServiceType = 'Service';
            document.querySelector('input[name="adHocType"][value="Service"]').checked = true;
            updateAdHocTypeSelection();
            
            setTimeout(() => document.getElementById('customerSearchInput').focus(), 100);
        }
        
        function hideCustomerSearchModal() {
            document.getElementById('customerSearchModal').classList.remove('active');
        }
        
        function handleCustomerSearch(query) {
            const resultsDiv = document.getElementById('searchResults');
            const hintDiv = document.getElementById('searchHint');
            
            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                hintDiv.style.display = 'block';
                hintDiv.textContent = 'Type at least 2 characters to search';
                return;
            }
            
            const queryLower = query.toLowerCase();
            const allMatches = db.customers.filter(c => {
                // Match against customer name
                return c.name && c.name.toLowerCase().includes(queryLower);
            });
            
            // Sort alphabetically
            allMatches.sort((a, b) => a.name.localeCompare(b.name, undefined, { sensitivity: 'base' }));
            
            // Take first 50 results for display
            const matches = allMatches.slice(0, 50);
            
            hintDiv.style.display = 'none';
            
            if (allMatches.length === 0) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="search-hint">No customers found</div>';
                return;
            }
            
            resultsDiv.style.display = 'block';
            
            let html = '';
            
            // Show count if more results exist
            if (allMatches.length > 50) {
                html += `<div style="padding: 8px 12px; background: #f3f4f6; font-size: 12px; color: #6b7280; border-bottom: 1px solid #e5e7eb;">
                    50 of ${allMatches.length} matches shown
                </div>`;
            } else if (allMatches.length > 1) {
                html += `<div style="padding: 8px 12px; background: #f3f4f6; font-size: 12px; color: #6b7280; border-bottom: 1px solid #e5e7eb;">
                    ${allMatches.length} matches found
                </div>`;
            }
            
            html += matches.map(c => {
                const displayType = c.serviceType || 'Service';
                const typeColors = {
                    'Service': { bg: '#f3f4f6', text: '#374151' },
                    'Delivery': { bg: '#dbeafe', text: '#1e40af' },
                    'Check': { bg: '#fef3c7', text: '#92400e' }
                };
                const typeStyle = typeColors[displayType] || typeColors['Service'];
                
                return `
                <div class="search-result-item" onclick="selectSearchCustomer(${c.id})">
                    <div class="search-result-name">${c.name}</div>
                    <div class="search-result-meta">
                        ${c.address ? c.address : ''}
                        ${c.runDay ? ` ‚Ä¢ Day: ${c.runDay}` : ' ‚Ä¢ No regular day'}
                    </div>
                    <span class="search-result-carbsolve" style="background: ${typeStyle.bg}; color: ${typeStyle.text};">${displayType}</span>
                    ${c.carbsolve ? `<span class="search-result-carbsolve">${c.carbsolve}</span>` : ''}
                    ${c.waste ? `<span class="search-result-carbsolve" style="background: #fef3c7; color: #92400e;">üõ¢Ô∏è ${c.waste}</span>` : ''}
                </div>
            `}).join('');
            
            resultsDiv.innerHTML = html;
        }
        
        function selectSearchCustomer(customerId) {
            const customer = db.customers.find(c => c.id === customerId);
            if (!customer) {
                showToast('Customer not found', 'error');
                return;
            }
            
            hideCustomerSearchModal();
            isAdHocService = true;
            currentCustomer = customer;
            
            // If ad-hoc was initiated from a runsheet, use that runsheet's day
            // If from main menu (adHocSourceRunDay is null), use 'Ad-Hoc'
            currentRunDay = adHocSourceRunDay || 'Ad-Hoc';
            
            showNewPodForm();
            
            // Update header to show it's an ad-hoc service/delivery
            const typeLabel = adHocServiceType === 'Delivery' ? 'üì¶ Delivery' : 'üîß Service';
            document.getElementById('podCustomerName').textContent = customer.name + ` (${typeLabel})`;
            
            // Show/hide tank serviced section based on type
            const tankSection = document.getElementById('tankServicedSection');
            if (tankSection) {
                tankSection.style.display = adHocServiceType === 'Delivery' ? 'none' : 'block';
            }
        }
        
        function startAdHocService() {
            const customerName = document.getElementById('freetextCustomerName').value.trim();
            
            if (!customerName) {
                showToast('Please enter a customer name', 'error');
                return;
            }
            
            hideCustomerSearchModal();
            isAdHocService = true;
            adHocCustomerName = customerName;
            
            // If ad-hoc was initiated from a runsheet, use that runsheet's day
            // If from main menu (adHocSourceRunDay is null), use 'Ad-Hoc'
            const effectiveRunDay = adHocSourceRunDay || 'Ad-Hoc';
            
            // Create a temporary customer object for the POD
            currentCustomer = {
                id: null, // Will be null for freetext customers
                name: customerName,
                address: '',
                phone: '',
                runDay: effectiveRunDay,
                carbsolve: '',
                specialInstructions: '',
                code: ''
            };
            currentRunDay = effectiveRunDay;
            
            showNewPodForm();
            
            // Update header to show it's an ad-hoc service/delivery
            const typeLabel = adHocServiceType === 'Delivery' ? 'üì¶ Delivery' : 'üîß Service';
            document.getElementById('podCustomerName').textContent = customerName + ` (New - ${typeLabel})`;
            
            // Show/hide tank serviced section based on type
            const tankSection = document.getElementById('tankServicedSection');
            if (tankSection) {
                tankSection.style.display = adHocServiceType === 'Delivery' ? 'none' : 'block';
            }
        }

        // Customer Edit Modal Functions
        function showCustomerEditModal(customerId) {
            const customer = db.customers.find(c => c.id === customerId);
            if (!customer) {
                showToast('Customer not found', 'error');
                return;
            }
            
            document.getElementById('editCustomerId').value = customerId;
            document.getElementById('editCustomerName').textContent = customer.name;
            document.getElementById('editCustomerCode').value = customer.code || '';
            document.getElementById('editCustomerNotes').value = customer.notes || '';
            document.getElementById('editCustomerSpecialInstructions').value = customer.specialInstructions || '';
            
            // Load service schedule
            const scheduleSelect = document.getElementById('editCustomerSchedule');
            const customContainer = document.getElementById('customMonthsContainer');
            const serviceMonths = customer.serviceMonths || [];
            
            // Reset custom checkboxes
            document.querySelectorAll('#customMonthsContainer input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            if (serviceMonths.length === 0) {
                scheduleSelect.value = '';
                customContainer.style.display = 'none';
            } else {
                const monthsStr = serviceMonths.sort((a,b) => a-b).join(',');
                // Check if it matches a preset
                const presets = ['1,3,5,7,9,11', '2,4,6,8,10,12', '3,6,9,12', '1,4,7,10', '2,5,8,11'];
                if (presets.includes(monthsStr)) {
                    scheduleSelect.value = monthsStr;
                    customContainer.style.display = 'none';
                } else {
                    scheduleSelect.value = 'custom';
                    customContainer.style.display = 'block';
                    // Check the appropriate month checkboxes
                    serviceMonths.forEach(m => {
                        const cb = document.querySelector(`#customMonthsContainer input[value="${m}"]`);
                        if (cb) cb.checked = true;
                    });
                }
            }
            
            document.getElementById('customerEditModal').classList.add('active');
        }
        
        // Handle schedule dropdown change
        document.getElementById('editCustomerSchedule')?.addEventListener('change', function() {
            const customContainer = document.getElementById('customMonthsContainer');
            if (this.value === 'custom') {
                customContainer.style.display = 'block';
            } else {
                customContainer.style.display = 'none';
            }
        });
        
        function hideCustomerEditModal() {
            document.getElementById('customerEditModal').classList.remove('active');
        }
        
        async function saveCustomerEdit() {
            const customerId = parseInt(document.getElementById('editCustomerId').value);
            const code = document.getElementById('editCustomerCode').value.trim();
            const notes = document.getElementById('editCustomerNotes').value.trim();
            const specialInstructions = document.getElementById('editCustomerSpecialInstructions').value.trim();
            
            // Get service schedule
            const scheduleSelect = document.getElementById('editCustomerSchedule');
            let serviceMonths = null;
            
            if (scheduleSelect.value === 'custom') {
                // Get checked months from checkboxes
                const checkedMonths = [];
                document.querySelectorAll('#customMonthsContainer input[type="checkbox"]:checked').forEach(cb => {
                    checkedMonths.push(parseInt(cb.value));
                });
                if (checkedMonths.length > 0) {
                    serviceMonths = checkedMonths.sort((a, b) => a - b);
                }
            } else if (scheduleSelect.value) {
                // Parse preset value
                serviceMonths = scheduleSelect.value.split(',').map(m => parseInt(m));
            }
            
            const customer = db.customers.find(c => c.id === customerId);
            if (!customer) {
                showToast('Customer not found', 'error');
                return;
            }
            
            customer.code = code;
            customer.notes = notes;
            customer.specialInstructions = specialInstructions;
            customer.serviceMonths = serviceMonths;
            
            try {
                await db.saveCustomer(customer);
                hideCustomerEditModal();
                renderCustomerList();
                showToast('Customer updated successfully!', 'success');
            } catch (error) {
                showToast('Error saving customer: ' + error.message, 'error');
            }
        }

        // Tank Movement Modal Functions
        let selectedTankMovementCustomer = null;
        let tankMovementSourceRunDay = null; // Track which runsheet the tank movement was created from
        
        function showActionChooser() {
            // Prevent in historical months
            if (isPastMonth()) {
                showToast('Cannot create entries for past months.', 'error');
                return;
            }
            document.getElementById('actionChooserModal').classList.add('active');
        }
        
        function hideActionChooser() {
            document.getElementById('actionChooserModal').classList.remove('active');
        }
        
        function showTankMovementModal(sourceRunDay = null) {
            // Prevent in historical months
            if (isPastMonth()) {
                showToast('Cannot create tank movements for past months.', 'error');
                return;
            }
            
            // Track where this tank movement is being created from
            tankMovementSourceRunDay = sourceRunDay;
            
            document.getElementById('tankMovementModal').classList.add('active');
            document.getElementById('tankMovementCustomerSearch').value = '';
            document.getElementById('tankMovementSearchResults').style.display = 'none';
            document.getElementById('tankMovementSelectedCustomer').style.display = 'none';
            document.querySelector('input[name="movementType"][value="Swap"]').checked = true;
            document.getElementById('tankNoPlaced').value = '';
            document.getElementById('tankNoPulled').value = '';
            document.getElementById('tankMovementCarbsolve').value = '';
            document.getElementById('tankMovementReason').value = '';
            selectedTankMovementCustomer = null;
            
            setTimeout(() => document.getElementById('tankMovementCustomerSearch').focus(), 100);
        }
        
        function hideTankMovementModal() {
            document.getElementById('tankMovementModal').classList.remove('active');
            selectedTankMovementCustomer = null;
        }
        
        function handleTankMovementSearch(query) {
            const resultsDiv = document.getElementById('tankMovementSearchResults');
            
            if (query.length < 3) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            const queryLower = query.toLowerCase();
            const matches = db.customers.filter(c => {
                // Only match against customer name
                return c.name && c.name.toLowerCase().includes(queryLower);
            }).slice(0, 10);
            
            if (matches.length === 0) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = '<div class="search-hint">No customers found</div>';
                return;
            }
            
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = matches.map(c => `
                <div class="search-result-item" onclick="selectTankMovementCustomer(${c.id})">
                    <div class="search-result-name">${c.name}</div>
                    <div class="search-result-meta">${c.address || ''} ${c.runDay ? '‚Ä¢ ' + c.runDay : ''}</div>
                </div>
            `).join('');
        }
        
        function selectTankMovementCustomer(customerId) {
            const customer = db.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            selectedTankMovementCustomer = customer;
            document.getElementById('tankMovementCustomerSearch').value = '';
            document.getElementById('tankMovementSearchResults').style.display = 'none';
            document.getElementById('tankMovementSelectedCustomer').style.display = 'block';
            document.getElementById('tankMovementCustomerName').textContent = customer.name;
            
            // Auto-fill carbsolve if customer has one
            if (customer.carbsolve) {
                const carbsolveSelect = document.getElementById('tankMovementCarbsolve');
                const cleanCarbsolve = customer.carbsolve.replace(/^(Carbsolve\s*[-:]\s*|Carb:\s*)/i, '');
                carbsolveSelect.value = cleanCarbsolve;
            }
        }
        
        function clearTankMovementCustomer() {
            selectedTankMovementCustomer = null;
            document.getElementById('tankMovementSelectedCustomer').style.display = 'none';
            document.getElementById('tankMovementCustomerSearch').value = '';
            document.getElementById('tankMovementCustomerSearch').focus();
        }
        
        async function saveTankMovement() {
            if (!selectedTankMovementCustomer) {
                showToast('Please select a customer', 'error');
                return;
            }
            
            const movementType = document.querySelector('input[name="movementType"]:checked').value;
            const tankNoPlaced = document.getElementById('tankNoPlaced').value.trim();
            const tankNoPulled = document.getElementById('tankNoPulled').value.trim();
            const carbsolve = document.getElementById('tankMovementCarbsolve').value;
            const reason = document.getElementById('tankMovementReason').value.trim();
            
            // Validation based on movement type
            if (movementType === 'Swap' && (!tankNoPlaced || !tankNoPulled)) {
                showToast('Swap requires both tank numbers', 'error');
                return;
            }
            if (movementType === 'Pull' && !tankNoPulled) {
                showToast('Pull requires tank number pulled', 'error');
                return;
            }
            if (movementType === 'Place' && !tankNoPlaced) {
                showToast('Place requires tank number placed', 'error');
                return;
            }
            
            const nowUTC = new Date();
            const workDate = currentServiceDate || formatDateLocal(new Date());
            
            // If tank movement was initiated from a runsheet, use that runsheet's day
            // If from main menu (tankMovementSourceRunDay is null), always use 'Ad-Hoc'
            const effectiveRunDay = tankMovementSourceRunDay !== null ? tankMovementSourceRunDay : 'Ad-Hoc';
            
            const movement = {
                id: Date.now(),
                customerId: selectedTankMovementCustomer.id,
                customerName: selectedTankMovementCustomer.name,
                runDay: effectiveRunDay,
                date: workDate,
                timestamp: nowUTC.toISOString(),
                movementType: movementType,
                tankNoPlaced: tankNoPlaced,
                tankNoPulled: tankNoPulled,
                carbsolve: carbsolve,
                reason: reason,
                sourceRunDay: tankMovementSourceRunDay
            };
            
            const success = await db.saveTankMovement(movement);
            if (success) {
                db.tankMovements.push(movement);
                hideTankMovementModal();
                showToast('Tank movement saved!', 'success');
                renderRunDays();
            }
        }

        // Calendar Functions
        function saveCalendarUrl() {
            const url = document.getElementById('calendarUrl').value.trim();
            
            if (!url) {
                showToast('Please enter a calendar URL', 'error');
                return;
            }

            // Extract src from iframe embed code if user pasted full embed code
            let calendarSrc = url;
            if (url.includes('<iframe')) {
                const srcMatch = url.match(/src="([^"]+)"/);
                if (srcMatch) {
                    calendarSrc = srcMatch[1];
                }
            }

            db.calendarUrl = calendarSrc;
            db.save();
            loadCalendar();
            showToast('Calendar saved successfully!', 'success');
        }

        function loadCalendar() {
            if (db.calendarUrl) {
                document.getElementById('calendarUrl').value = db.calendarUrl;
                document.getElementById('calendarFrame').src = db.calendarUrl;
                document.getElementById('calendarContainer').style.display = 'block';
            }
        }
    </script>
</body>
</html>